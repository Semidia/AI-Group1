# 项目必读说明

> **重要**：先阅读 `读必读说明前必读.md`。

## 快速开始（精简版）

1) 首次使用  
```powershell
# 安装 Node.js >= 18（推荐安装 Docker）
# 在项目根目录双击 run-dev.bat
# 等待启动完成 → 打开 http://localhost:5173
```

2) 日常开发  
```powershell
# 双击 run-dev.bat 启动前后端
# 开发 & 自测
# 需要时运行测试脚本，更新进度文档
```

3) 运行测试  
```powershell
cd "rebuild\test-phases\common-tests"
.\test-phase1-6.ps1
```

## 新增快捷工具
- 日志监控：`rebuild/production/backend` 下运行 `.\monitor-api-logs.ps1`（聚焦 AI / 游戏日志）。
- 房间重置：房主可调用 `POST /api/rooms/:roomId/reset-game` 清空旧对局（需 Token）。
- 推演结果入口：推演完成广播 `roundStatus=result`，玩家自动跳结果页，主持人可直接查看结果并“进入下一回合”。

---

## 文档目录

本文档包含以下内容，帮助您快速了解项目并开始开发：

- [一、run-dev.bat 一键启动器](#一run-devbat-一键启动器)
- [二、开发流程](#二开发流程)
- [三、每次开发需要更新的MD文档](#三每次开发需要更新的md文档)
- [四、环境配置要求](#四环境配置要求)
- [五、项目文件夹结构说明](#五项目文件夹结构说明)
- [六、开发规范](#六开发规范)
- [七、测试方法](#七测试方法)
- [八、常见问题](#八常见问题)

---

## 一、run-dev.bat 一键启动器

`run-dev.bat` 是项目的**一键化启动脚本**，位于项目根目录。双击运行即可自动完成所有环境配置和启动步骤。

### 功能说明

`run-dev.bat` 会自动完成以下步骤：

1. ✅ **检查 Node.js 环境** - 验证 Node.js (>= 18) 是否已安装
2. ✅ **启动 Docker 服务** - 自动启动 PostgreSQL 和 Redis 容器（如果 Docker 可用）
3. ✅ **配置后端环境** - 自动创建 `.env` 文件（如果不存在，会调用 `scripts\setup-env.ps1`）
4. ✅ **安装后端依赖** - 自动运行 `npm install`（仅在 node_modules 不存在时）
5. ✅ **数据库迁移** - 自动运行 `npm run prisma:migrate`
6. ✅ **等待数据库就绪** - 自动检测数据库连接状态（最多等待 60 秒）
7. ✅ **数据库种子数据** - 自动运行 `npm run seed` 填充测试数据
8. ✅ **安装前端依赖** - 自动运行前端 `npm install`（仅在 node_modules 不存在时）
9. ✅ **启动开发服务器** - 自动在新 PowerShell 窗口中启动后端和前端服务

### 使用方法

在项目根目录下，双击运行 `run-dev.bat` 即可。

**启动后访问地址：**
- 后端：http://localhost:3000
- 前端：http://localhost:5173

**默认测试账号：**
- 开发者账号：`developer` / `000000`
- 测试用户1：`testuser1` / `Test1234!`
- 测试用户2：`testuser2` / `Test1234!`
- 测试用户3：`testuser3` / `Test1234!`
- 演示玩家：`demo_player` / `demo123`
- 开发者代码：`wskfz`（用于管理面板）

> **注意**：`run-dev.bat` 会打开两个新的 PowerShell 窗口分别运行后端和前端服务，请保持这些窗口运行。关闭窗口会停止对应的服务。

---

## 二、开发流程

我们应该采取的开发流程如下：

### 标准开发流程（7步）

1. **开发第X阶段需求**
   - 根据 `rebuild\requirements\开发流程指南.md` 中的阶段规划进行开发
   - 参考 `rebuild\requirements\游戏前端需求文档.md` 和 `rebuild\requirements\游戏后端需求文档.md`
   - 确保前后端功能匹配（参考 `rebuild\requirements\前后端功能匹配检查报告.md`）

2. **开辟文件夹《X阶段测试》**
   - 在 `rebuild\test-phases\` 目录下创建新的测试文件夹，例如 `phaseX-tests\`
   - 完成该阶段的阶段性测试脚本（PowerShell 脚本，如 `test-phaseX.ps1`）
   - 测试脚本应覆盖该阶段的所有核心功能

3. **更新与勾选已完成的开发流程进度**
   - 更新 `rebuild\production\开发进度.md`，勾选已完成的任务项
   - 更新 `rebuild\requirements\开发流程指南.md`，标记阶段完成状态
   - 记录测试结果和验收情况

4. **打开浏览器进入游戏，查看效果**
   - 使用 `run-dev.bat` 启动项目
   - 访问 http://localhost:5173 进行手动测试
   - 验证前端界面和交互是否符合需求
   - 检查控制台是否有错误

5. **进行1~X阶段的一次性统一测试**
   - 运行 `rebuild\test-phases\common-tests\test-phase1-X.ps1` 联合测试脚本
   - 确保所有已完成的阶段都能正常工作
   - 记录测试结果，如有问题及时修复

6. **把刚才建立的《X阶段测试》，改为《已完成X阶段测试》**
   - 将测试文件夹重命名，例如 `phaseX-tests\` → `completed-phaseX-tests\`（或保持原结构，在文档中标记为已完成）
   - 更新测试脚本的注释，说明该阶段已完成验收

7. **其他中间的想法和发现，开发并测试后才算实现**
   - 任何新的想法或发现的功能，必须先开发并测试通过
   - 实现后必须同步更新以下文档：
     - `rebuild\requirements\游戏前端需求文档.md` - 更新前端需求
     - `rebuild\requirements\游戏后端需求文档.md` - 更新后端需求
     - `rebuild\requirements\开发流程指南.md` - 更新开发流程
   - 确保文档与代码实现保持一致

### 关于未完成的任务项

在查看 `rebuild\production\开发进度.md` 和 `rebuild\requirements\开发流程指南.md` 时，您会发现有一些任务项没有打钩（未完成）。

**这是正常现象，原因如下：**

1. **AI 建议暂缓开发**
   - 在开发过程中，AI 可能会建议某些功能先不开发
   - 这些功能通常是非核心功能，或者需要等整体架构稳定后再实现
   - 例如：单元测试、性能优化、可选功能等

2. **等整体开发完成后再精细调整**
   - 这些未完成的任务项可以在整体开发完成后统一处理
   - 此时项目架构已稳定，更适合进行精细调整和优化

3. **后续阶段也可能遇到类似情况**
   - 在开发第七阶段、第八阶段等后续阶段时，也可能遇到 AI 建议先不开发的地方
   - 请遵循 AI 的建议，优先完成核心功能，非核心功能可以延后

**建议：**
- 不要因为看到未完成的任务项而感到困惑
- 专注于完成当前阶段的核心功能
- 未完成的任务项可以在项目整体完成后统一处理

---

## 三、每次开发需要更新的MD文档

在完成每个阶段的开发后，必须及时更新以下文档，确保文档与代码实现保持同步。

### 必须更新的文档

#### 1. 开发进度文档

**文件路径**：`rebuild\production\开发进度.md`

**更新内容**：
- 勾选已完成的任务项（使用 `[x]` 标记）
- 更新阶段完成状态
- 记录完成时间和验收情况
- 添加遇到的问题和解决方案

**更新时机**：每个任务完成后立即更新

#### 2. 开发流程指南

**文件路径**：`rebuild\requirements\开发流程指南.md`

**更新内容**：
- 标记阶段完成状态（在阶段标题后添加 ✅ 或完成标记）
- 更新各子任务的完成情况
- 记录测试结果和验收情况
- 更新"当前状态"说明

**更新时机**：每个阶段完成后更新

#### 3. 前端需求文档

**文件路径**：`rebuild\requirements\游戏前端需求文档.md`

**更新内容**：
- 更新已实现的功能描述
- 添加新功能的详细说明
- 更新UI/UX设计说明
- 记录功能变更和扩展

**更新时机**：前端功能开发完成后更新

#### 4. 后端需求文档

**文件路径**：`rebuild\requirements\游戏后端需求文档.md`

**更新内容**：
- 更新已实现的API接口说明
- 添加新接口的详细文档（路径、参数、返回值）
- 更新数据库结构说明
- 记录接口变更和扩展

**更新时机**：后端功能开发完成后更新

#### 5. 前后端功能匹配检查报告

**文件路径**：`rebuild\requirements\前后端功能匹配检查报告.md`

**更新内容**：
- 检查前后端功能是否匹配
- 更新API对接情况
- 记录不匹配的问题和解决方案
- 确保前后端接口契约一致

**更新时机**：前后端联调完成后更新

### 可选更新的文档

#### 6. 测试使用说明

**文件路径**：`rebuild\test-phases\common-tests\使用说明.md`

**更新内容**：
- 添加新阶段的测试说明
- 更新测试流程说明
- 记录测试中的问题和解决方案

**更新时机**：测试脚本完成后更新

#### 7. 环境配置指南

**文件路径**：`rebuild\production\backend\环境配置指南.md`

**更新内容**：
- 如果新增了环境变量，需要更新配置说明
- 如果Docker配置有变更，需要更新相关说明
- 添加新的常见问题和解决方案

**更新时机**：环境配置有变更时更新

### 文档更新检查清单

在提交代码前，请确认：

- [ ] `rebuild\production\开发进度.md` - 已勾选完成的任务
- [ ] `rebuild\requirements\开发流程指南.md` - 已标记阶段完成状态
- [ ] `rebuild\requirements\游戏前端需求文档.md` - 已更新前端功能说明
- [ ] `rebuild\requirements\游戏后端需求文档.md` - 已更新后端功能说明
- [ ] `rebuild\requirements\前后端功能匹配检查报告.md` - 已检查功能匹配
- [ ] 所有文档中的路径和引用是否正确
- [ ] 文档中的代码示例是否与实际代码一致

### 文档更新原则

1. **及时性**：功能完成后立即更新文档，不要积累
2. **准确性**：确保文档内容与代码实现完全一致
3. **完整性**：不要遗漏任何需要更新的文档
4. **清晰性**：文档描述要清晰易懂，便于后续维护

---

## 四、环境配置要求

### 必需软件

1. **Node.js >= 18**
   - 下载地址：https://nodejs.org/
   - 验证安装：`node -v`

2. **Docker & Docker Compose**
   - 下载地址：https://www.docker.com/
   - 用于运行 PostgreSQL 和 Redis 容器
   - 验证安装：`docker --version` 和 `docker compose version`

3. **npm 或 yarn**
   - Node.js 自带 npm，无需单独安装
   - 验证安装：`npm -v`

### Docker 服务配置

项目使用 Docker Compose 管理数据库服务，配置文件位于 `rebuild\production\backend\docker-compose.yml`。

**包含的服务：**
- **PostgreSQL** (端口 5432)
  - 数据库名：`game_db`
  - 用户名：`game_user`
  - 密码：`game_password`
- **Redis** (端口 6379)
  - 用于缓存和会话管理

### 环境变量配置

后端环境变量文件：`rebuild\production\backend\.env`

如果 `.env` 文件不存在，`run-dev.bat` 会自动调用 `scripts\setup-env.ps1` 创建。

**主要配置项：**
- `DATABASE_URL` - PostgreSQL 数据库连接字符串
- `REDIS_URL` - Redis 连接字符串
- `PORT` - 后端服务端口（默认 3000）
- `JWT_SECRET` - JWT 密钥
- `FRONTEND_URL` - 前端地址（默认 http://localhost:5173）

详细配置说明请参考：`rebuild\production\backend\环境配置指南.md`

### 手动配置（如果一键化启动失败）

如果 `run-dev.bat` 启动失败，请参考 `rebuild\production\backend\环境配置指南.md` 进行手动配置。

---

## 五、项目文件夹结构说明

### 根目录

- `run-dev.bat` / `run-dev.ps1` - 一键启动脚本
- `必读说明.md` - 本文档

### rebuild\ 目录

项目主要代码和文档都在 `rebuild\` 目录下。

#### rebuild\production\ - 生产环境代码

**backend\** - 后端代码
- `src\` - 源代码目录
  - `routes\` - API 路由（auth.ts, rooms.ts, game.ts, user.ts, admin.ts 等）
  - `socket\` - WebSocket 处理器（roomHandlers.ts, gameHandler.ts, messageHandler.ts 等）
  - `services\` - 业务逻辑服务（roomStateService.ts 等）
  - `middleware\` - 中间件（auth.ts, errorHandler.ts, rateLimiter.ts）
  - `utils\` - 工具函数（db.ts, logger.ts, redis.ts）
  - `server.ts` - 服务器入口文件
- `prisma\` - 数据库 Schema 和迁移文件
- `scripts\` - 工具脚本（check-db.ts, seed.ts, setup-env.ps1 等）
- `docker-compose.yml` - Docker 服务配置
- `环境配置指南.md` - 环境配置说明

**frontend\** - 前端代码
- `src\` - 源代码目录
  - `pages\` - 页面组件（Login.tsx, Register.tsx, Rooms.tsx, WaitingRoom.tsx, GameSession.tsx 等）
  - `components\` - 通用组件（RoomCard.tsx, ProtectedRoute.tsx 等）
  - `services\` - API 服务（api.ts, auth.ts, rooms.ts, game.ts, websocket.ts 等）
  - `hooks\` - React Hooks（useSocket.ts, useMessageRouter.ts）
  - `stores\` - 状态管理（authStore.ts）
- `vite.config.ts` - Vite 构建配置

**nginx\** - Nginx 生产环境配置

#### rebuild\test-phases\ - 测试脚本目录

- `common-tests\` - 联合测试脚本
  - `test-phase1-2.ps1` - 阶段1-2联合测试
  - `test-phase1-3.ps1` - 阶段1-3联合测试
  - `test-phase1-4.ps1` - 阶段1-4联合测试
  - `test-phase1-5.ps1` - 阶段1-5联合测试
  - `test-phase1-6.ps1` - 阶段1-6联合测试
  - `使用说明.md` - 测试使用说明

- `phaseX-tests\` - 各阶段独立测试脚本
  - 每个阶段有独立的测试文件夹和测试脚本
  - 例如：`phase1-tests\test-phase1.ps1`

#### rebuild\requirements\ - 需求文档目录

- `开发流程指南.md` - 完整的开发流程和阶段规划
- `游戏前端需求文档.md` - 前端功能需求
- `游戏后端需求文档.md` - 后端功能需求
- `前后端功能匹配检查报告.md` - 前后端功能匹配检查
- `游戏界面信息展示说明.md` - UI 展示说明

#### rebuild\docker-deployment\ - Docker 部署文档

- `DOCKER部署指南.md` - Docker 部署说明
- `Docker配置说明.md` - Docker 配置说明

#### rebuild\reference\ - 参考文件

- `env.prod.example` - 生产环境变量示例

#### rebuild\agent-reports\ - 智能体分析报告

- `智能体设计与分析.md` - AI 智能体相关分析

---

## 六、开发规范

### 代码规范

1. **禁止使用 Emoji**
   - 代码中（包括注释）不要使用任何 Emoji 表情符号
   - 保持代码的专业性和可读性

2. **尽量使用英文**
   - 变量名、函数名、类名、文件名等必须使用英文
   - 代码注释尽量使用英文
   - 数据库表名、字段名使用英文
   - API 路径和参数名使用英文

3. **中文使用场景**
   - **前端 UI 文本**：用户界面显示的文本可以使用中文
   - **前端提示信息**：Toast、Alert 等提示信息可以使用中文
   - **文档**：Markdown 文档可以使用中文
   - **测试脚本注释**：测试脚本中的注释可以使用中文

4. **命名规范**
   - 使用驼峰命名法（camelCase）或帕斯卡命名法（PascalCase）
   - 常量使用大写下划线分隔（UPPER_SNAKE_CASE）
   - 文件名使用小写字母和连字符（kebab-case）或驼峰命名

5. **代码格式**
   - 使用 ESLint 和 Prettier 保持代码格式一致
   - 提交代码前运行 `npm run lint` 检查格式

### 文件组织规范

**重要原则：**

1. **一个功能对应一个文件**
   - 不要将一个功能拆分成很多个小文件
   - 保持文件结构简单清晰，便于理解和维护
   - 例如：房间相关功能放在 `rooms.ts`，游戏相关功能放在 `game.ts`

2. **前后端文件名对应**
   - 前端和后端的文件名要保持对应关系，方便识别
   - 例如：
     - 后端：`routes\rooms.ts` → 前端：`services\rooms.ts`
     - 后端：`routes\game.ts` → 前端：`services\game.ts`
   - 这样即使 AI 看不懂，开发者自己也能快速找到对应的文件并指给 AI 修改

3. **每次只让 AI 修改一个文件**
   - 使用 AI 辅助开发时，每次只让 AI 修改一个文件
   - 这样可以：
     - 避免 AI 混淆多个文件的上下文
     - 更好地控制修改范围
     - 便于代码审查和回滚
   - 如果需要修改多个文件，请分多次进行，每次明确指定要修改的文件

**文件命名示例：**

```
后端：
- routes\auth.ts          → 前端：services\auth.ts
- routes\rooms.ts         → 前端：services\rooms.ts
- routes\game.ts           → 前端：services\game.ts
- socket\roomHandlers.ts   → 前端：hooks\useSocket.ts (WebSocket相关)
```

### 提交规范

- 提交信息使用英文，清晰描述改动内容
- 每个功能开发完成后及时提交，不要积累大量未提交的改动

---

## 七、测试方法

### 自动化测试

#### 1. 单阶段测试

进入对应阶段的测试目录，运行测试脚本：

```powershell
cd "rebuild\test-phases\phaseX-tests"
.\test-phaseX.ps1
```

#### 2. 联合测试（推荐）

运行联合测试脚本，测试多个阶段的集成：

```powershell
cd "rebuild\test-phases\common-tests"
.\test-phase1-X.ps1  # X 为要测试到的最高阶段
```

**可用的联合测试脚本：**
- `test-phase1-2.ps1` - 测试阶段1和2
- `test-phase1-3.ps1` - 测试阶段1、2和3
- `test-phase1-4.ps1` - 测试阶段1-4
- `test-phase1-5.ps1` - 测试阶段1-5
- `test-phase1-6.ps1` - 测试阶段1-6

#### 3. 测试流程

1. **启动服务**
   - 使用 `run-dev.bat` 启动前后端服务
   - 或手动启动（参考 `rebuild\production\启动说明.md`）

2. **运行测试脚本**
   - 在 PowerShell 中运行对应的测试脚本
   - 测试脚本会自动验证各个功能点

3. **查看测试结果**
   - 测试通过会显示 ✅ 标记
   - 测试失败会显示 ✗ 标记和错误信息
   - 根据错误信息进行修复

4. **测试报错排查（重要）**
   - **如果测试报错，一定要同时查看前端和后端的终端输出**
   - `run-dev.bat` 会打开两个 PowerShell 窗口：
     - 一个运行后端服务（显示后端日志）
     - 一个运行前端服务（显示前端日志）
   - 测试失败时，请检查：
     - 后端终端是否有错误信息（红色错误、异常堆栈等）
     - 前端终端是否有错误信息（编译错误、构建失败等）
     - 浏览器控制台是否有错误（F12 打开开发者工具）
   - **同时查看前后端终端可以更快定位问题**：
     - 后端错误：通常是 API 接口问题、数据库连接问题、业务逻辑错误
     - 前端错误：通常是组件渲染问题、API 调用问题、状态管理问题
   - 建议：测试时保持前后端终端窗口可见，方便实时查看错误信息

### 手动测试

#### 1. 功能测试

- 访问 http://localhost:5173 进行界面测试
- 使用测试账号登录，测试各项功能
- 检查浏览器控制台是否有错误

#### 2. API 测试

- 使用 Postman 或类似工具测试后端 API
- 访问 http://localhost:3000/health 检查后端健康状态
- 查看后端日志了解请求处理情况

#### 3. WebSocket 测试

- 打开多个浏览器窗口，测试实时通信功能
- 检查 WebSocket 连接状态
- 测试断线重连功能

### 测试检查清单

在完成每个阶段开发后，请检查：

- [ ] 运行对应阶段的测试脚本，所有测试通过
- [ ] 运行联合测试脚本，确保不影响之前的功能
- [ ] 手动测试前端界面，功能正常
- [ ] 检查浏览器控制台，无错误信息
- [ ] 检查后端日志，无异常错误
- [ ] 测试数据库操作，数据正确保存和读取
- [ ] 测试 WebSocket 连接，实时通信正常

### 测试文档

详细的测试说明请参考：
- `rebuild\test-phases\common-tests\使用说明.md` - 联合测试使用说明
- `rebuild\test-phases\phaseX-tests\README.md` - 各阶段测试说明

---

## 八、常见问题

### 启动问题

**Q: run-dev.bat 启动失败怎么办？**

A: 请参考 `rebuild\production\backend\环境配置指南.md` 进行手动配置和故障排查。

**Q: Docker 容器启动失败？**

A: 检查 Docker 是否正常运行，端口是否被占用。可以尝试：
```powershell
docker ps
docker-compose down
docker-compose up -d
```

### 开发问题

**Q: 如何查看开发进度？**

A: 查看 `rebuild\production\开发进度.md` 了解各阶段的完成情况。

**Q: 如何了解需求？**

A: 查看 `rebuild\requirements\` 目录下的需求文档。

**Q: 前后端如何对接？**

A: 参考 `rebuild\requirements\前后端功能匹配检查报告.md` 确保功能匹配。

---

**文档版本**：v1.0  
**最后更新**：2024年12月23日
**维护者**：开发团队

