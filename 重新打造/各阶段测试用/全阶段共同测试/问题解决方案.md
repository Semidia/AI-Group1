# 前三阶段联合测试 - 问题解决方案（数据库为例）

## 问题诊断结果

✅ **已创建 `.env` 文件** - 环境变量配置已完成

⚠️ **Docker Desktop 未运行** - 需要启动 Docker 或使用本地 PostgreSQL

## 解决方案（二选一）

### 方案1: 使用 Docker（推荐）

#### 步骤1: 启动 Docker Desktop
1. 打开 Docker Desktop 应用程序
2. 等待 Docker 完全启动（状态栏显示 "Docker Desktop is running"）

#### 步骤2: 启动数据库服务
```powershell
cd "重新打造/正式搭建/backend"
docker-compose up -d postgres redis
```

#### 步骤3: 验证容器运行状态
```powershell
docker ps
```
应该看到 `game-postgres` 和 `game-redis` 容器在运行。

#### 步骤4: 运行数据库迁移
```powershell
npm run prisma:migrate
```

#### 步骤5: 验证数据库连接
```powershell
npm run check:db
```

### 方案2: 使用本地 PostgreSQL

如果你不想使用 Docker，可以使用本地安装的 PostgreSQL：

#### 步骤1: 修改 .env 文件

编辑 `backend/.env` 文件，修改 `DATABASE_URL`：

```env
DATABASE_URL="postgresql://你的用户名:你的密码@localhost:5432/数据库名?schema=public"
```

例如：
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/game_db?schema=public"
```

#### 步骤2: 创建数据库

连接到 PostgreSQL 并创建数据库：

```powershell
# 如果使用 psql 命令行工具
psql -U postgres
CREATE DATABASE game_db;
\q
```

或者使用 pgAdmin 等图形工具创建数据库。

#### 步骤3: 运行数据库迁移
```powershell
cd "重新打造/正式搭建/backend"
npm run prisma:migrate
```

#### 步骤4: 验证数据库连接
```powershell
npm run check:db
```

## 完成后的验证步骤

### 1. 检查环境配置
```powershell
cd "重新打造/正式搭建/backend"
npm run check:db
```

预期输出：
```
✓ DATABASE_URL 已设置
✓ 数据库连接成功
✓ 找到 X 个表
```

### 2. 重新运行连续测试
```powershell
cd "重新打造/各阶段测试用/全阶段共同测试"
.\test-phase1-3.ps1
```

预期输出：
```
✓ 数据库连接正常
✓ Redis连接正常（或警告，因为可选）
```

## 当前状态

- ✅ `.env` 文件已创建
- ✅ 环境变量已配置
- ⚠️ 需要启动 Docker Desktop 或配置本地 PostgreSQL
- ⏳ 等待数据库服务启动后运行迁移

## 快速命令参考

```powershell
# 进入后端目录
cd "重新打造/正式搭建/backend"

# 启动 Docker 服务（如果使用 Docker）
docker-compose up -d postgres redis

# 运行数据库迁移
npm run prisma:migrate

# 验证配置
npm run check:db

# 运行前三阶段联合测试
cd "../../各阶段测试用/全阶段共同测试"
.\test-phase1-3.ps1
```

## 故障排查

### 如果 Docker 启动失败
- 确保 Docker Desktop 已安装并运行
- 检查 Docker Desktop 状态：任务栏图标应为绿色
- 尝试重启 Docker Desktop

### 如果数据库迁移失败
- 检查数据库服务是否运行
- 检查 `.env` 文件中的 `DATABASE_URL` 是否正确
- 运行 `npm run check:db` 查看详细错误信息

### 如果连接仍然失败
- 查看后端日志（终端输出）
- 运行诊断脚本：`npm run check:db`
- 检查端口是否被占用：`netstat -an | findstr 5432`

## 下一步

完成数据库配置后，重新运行测试脚本，应该能够顺利通过第一阶段和第二阶段测试。

