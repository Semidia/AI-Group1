# 数据库连接问题诊断指南

## 问题现象

测试脚本显示：
```
✗ 数据库连接失败: Response status code does not indicate success: 500 (Internal Server Error).
```

## 快速诊断步骤

### 1. 运行数据库诊断脚本

```powershell
cd "重新打造/正式搭建/backend"
npm run check:db
```

这个脚本会检查：
- DATABASE_URL 环境变量是否设置
- 数据库连接是否成功
- 数据库表是否存在
- 基本查询是否正常

### 2. 检查常见问题

#### 问题1: DATABASE_URL 未设置

**症状**: 诊断脚本显示 `✗ DATABASE_URL 未设置`

**解决方案**:
1. 在 `backend` 目录下创建 `.env` 文件（如果不存在）
2. 添加数据库连接字符串：
```env
DATABASE_URL="postgresql://用户名:密码@localhost:5432/数据库名?schema=public"
```

**示例**:
```env
DATABASE_URL="postgresql://postgres:password@localhost:5432/game_db?schema=public"
```

#### 问题2: PostgreSQL 服务未运行

**症状**: 错误代码 `P1001` - 无法连接到数据库服务器

**解决方案**:

**如果使用 Docker**:
```powershell
cd "重新打造/正式搭建/backend"
docker-compose up -d postgres
```

**如果使用本地 PostgreSQL**:
- Windows: 检查服务是否运行（服务管理器）
- Linux: `sudo systemctl status postgresql`
- Mac: `brew services list | grep postgresql`

#### 问题3: 数据库不存在

**症状**: 错误代码 `P1003` - 数据库不存在

**解决方案**:
1. 连接到 PostgreSQL:
```bash
psql -h localhost -U postgres
```

2. 创建数据库:
```sql
CREATE DATABASE game_db;
```

3. 或者修改 `.env` 中的数据库名称

#### 问题4: 数据库表不存在

**症状**: 诊断脚本显示 `⚠ 数据库中没有表`

**解决方案**:
运行数据库迁移：
```powershell
cd "重新打造/正式搭建/backend"
npm run prisma:migrate
```

#### 问题5: 认证失败

**症状**: 错误代码 `P1000` - 认证失败

**解决方案**:
1. 检查 `.env` 中的用户名和密码是否正确
2. 确认数据库用户有足够的权限
3. 如果需要，重置数据库密码

## 完整设置流程

### 使用 Docker Compose（推荐）

1. **启动数据库服务**:
```powershell
cd "重新打造/正式搭建/backend"
docker-compose up -d postgres redis
```

2. **配置 .env 文件**:
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/game_db?schema=public"
REDIS_URL="redis://localhost:6379"
```

3. **运行数据库迁移**:
```powershell
npm run prisma:migrate
```

4. **验证连接**:
```powershell
npm run check:db
```

### 使用本地 PostgreSQL

1. **安装 PostgreSQL**（如果未安装）

2. **创建数据库**:
```bash
psql -h localhost -U postgres
CREATE DATABASE game_db;
\q
```

3. **配置 .env 文件**:
```env
DATABASE_URL="postgresql://postgres:your_password@localhost:5432/game_db?schema=public"
```

4. **运行数据库迁移**:
```powershell
npm run prisma:migrate
```

5. **验证连接**:
```powershell
npm run check:db
```

## 验证步骤

完成上述步骤后，重新运行测试：

```powershell
cd "重新打造/各阶段测试用/全阶段共同测试"
.\test-phase1-3.ps1
```
```powershell
cd "重新打造/各阶段测试用/全阶段共同测试"
.\test-phase1-3.ps1
```
```powershell
cd "重新打造/各阶段测试用/全阶段共同测试"
.\test-phase1-3.ps1
```

应该看到：
```
✓ 数据库连接正常
```

## 常见错误代码参考

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| P1000 | 认证失败 | 检查用户名和密码 |
| P1001 | 无法连接到服务器 | 检查PostgreSQL服务状态 |
| P1003 | 数据库不存在 | 创建数据库或修改DATABASE_URL |
| P2021 | 表不存在 | 运行数据库迁移 |

## 获取帮助

如果问题仍然存在：

1. 查看后端日志（终端输出）
2. 运行诊断脚本：`npm run check:db`
3. 检查 `.env` 文件配置
4. 确认 PostgreSQL 服务状态

