# 前六阶段联合测试（Phase 1-6）

本目录用于运行前六个阶段的自动化验收：基础搭建、用户认证、房间系统基础、WebSocket 最小实时子系统、主持人初始化设定、游戏核心决策流程。提供组合脚本 `test-phase1-5.ps1` 与 `test-phase1-6.ps1`，分别覆盖前五阶段与前六阶段；后者在前者基础上追加第六阶段脚本调用。

## 测试内容

### 第一阶段：项目基础搭建
1. 服务状态检查（后端、前端）
2. 数据库连接测试
3. Redis连接测试（可选）

### 第二阶段：用户认证系统
1. 用户注册
2. 用户登录
3. 获取用户信息
4. 更新用户信息
5. Token刷新
6. 忘记密码
7. 未授权访问测试

### 第三阶段：房间系统基础
1. 创建房间
2. 房间列表
3. 加入房间
4. 离开房间

## 使用方法

### Windows (PowerShell) - 前1~5阶段一键测试
```powershell
cd "重新打造/各阶段测试用/全阶段共同测试"
.\test-phase1-5.ps1
```

### Windows (PowerShell) - 前1~6阶段一键测试
```powershell
cd "重新打造/各阶段测试用/全阶段共同测试"
.\test-phase1-6.ps1
```

> 如仅需阶段1/2，可运行 `.\test-phase1-2.ps1`；如需阶段1~3，可运行 `.\test-phase1-3.ps1`；如单独测试第四阶段，可进入 `../已完成4阶段测试` 运行 `.\test-phase4.ps1`；如单独测试第五阶段，可进入 `../已完成5阶段测试` 运行 `.\test-phase5.ps1`；如单独测试第六阶段，可进入 `../6阶段测试` 运行 `.\test-phase6.ps1`。

## 前置条件

### 1. 启动后端服务
```powershell
cd "重新打造/正式搭建/backend"
npm run dev
```

### 2. 启动前端服务（可选，用于手动测试）
```powershell
cd "重新打造/正式搭建/frontend"
npm run dev
```

### 3. 确保数据库已初始化
```powershell
cd "重新打造/正式搭建/backend"
npm run prisma:migrate
# 或
npx prisma migrate dev
```

### 4. 确保PostgreSQL和Redis运行中
- PostgreSQL: 默认端口 5432
- Redis: 默认端口 6379（可选）

## 测试流程

1. **第一阶段测试**
   - 检查服务状态
   - 测试数据库连接
   - 测试Redis连接（可选）

2. **第二阶段测试**
   - 如果第一阶段通过，自动开始第二阶段测试
   - 测试用户认证系统的所有功能

3. **第三阶段测试**
   - 如果前两阶段通过，自动调用第三阶段脚本
   - 测试房间创建/列表/加入/离开

4. **第四阶段测试**
   - 如果前三阶段通过，自动调用第四阶段脚本
   - 验证 WebSocket 最小实时子系统（健康检查 + 关键接口 + 手工联调提示）

5. **第五阶段测试**
   - 如果前四阶段通过，自动调用第五阶段脚本
   - 验证主持人初始化设定（API 配置、规则、玩家配置、验证、完成）

6. **第六阶段测试**
   - 如果前五阶段通过，`test-phase1-6.ps1` 会自动调用第六阶段脚本
   - 验证游戏核心决策流程（开始游戏、创建会话、提交决策、查询决策状态）

7. **测试结果**
   - 显示每个测试项的通过/失败状态
   - 如果所有测试通过，显示测试账号信息
   - 如果测试失败，显示错误信息

## 预期结果

### 成功情况
```
========================================
🎉 所有测试通过！
========================================

测试账号信息:
  用户名: testuser_xxxx
  邮箱: test_xxxx@example.com
  密码: password123
```

### 失败情况
- 任一阶段失败会中断后续阶段，并显示对应错误

## 注意事项

1. **服务启动顺序**：先启动后端，再运行测试脚本（如需观察前端界面可并行启动前端）
2. **数据库迁移**：确保已执行数据库迁移，否则测试会失败
3. **端口占用**：确保3000端口（后端）和5173端口（前端）未被占用
4. **环境变量**：确保`.env`文件配置正确
5. **已知问题**：当前已知问题均已在后端与测试脚本中修复；若有新问题，请结合 `诊断数据库连接.md` 与终端输出排查。

## 故障排查

### 后端服务未运行
```
✗ 后端服务未运行，请先启动后端服务
```
**解决方案**：启动后端服务 `cd backend && npm run dev`

### 数据库连接失败
```
✗ 数据库连接失败
```
**解决方案**：
1. 检查PostgreSQL是否运行
2. 检查`.env`文件中的`DATABASE_URL`配置
3. 执行数据库迁移：`npm run prisma:migrate`

### 注册失败
```
✗ 注册失败
```
**解决方案**：
1. 检查数据库连接
2. 检查用户表是否已创建
3. 查看后端日志获取详细错误信息

## 下一步

- 如需分阶段调试：可单独运行 `test-phase1-2.ps1`、`test-phase1-3.ps1`，或进入 `../4阶段测试` 执行 `test-phase4.ps1`，进入 `../5阶段测试` 执行 `test-phase5.ps1`。
- 建议在前端界面手工体验 Rooms / WaitingRoom 的实时刷新效果，以及主持人配置页的表单提交流程，配合脚本完成场景验证。

