# 环境配置指南

## 问题诊断

如果测试脚本显示数据库连接失败，很可能是 `.env` 文件未配置或配置不正确。

## 快速解决方案

### 步骤1: 启动数据库服务

```powershell
cd "重新打造/正式搭建/backend"
docker-compose up -d postgres redis
```

### 步骤2: 创建 .env 文件

在 `backend` 目录下创建 `.env` 文件，内容如下：

```env
# 数据库配置（根据docker-compose.yml）
DATABASE_URL="postgresql://game_user:game_password@localhost:5432/game_db?schema=public"

# Redis配置
REDIS_URL="redis://localhost:6379"

# 服务器配置
PORT=3000
NODE_ENV=development

# JWT配置（请在生产环境中修改）
JWT_SECRET="your-secret-key-change-this-in-production"
JWT_REFRESH_SECRET="your-refresh-secret-key-change-this-in-production"
JWT_EXPIRES_IN="1h"
JWT_REFRESH_EXPIRES_IN="7d"

# 前端URL
FRONTEND_URL="http://localhost:5173"

# 密码重置配置
RESET_PASSWORD_TOKEN_EXPIRES_IN="1h"

# 文件上传配置
UPLOAD_DIR="./uploads"
MAX_FILE_SIZE=5242880
```

### 步骤3: 运行数据库迁移

```powershell
npm run prisma:migrate
```

### 步骤4: 验证配置

```powershell
npm run check:db
```

应该看到：
```
✓ DATABASE_URL 已设置
✓ 数据库连接成功
✓ 找到 X 个表
```

### 步骤5: 重新运行测试

```powershell
cd "重新打造/各阶段测试用/第一阶段+第二阶段连续测试"
.\test-phase1-2.ps1
```

## 如果使用本地 PostgreSQL

如果你不使用 Docker，而是使用本地 PostgreSQL，请修改 `.env` 中的 `DATABASE_URL`：

```env
DATABASE_URL="postgresql://你的用户名:你的密码@localhost:5432/数据库名?schema=public"
```

例如：
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/game_db?schema=public"
```

## 常见问题

### 问题1: Docker 容器未运行

**检查**:
```powershell
docker ps
```

**启动**:
```powershell
docker-compose up -d
```

### 问题2: 数据库迁移失败

**检查数据库是否存在**:
```powershell
docker exec -it game-postgres psql -U game_user -d game_db
```

**如果数据库不存在，手动创建**:
```powershell
docker exec -it game-postgres psql -U game_user -c "CREATE DATABASE game_db;"
```

### 问题3: 端口被占用

如果 5432 端口被占用，可以修改 `docker-compose.yml` 中的端口映射：
```yaml
ports:
  - "5433:5432"  # 改为其他端口
```

然后修改 `.env` 中的 `DATABASE_URL` 端口号。

## 验证清单

- [ ] Docker 容器运行中 (`docker ps`)
- [ ] `.env` 文件已创建并配置正确
- [ ] 数据库迁移已执行 (`npm run prisma:migrate`)
- [ ] 诊断脚本通过 (`npm run check:db`)
- [ ] 后端服务可以正常启动

