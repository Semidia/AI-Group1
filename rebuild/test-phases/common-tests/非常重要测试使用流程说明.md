## 非常重要测试使用流程说明（精简版）

面向所有需要跑「全阶段共同测试」的同事，**按顺序做完下面几节即可完成环境准备 + 测试**。

---

## 一、一次性准备

- **1. 安装并启动 Docker Desktop**
  - 安装 **Docker Desktop for Windows**，启动后等状态为 “Docker is running”。
  - 在 PowerShell 中确认：

    ```powershell
    docker version
    docker ps
    ```

- **2. 放开 PowerShell 脚本执行策略（只需一次）**

  ```powershell
  Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
  ```

- **3. 克隆代码仓库**
  - 将仓库 clone 到本地，例如：`E:\开发\test1\AI-Group1-1`。

---

## 二、backend `.env` 配置（按当前实际环境）

> 文件路径：`重新打造/正式搭建/backend/.env`  
> 文件名必须是 `.env`（没有 `.txt` 后缀）。

使用以下内容（与你当前环境一致，可直接粘贴）：

```env
# 数据库配置
DATABASE_URL="postgresql://game_user:game_password@localhost:5432/game_db?schema=public"

# Redis配置
REDIS_URL="redis://localhost:6379"

# 服务器配置
PORT=3000
NODE_ENV=development

# JWT配置（自动生成）
JWT_SECRET="DR6IPVB7kyAZJ4hrEigO01ztp5NYGKQL"
JWT_REFRESH_SECRET="b7JNyWOf0GFiuhYxeMzcRSTmoHP8AVp3"
JWT_EXPIRES_IN="1h"
JWT_REFRESH_EXPIRES_IN="7d"

# 前端URL
FRONTEND_URL="http://localhost:5173"

# 密码重置配置
RESET_PASSWORD_TOKEN_EXPIRES_IN="1h"

# 文件上传配置
UPLOAD_DIR="./uploads"
MAX_FILE_SIZE=5242880
```

（如有管理员账号相关变量，以 `.env` 实际为准。）

---

## 三、启动基础服务（数据库 / Redis / 后端）

在 **backend 目录**中按顺序执行：

```powershell
cd "E:\开发\test1\AI-Group1-1\重新打造\正式搭建\backend"

# 1. 启动数据库和 Redis 容器（Docker 必须已启动）
docker-compose up -d postgres redis

# 2. 安装依赖（首次或依赖变更时）
npm install

# 3. 执行数据库迁移（建表）
npm run prisma:migrate

# 4. 启动后端
npm run dev
```

判断是否正常：

- 日志中看到类似：

  ```text
  Server running on port 3000
  Environment: development
  Redis connected
  ```

- **不应再出现**：
  - `Environment variable not found: DATABASE_URL`
  - `The table public.users does not exist in the current database.`

---

## 四、运行测试脚本

> 所有测试脚本目录：`重新打造/各阶段测试用/全阶段共同测试`

- **常用脚本**
  - `test-phase1-2.ps1`：阶段 1/2（基础搭建 + 认证）
  - `test-phase1-3.ps1`：阶段 1/2/3（含房间系统）
  - `test-phase1-5.ps1`：阶段 1~5（含主持人配置）
  - `test-phase1-6.ps1`：阶段 1~6 联合测试（推荐主用）

- **前置条件**
  1. Docker Desktop 运行正常（见第一节）。
  2. backend 已按第三节启动，窗口保持开着。

- **执行联合测试**

  新开一个 PowerShell 窗口：

  ```powershell
  cd "E:\开发\test1\AI-Group1-1\重新打造\各阶段测试用\全阶段共同测试"

  # 前 1~6 阶段联合测试
  .\test-phase1-6.ps1
  ```

  如只想测到阶段 5：

  ```powershell
  .\test-phase1-5.ps1
  ```

任意阶段失败时，脚本会中断并提示失败阶段号，可根据提示回查子脚本输出定位问题。

---

## 五、账号与开发者密令（用于前端管理操作）

- **默认管理员账号（后端根据环境变量创建）**
  - 用户名、邮箱、密码以 `.env` 或数据库初始化逻辑为准（常见为：admin / dev@example.com / 000000）。

- **开发者密令（前端管理面板解锁用）**
  - 密令字符串：`wskfz`
  - 典型用法：
    - 首页「在册用户」面板：输入密令 + 当前账号为开发者 → 解锁冻结/解冻/删除用户。
    - 首页「在线房间」面板：输入密令 + 当前账号为开发者 → 解锁强制关闭房间。

---

## 六、常见错误速查

- **Q1：`'Set-ExecutionPolicy' 不是内部或外部命令`**
  - 原因：在 `cmd` 下执行了 PowerShell 命令。
  - 处理：用「Windows PowerShell」执行：

    ```powershell
    Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
    ```

- **Q2：`unable to get image 'redis:7-alpine'` / 找不到 `dockerDesktopLinuxEngine`**
  - 原因：Docker Desktop 未安装或未启动。
  - 处理：安装并启动 Docker Desktop，确认：

    ```powershell
    docker version
    docker ps
    ```

    然后在 `backend` 目录重新执行：

    ```powershell
    docker-compose up -d postgres redis
    ```

- **Q3：`Environment variable not found: DATABASE_URL`**
  - 原因：`backend` 目录下没有 `.env`，或 `.env` 中缺少 `DATABASE_URL`。
  - 处理：按第二节创建/修正 `.env`，然后在 `backend` 目录执行：

    ```powershell
    npm run prisma:migrate
    npm run dev
    ```

- **Q4：`The table public.users does not exist in the current database`**
  - 原因：当前数据库还没按 `schema.prisma` 跑迁移。
  - 处理：确认 Postgres 容器已运行，在 `backend` 目录执行：

    ```powershell
    npm run prisma:migrate
    npm run dev
    ```

- **Q5：`test-phase1-6.ps1` 直接提示“阶段1/2 连续测试失败”**
  - 含义：问题出在子脚本 `test-phase1-2.ps1` 内。
  - 处理：单独运行：

    ```powershell
    cd "E:\开发\test1\AI-Group1-1\重新打造\各阶段测试用\全阶段共同测试"
    .\test-phase1-2.ps1
    ```

    查看详细错误信息，对照本节 Q2~Q4 处理。

---

## 七、给新同事的 30 秒上手版

1. 安装并启动 Docker Desktop，PowerShell 里能跑通 `docker version`、`docker ps`。
2. 在 `backend` 建好 `.env`（直接用第二节给出的内容）。
3. 在 `backend` 目录执行：

   ```powershell
   docker-compose up -d postgres redis
   npm install
   npm run prisma:migrate
   npm run dev
   ```

4. 新开 PowerShell 窗口，在 `全阶段共同测试` 目录执行：

   ```powershell
   .\test-phase1-6.ps1
   ```

5. 如果报错，按第六节“常见错误速查”对照排查。


