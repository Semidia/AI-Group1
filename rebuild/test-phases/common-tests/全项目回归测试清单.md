## 全项目回归测试清单（Host / Player / 推演 / 历史 / 荣誉墙）

> 适用场景：合并大功能分支、升级依赖、调整 AI/规则/回合逻辑后，用于快速自检“从登录到荣誉墙”的主流程是否还能跑通。

---

### 一、环境与基础健康检查

- **A1：一键启动 / 手动启动**
  - **预期**：后端 `http://localhost:3000/health` 返回 200；前端 `http://localhost:5173` 能打开登录页或首页。
- **A2：数据库与 Redis**
  - **预期**：PostgreSQL 与 Redis 容器正常运行；后端启动日志无连接失败报错。
- **A3：公共测试脚本冒烟**
  - 在 `rebuild/test-phases/common-tests` 运行 `test-all-phases.ps1` 或 `test-phase1-6.ps1`。
  - **预期**：1–6 阶段自动化用例通过（至少用户/房间/主持配置/开局流程无阻塞错误）。

---

### 二、主持人流程（Host Flow）

- **H1：登录与进入房间列表**
  - 使用主持账号登录，进入房间列表页。
  - **预期**：顶部/按钮 glow 与 click-explosion 正常工作，不影响交互。
- **H2：创建房间 & 进入等待页**
  - 创建新房间，自己自动加入并进入 `WaitingRoom`。
  - **预期**：房间列表出现新房间；等待页 WebSocket 状态显示为 LIVE。
- **H3：主持人配置（HostSetup 页面）**
  - 进入主持配置页，填写/确认：
    - 玩家数量、决策时间、总回合数（可选）。
    - AI 提供方与 Endpoint、Headers、BodyTemplate。
    - 默认规则文案应为“季度制 / Every Wall is a Door 蓝本”，非半年制；
  - 点击保存 & 验证。
  - **预期**：后端 `hostConfig` 标记 `initializationCompleted = true`，无 4xx/5xx。
- **H4：开始游戏**
  - 在等待页点击“开始游戏”。
  - **预期**：
    - 后端创建 `gameSession`，`roundStatus = decision`。
    - 所有在房间内的玩家收到 `game_started` / `game_state_update`，前端跳转到战场页面。
- **H5：审核与提交推演**
  - 主持人进入 `HostReview` / `GameState`：
    - 查看本回合所有玩家决策列表。
    - 点击“进入审核阶段”→“提交给 AI 推演”。
  - **预期**：
    - WebSocket 广播 `inference_started`、期间持续 `inference_progress`，最终 `inference_completed`。
    - `gameSession.roundStatus` 从 `review → inference → result`。
- **H6：推进下一回合 / 结束游戏**
  - 从主持工具调用“进入下一回合”。
  - **预期**：
    - `currentRound` +1，`roundStatus` 回到 `decision`。
  - 在达到配置的总回合数后，再次“下一回合”。
  - **预期**：会话状态变为 `finished`，房间状态从 playing 退出。

---

### 三、玩家流程（Player Flow）

- **P1：玩家登录与匹配**
  - 用普通玩家账号登录，进入房间列表，加入主持人房间。
  - **预期**：房间成员人数正确，玩家在等待页能看到房主昵称和房间状态。
- **P2：进入战场与基本 UI**
  - 游戏开始后自动跳转 `GameSession`：
    - 顶部显示当前 `ROUND N`、`roundStatus`、剩余时间与 LIVE/离线状态。
  - **预期**：定时器每秒刷新；超时后剩余时间变红；LIVE 状态正确。
- **P3：决策输入与提交**
  - 在中间“故事现场/决策输入”区域：
    - 在决策阶段输入文本，点击“提交本回合决策”。
    - 若存在 AI 推荐选项，点击一项填充并提交。
  - **预期**：
    - 未输入时提醒“请输入决策内容”。
    - 提交成功后，按钮 loading 短暂出现，左侧“队友进度”中本玩家行变为“已提交”。
- **P4：高级视图（金融赛博仪表盘）**
  - 点击顶部“高级视图”：
    - 左：`ResourcePanel` + `OpponentIntel`。
    - 中：`NarrativeFeed`（READING/DECIDING/RESOLVING 阶段、倒计时）。
    - 右：`ChatSystem` 接收 Narrative 片段分享。
  - **预期**：切换高级视图不影响标准视图的决策状态，能正常返回战场。
- **P5：推演结果查看**
  - 当主持人提交并完成推演后：
    - 顶部出现“查看本回合结果”按钮。
    - 点击进入 `/game/:sessionId/round/:round/inference`。
  - **预期**：
    - 核心叙事按打字机效果播放。
    - 卦象卡、财务核算中心、排行榜、本回合评估（Risk/Opportunity/Benefit）、成就解锁卡片都有数据（在 AI 正常响应时）。
- **P6：继续游戏入口**
  - 从战场页面返回房间列表。
  - 在 `Rooms` 中找到正在进行中的房间，应显示“继续游戏”按钮。
  - 点击后通过 `/game/by-room/:roomId/active-session` 跳回 `GameSession`。
  - **预期**：不会再出现“房间已开始但无法返回战场”的断链问题。

---

### 四、AI 推演与 TurnResultDTO 契约

- **T1：llm_engine 输出结构**
  - 检查 Python `NarrativeEngine.generate_turn`：
    - **预期**：输出 JSON 包含 `narrative, events, perEntityPanel, leaderboard, riskCard, opportunityCard, benefitCard, achievements, hexagram, options, ledger, branchingNarratives, nextRoundHints` 等字段，字段名与 `TurnResultDTO` 保持一致。
- **T2：Node 适配层（buildTurnResultDTO）**
  - 检查 `routes/game.ts` 中 `buildTurnResultDTO`：
    - **预期**：当 AI 已返回完整 TurnResultDTO 时，原样透传；旧结构时至少能补齐基础的 `narrative / events / perEntityPanel / leaderboard` 等字段。
- **T3：前端消费点一致性**
  - **InferenceResult 页面**：
    - 使用 `result.result.uiTurnResult` 构造 `turnResult`，缺失字段回退到本地 mock。
  - **GameSession 页面**：
    - 通过 `gameAPI.getGameState` 读取 `inferenceResult.result.uiTurnResult` 或 `gameState.uiTurnResult`。
    - 用于更新右侧排行榜与“本回合评估”卡片。
  - **预期**：以上三者字段含义保持一致，不出现字段名不匹配导致的运行时异常。

---

### 五、历史记录 & 荣誉墙（Wall of Honor）

- **W1：历史记录列表**
  - 打完至少一局完整对局（包含多回合推演与结束）。
  - 打开 `/game/history`。
  - **预期**：列表展示这局的基本信息；统计卡片中“总游戏数/已完成/进行中/平均回合数”更新正确。
- **W2：历史详情**
  - 在历史列表中点击“查看”，弹出详情。
  - **预期**：
    - 能看到回合列表，每回合有 `status` 与截断的 `narrative` 片段。
    - 游戏规则与创建/结束时间展示正确。
- **W3：荣誉墙标签**
  - 切换到“荣誉墙”标签页。
  - **预期**：
    - 在存在 `uiTurnResult.achievements` 的前提下，显示多个“杂志封面风”勋章卡片：
      - 财富类：金色边框。
      - 策略类：银灰边框。
      - 生存类：铜/铁色边框。
    - 每张卡片标注：
      - 成就名 + 简短描述。
      - 主体名称、所属房间、主持人。
      - 回合号（后续可扩展为“20XX 年 Qx/上半年/下半年”）。
      - 若存在卦象：显示卦名与吉凶（omen）。
- **W4：成就复盘跳转**
  - 在荣誉墙勋章卡片上点击“回看该回合推演”。
  - **预期**：导航到 `/game/:sessionId/round/:round/inference`，看到当时的推演文本与面板，实现从“荣誉”回到“故事现场”的闭环。

---

### 六、异常与边界场景（建议至少抽查 1–2 项）

- **E1：AI 推演失败兜底**
  - 故意配置错误的 Endpoint 或 API Key。
  - **预期**：
    - 推演阶段显示“推演失败”提示（InferenceResult 页面）。
    - `gameSession.roundStatus` 回到 `review`，主持人可以重新调整配置并再次提交。
- **E2：决策超时**
  - 将回合决策时间设置为极短（例如 1 分钟），不提交任何决策直至超时。
  - **预期**：
    - 倒计时归零，`GameSession` 中剩余时间字体变红。
    - 后端认定超时，提交接口返回错误提示。
- **E3：玩家中途断线/刷新**
  - 在决策输入中途刷新浏览器或关闭再打开。
  - **预期**：
    - 重新进入房间列表，通过“继续游戏”按钮能回到当前对局战场。
    - 已提交的决策状态在“队友进度”中保持。

---

### 七、建议执行顺序（一次完整回归）

1. **环境健康检查（A1–A3）**
2. **主持人主线（H1–H6），跑完至少 2–3 回合**
3. **玩家主线（P1–P6），至少实测 1 名玩家从进房 → 决策 → 看推演**
4. **AI 契约 & UI 联动（T1–T3）快速目检**
5. **历史 + 荣誉墙（W1–W4）**
6. **选取 1–2 个异常场景（E1–E3）做抽查**

当以上七大块全部通过时，可以认为“全项目主流程”在当前版本是畅通的。若其中任一大项失败，建议在对应阶段目录下补充/更新自动化脚本，并在本清单中标记已知风险与临时绕过方案。


