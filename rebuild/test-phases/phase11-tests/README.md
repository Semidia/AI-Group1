# 第十一阶段测试说明

## 测试范围

本测试脚本验证第十一阶段（历史记录管理）的所有核心功能：

1. **获取游戏历史列表API** - `GET /api/game/history`
2. **获取游戏历史详情API** - `GET /api/game/history/{sessionId}`
3. **删除游戏历史API** - `DELETE /api/game/history/{sessionId}`
4. **批量删除游戏历史API** - `DELETE /api/game/history/batch`
5. **获取游戏历史统计API** - `GET /api/game/history/statistics`
6. **游戏结束时自动保存历史** - 游戏结束时历史记录自动保存

## 运行测试

### 前置条件

1. 确保后端服务正在运行（`http://localhost:3000`）
2. 确保数据库已初始化并运行迁移
3. 确保 Docker 服务（PostgreSQL + Redis）正在运行

### 运行方式

在 PowerShell 中执行：

```powershell
cd "rebuild\test-phases\phase11-tests"
.\test-phase11.ps1
```

### 测试流程

1. **健康检查** - 验证后端服务可用
2. **创建测试用户** - 创建测试用户
3. **获取游戏历史列表** - 测试获取历史记录列表（支持分页和状态筛选）
4. **获取游戏历史统计** - 测试获取历史统计信息
5. **获取游戏历史详情** - 测试获取单条历史记录的详细信息
6. **删除游戏历史** - 测试删除历史记录（需要是主持人）
7. **批量删除游戏历史** - 测试批量删除功能
8. **自动保存验证** - 验证游戏结束时自动保存历史

## 注意事项

### 关于历史记录

历史记录就是 `GameSession` 本身：
- 游戏结束时，`GameSession` 的状态更新为 `finished`
- 历史记录查询返回所有用户参与过的游戏会话
- 无需额外的历史记录表，直接使用 `GameSession` 表

### 关于权限

- **查看历史**：所有参与过游戏的用户都可以查看
- **删除历史**：只有游戏的主持人可以删除

### 关于统计

统计信息包括：
- 总游戏数
- 已完成游戏数
- 进行中游戏数
- 总回合数
- 平均回合数
- 按状态统计
- 按月统计（最近6个月）

### 关于删除

删除游戏历史会：
- 删除 `GameSession` 记录（级联删除相关数据）
- 删除 Redis 中的推演结果缓存
- 删除推演任务标记

## 预期结果

所有测试步骤应该显示 `✔` 标记，表示测试通过。

如果某些步骤显示警告，这是预期的，因为：
- 如果用户没有参与过游戏，历史列表可能为空
- 如果用户不是主持人，删除操作会被拒绝（403）

## 故障排除

### 后端服务未运行

```
Error: 无法连接到 http://localhost:3000
```

**解决方案**: 确保后端服务正在运行，可以通过 `run-dev.bat` 启动。

### 历史记录为空

```
Found 0 history record(s)
```

**解决方案**: 
1. 这是正常的，如果用户没有参与过游戏
2. 可以先运行其他阶段的测试创建一些游戏会话

### 权限错误

```
Error: 403 Forbidden
```

**解决方案**: 
1. 删除操作需要用户是游戏的主持人
2. 这是预期的权限控制行为

## 相关文档

- [开发流程指南](../../requirements/开发流程指南.md) - 第十一阶段详细说明
- [API 文档](../../production/backend/src/routes/game.ts) - 后端 API 实现

