# 第二阶段测试说明

## 测试目标

测试用户认证系统的完整功能，包括：
1. 用户注册
2. 用户登录
3. 获取用户信息
4. 更新用户信息
5. 上传头像
6. 忘记密码
7. 重置密码
8. Token刷新
9. Token过期处理
10. 路由守卫

## 测试环境要求

- 后端服务器运行在 `http://localhost:3000`
- 前端服务器运行在 `http://localhost:5173`
- PostgreSQL数据库运行中
- Redis运行中（可选）

## 测试步骤

### 1. 用户注册测试

#### 1.1 正常注册
1. 访问 `http://localhost:5173/register`
2. 填写表单：
   - 用户名：`testuser1`
   - 邮箱：`test1@example.com`
   - 密码：`password123`
   - 确认密码：`password123`
3. 点击"注册"按钮
4. **预期结果**：
   - 显示"注册成功！"消息
   - 自动跳转到首页
   - Token已保存到localStorage
   - 用户信息已保存到状态

#### 1.2 用户名重复
1. 使用已存在的用户名（如：`testuser1`）注册
2. **预期结果**：显示错误消息"Username or email already exists"

#### 1.3 邮箱重复
1. 使用已存在的邮箱（如：`test1@example.com`）注册
2. **预期结果**：显示错误消息"Username or email already exists"

#### 1.4 密码太短
1. 输入密码少于6个字符
2. **预期结果**：表单验证失败，显示"密码至少6个字符！"

### 2. 用户登录测试

#### 2.1 正常登录
1. 访问 `http://localhost:5173/login`
2. 填写表单：
   - 用户名：`testuser1`（或邮箱：`test1@example.com`）
   - 密码：`password123`
3. 点击"登录"按钮
4. **预期结果**：
   - 显示"登录成功！"消息
   - 自动跳转到首页
   - Token已保存到localStorage
   - 用户信息已保存到状态

#### 2.2 错误密码
1. 输入错误的密码
2. **预期结果**：显示错误消息"Invalid username or password"

#### 2.3 不存在的用户
1. 输入不存在的用户名
2. **预期结果**：显示错误消息"Invalid username or password"

### 3. 获取用户信息测试

#### 3.1 获取当前用户信息
1. 登录后，调用 `GET /api/user/info`
2. **预期结果**：
   - 返回200状态码
   - 返回用户信息（id, username, email, nickname, avatarUrl, level, experience等）

#### 3.2 未登录访问
1. 清除Token后访问 `GET /api/user/info`
2. **预期结果**：返回401状态码，前端自动跳转到登录页

### 4. 更新用户信息测试

#### 4.1 更新昵称
1. 登录后，调用 `PUT /api/user/info`，body: `{ "nickname": "新昵称" }`
2. **预期结果**：
   - 返回200状态码
   - 返回更新后的用户信息
   - 昵称已更新

#### 4.2 更新邮箱
1. 调用 `PUT /api/user/info`，body: `{ "email": "newemail@example.com" }`
2. **预期结果**：
   - 返回200状态码
   - 邮箱已更新

#### 4.3 邮箱已被占用
1. 使用已被其他用户使用的邮箱更新
2. **预期结果**：返回错误消息"Email already taken"

### 5. 上传头像测试

#### 5.1 上传头像
1. 登录后，调用 `POST /api/user/avatar`，formData包含图片文件
2. **预期结果**：
   - 返回200状态码
   - 返回更新后的用户信息
   - avatarUrl已更新

#### 5.2 文件类型错误
1. 上传非图片文件
2. **预期结果**：返回错误消息"Only image files are allowed"

#### 5.3 文件过大
1. 上传超过2MB的图片
2. **预期结果**：返回错误消息

### 6. 忘记密码测试

#### 6.1 请求密码重置
1. 调用 `POST /api/auth/forgot-password`，body: `{ "email": "test1@example.com" }`
2. **预期结果**：
   - 返回200状态码
   - 返回成功消息（无论邮箱是否存在，防止邮箱枚举）
   - 开发环境下返回resetToken

#### 6.2 不存在的邮箱
1. 使用不存在的邮箱请求密码重置
2. **预期结果**：仍然返回成功消息（防止邮箱枚举）

### 7. 重置密码测试

#### 7.1 使用有效Token重置密码
1. 从忘记密码接口获取resetToken（开发环境）
2. 调用 `POST /api/auth/reset-password`，body: `{ "token": "...", "password": "newpassword123" }`
3. **预期结果**：
   - 返回200状态码
   - 密码已更新
   - 可以使用新密码登录

#### 7.2 使用无效Token
1. 使用无效或过期的Token重置密码
2. **预期结果**：返回错误消息"Invalid or expired reset token"

### 8. Token刷新测试

#### 8.1 刷新Token
1. 登录后，调用 `POST /api/auth/refresh`
2. **预期结果**：
   - 返回200状态码
   - 返回新的Token
   - 新Token可以正常使用

### 9. Token过期处理测试

#### 9.1 Token过期
1. 使用过期的Token访问受保护接口
2. **预期结果**：
   - 返回401状态码
   - 前端自动清除Token
   - 前端自动跳转到登录页

### 10. 路由守卫测试

#### 10.1 未登录访问受保护页面
1. 清除Token后访问受保护页面
2. **预期结果**：自动跳转到登录页

#### 10.2 登录后访问登录页
1. 已登录状态下访问 `/login` 或 `/register`
2. **预期结果**：可以访问（或重定向到首页，根据需求）

## API测试命令

### 使用curl测试

```bash
# 1. 注册
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser1","email":"test1@example.com","password":"password123"}'

# 2. 登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser1","password":"password123"}'

# 3. 获取用户信息（替换TOKEN）
curl -X GET http://localhost:3000/api/user/info \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. 更新用户信息（替换TOKEN）
curl -X PUT http://localhost:3000/api/user/info \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"新昵称"}'

# 5. 忘记密码
curl -X POST http://localhost:3000/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email":"test1@example.com"}'

# 6. 刷新Token（替换TOKEN）
curl -X POST http://localhost:3000/api/auth/refresh \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 测试检查清单

- [ ] 用户注册功能正常
- [ ] 用户登录功能正常
- [ ] 获取用户信息功能正常
- [ ] 更新用户信息功能正常
- [ ] 上传头像功能正常
- [ ] 忘记密码功能正常
- [ ] 重置密码功能正常
- [ ] Token刷新功能正常
- [ ] Token过期处理正常
- [ ] 路由守卫正常工作
- [ ] 错误处理正确
- [ ] 表单验证正确
- [ ] Token自动添加到请求头
- [ ] 401错误自动跳转登录页

## 注意事项

1. 测试前确保数据库已初始化（运行 `npm run prisma:migrate`）
2. 测试后清理测试数据（可选）
3. 注意检查Token是否正确保存和传递
4. 注意检查错误消息是否友好
5. 注意检查安全性（密码加密、Token验证等）

