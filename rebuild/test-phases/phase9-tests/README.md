# 第九阶段测试说明

## 测试范围

本测试脚本验证第九阶段（多回合事件进度跟踪）的所有核心功能：

1. **获取活跃事件API** - `GET /api/game/{sessionId}/events/active`
2. **更新事件进度API** - `PUT /api/game/{sessionId}/events/{eventId}/progress`
3. **事件进度自动更新** - 推演后自动更新多回合事件进度
4. **事件完成判定** - 自动检测事件是否完成
5. **事件进度在AI推演中的包含** - Prompt中自动包含事件进度
6. **事件进度WebSocket推送** - 实时推送进度更新和完成通知
7. **权限验证** - 玩家可以查看，但只有主持人可以更新

## 运行测试

### 前置条件

1. 确保后端服务正在运行（`http://localhost:3000`）
2. 确保数据库已初始化并运行迁移
3. 确保 Docker 服务（PostgreSQL + Redis）正在运行

### 运行方式

在 PowerShell 中执行：

```powershell
cd "rebuild\test-phases\phase9-tests"
.\test-phase9.ps1
```

### 测试流程

1. **健康检查** - 验证后端服务可用
2. **创建测试用户** - 创建主持人用户和玩家用户
3. **创建房间** - 创建测试房间并完成主持人配置
4. **开始游戏** - 主持人开始游戏，创建会话
5. **创建多回合事件** - 测试创建多回合事件
6. **获取活跃事件** - 测试获取活跃事件列表
7. **更新事件进度** - 测试更新事件进度
8. **验证Prompt包含** - 验证事件进度在AI推演Prompt中
9. **事件完成判定** - 验证事件完成检测逻辑
10. **权限验证** - 验证玩家可以查看但无法更新

## 注意事项

### 关于事件进度

事件进度数据结构：
```json
{
  "current": 2,        // 当前进度（回合数）
  "total": 3,          // 总回合数
  "lastUpdatedRound": 1 // 上次更新的回合
}
```

### 关于事件完成

事件完成条件：
- **单回合事件**: `currentRound > event.round`
- **多回合事件**: `progress.current >= progress.total`

### 关于自动更新

推演完成后会自动更新多回合事件的进度：
- 当前进度 +1
- 更新 `lastUpdatedRound`
- 检查是否完成
- 如果完成，标记 `completedAt` 并广播通知

## 预期结果

所有测试步骤应该显示 `✔` 标记，表示测试通过。

如果某些步骤显示警告，这是预期的，因为：
- API 端点已正确实现
- 当游戏进入 `review` 阶段时，这些 API 将正常工作
- 事件进度会自动在AI推演中包含

## 故障排除

### 后端服务未运行

```
Error: 无法连接到 http://localhost:3000
```

**解决方案**: 确保后端服务正在运行，可以通过 `run-dev.bat` 启动。

### 事件不存在

```
Error: 事件不存在
```

**解决方案**: 
1. 确保已创建事件（调用 temporary-event API）
2. 确保事件ID正确

### 权限错误

```
Error: 403 Forbidden
```

**解决方案**: 确保测试用户是房间的主持人（hostId）。

## 相关文档

- [开发流程指南](../../requirements/开发流程指南.md) - 第九阶段详细说明
- [API 文档](../../production/backend/src/routes/game.ts) - 后端 API 实现

