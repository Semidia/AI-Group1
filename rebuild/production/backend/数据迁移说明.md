# Docker 数据迁移说明

## 概述

项目已配置为将 Docker 数据存储在项目本地目录（`data/`），而不是 Docker 管理的卷中。这样可以方便地将数据随项目一起迁移。

## 数据存储位置

- **PostgreSQL 数据**: `rebuild/production/backend/data/postgres/`
- **Redis 数据**: `rebuild/production/backend/data/redis/`

## 首次迁移（如果已有 Docker 卷数据）

如果你之前使用过 Docker 卷存储数据，需要先迁移：

### 步骤 1: 停止容器

```powershell
cd rebuild/production/backend
docker-compose down
```

### 步骤 2: 运行迁移脚本

```powershell
pwsh scripts/migrate-docker-data.ps1
```

脚本会自动：
- 检查 Docker 卷是否存在
- 将数据从 Docker 卷复制到本地目录
- 创建必要的数据目录

### 步骤 3: 启动容器

```powershell
docker-compose up -d
```

### 步骤 4: 验证数据

```powershell
npm run check:db
```

## 新项目设置

如果是全新项目，直接启动即可：

```powershell
cd rebuild/production/backend
docker-compose up -d
```

数据目录会自动创建。

## 数据备份

### 备份数据

```powershell
# 停止容器
docker-compose down

# 备份 PostgreSQL 数据
Compress-Archive -Path data/postgres -DestinationPath backup/postgres_backup.zip

# 备份 Redis 数据
Compress-Archive -Path data/redis -DestinationPath backup/redis_backup.zip
```

### 恢复数据

```powershell
# 停止容器
docker-compose down

# 恢复 PostgreSQL 数据
Expand-Archive -Path backup/postgres_backup.zip -DestinationPath data/

# 恢复 Redis 数据
Expand-Archive -Path backup/redis_backup.zip -DestinationPath data/

# 启动容器
docker-compose up -d
```

## 注意事项

1. **数据目录已添加到 .gitignore**: 数据文件不会被提交到 Git，但目录结构会被保留
2. **权限问题**: 如果遇到权限问题，可能需要以管理员身份运行
3. **数据迁移**: 迁移后可以删除旧的 Docker 卷（可选）：
   ```powershell
   docker volume rm backend_postgres_data backend_redis_data
   ```

## 故障排除

### 问题：容器启动失败，提示权限错误

**解决方案**: 确保数据目录有正确的权限，或者删除数据目录让 Docker 重新创建：

```powershell
Remove-Item -Recurse -Force data/postgres
Remove-Item -Recurse -Force data/redis
docker-compose up -d
```

### 问题：迁移后数据丢失

**解决方案**: 
1. 检查旧的 Docker 卷是否还存在：`docker volume ls`
2. 如果卷还在，可以重新运行迁移脚本
3. 或者手动从卷中恢复数据

### 问题：数据目录占用空间过大

**解决方案**: 数据目录可能包含大量日志或临时文件，可以定期清理：

```powershell
# 注意：这会删除所有数据，请谨慎操作
docker-compose down
Remove-Item -Recurse -Force data/*
docker-compose up -d
# 然后重新运行迁移和 seed
npm run prisma:migrate
npm run seed
```

