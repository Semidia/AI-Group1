# 环境配置指南

> **提示**：项目提供了 `run-dev.bat` 一键化启动脚本（位于项目根目录），可以自动完成所有环境配置和启动步骤。**强烈推荐使用一键化启动**。如果一键化启动失败，或需要手动配置环境，请参考本指南。

---

## 一、推荐方式：使用 run-dev.bat 一键启动

**最简单的方式**：在项目根目录双击运行 `run-dev.bat`，脚本会自动完成所有配置。

`run-dev.bat` 会自动完成：
1. ✅ 检查 Node.js 环境
2. ✅ 启动 Docker 服务（PostgreSQL + Redis）
3. ✅ 配置后端环境（自动创建 `.env` 文件）
4. ✅ 安装后端依赖
5. ✅ 运行数据库迁移
6. ✅ 等待数据库就绪
7. ✅ 填充数据库种子数据
8. ✅ 安装前端依赖
9. ✅ 启动后端和前端开发服务器

**如果一键化启动成功，您无需阅读后续内容。**

---

## 二、环境要求

在手动配置前，请确保已安装以下软件：

### 1. Node.js >= 18

- **下载地址**：https://nodejs.org/
- **验证安装**：
  ```powershell
  node -v
  ```
  应该显示版本号，例如：`v18.17.0` 或更高

### 2. Docker & Docker Compose

- **下载地址**：https://www.docker.com/
- **用途**：用于运行 PostgreSQL 和 Redis 容器
- **验证安装**：
  ```powershell
  docker --version
  docker compose version
  ```

### 3. npm（Node.js 自带）

- **验证安装**：
  ```powershell
  npm -v
  ```

---

## 三、手动配置步骤（如果一键化启动失败）

### 步骤1: 启动数据库服务

进入后端目录，启动 Docker 容器：

```powershell
cd "rebuild\production\backend"
docker-compose up -d postgres redis
```

这将启动：
- **PostgreSQL** (端口 5432)
  - 数据库名：`game_db`
  - 用户名：`game_user`
  - 密码：`game_password`
- **Redis** (端口 6379)

**验证容器是否运行**：
```powershell
docker ps
```

应该看到 `game-postgres` 和 `game-redis` 两个容器在运行。

### 步骤2: 创建 .env 文件

在 `rebuild\production\backend` 目录下创建 `.env` 文件。

**如果 `scripts\setup-env.ps1` 存在，可以运行它自动创建**：
```powershell
cd "rebuild\production\backend"
powershell -ExecutionPolicy Bypass -File "scripts\setup-env.ps1"
```

**或者手动创建 `.env` 文件**，内容如下：

```env
# 数据库配置（根据docker-compose.yml）
DATABASE_URL="postgresql://game_user:game_password@localhost:5432/game_db?schema=public"

# Redis配置
REDIS_URL="redis://localhost:6379"

# 服务器配置
PORT=3000
NODE_ENV=development

# JWT配置（请在生产环境中修改）
JWT_SECRET="your-secret-key-change-this-in-production"
JWT_REFRESH_SECRET="your-refresh-secret-key-change-this-in-production"
JWT_EXPIRES_IN="1h"
JWT_REFRESH_EXPIRES_IN="7d"

# 前端URL
FRONTEND_URL="http://localhost:5173"

# 密码重置配置
RESET_PASSWORD_TOKEN_EXPIRES_IN="1h"

# 文件上传配置
UPLOAD_DIR="./uploads"
MAX_FILE_SIZE=5242880

# 管理员账号配置（可选）
ADMIN_USERNAME="developer"
```

### 步骤3: 安装后端依赖

```powershell
cd "rebuild\production\backend"
npm install
```

### 步骤4: 运行数据库迁移

```powershell
npm run prisma:migrate
```

这会创建数据库表结构。

### 步骤5: 验证数据库配置

运行诊断脚本检查数据库连接：

```powershell
npm run check:db
```

**成功输出示例**：
```
✓ DATABASE_URL 已设置
✓ 数据库连接成功
✓ 找到 X 个表
```

### 步骤6: 填充测试数据（可选）

```powershell
npm run seed
```

这会填充一些测试账号和初始数据。

### 步骤7: 安装前端依赖

```powershell
cd "rebuild\production\frontend"
npm install
```

### 步骤8: 启动服务

**启动后端**（终端1）：
```powershell
cd "rebuild\production\backend"
npm run dev
```

**启动前端**（终端2）：
```powershell
cd "rebuild\production\frontend"
npm run dev
```

**访问地址**：
- 后端：http://localhost:3000
- 前端：http://localhost:5173

---

## 四、使用本地 PostgreSQL（不使用 Docker）

如果您不使用 Docker，而是使用本地安装的 PostgreSQL，请修改 `.env` 中的 `DATABASE_URL`：

```env
DATABASE_URL="postgresql://你的用户名:你的密码@localhost:5432/数据库名?schema=public"
```

**示例**：
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/game_db?schema=public"
```

**注意**：
- 确保 PostgreSQL 服务正在运行
- 确保数据库已创建（如果不存在，需要手动创建）
- Redis 仍然需要运行（可以使用 Docker 只运行 Redis，或本地安装 Redis）

---

## 五、常见问题排查

### 问题1: Docker 容器未运行

**症状**：数据库连接失败

**检查**：
```powershell
docker ps
```

**解决方案**：
```powershell
cd "rebuild\production\backend"
docker-compose up -d
```

如果容器启动失败，查看日志：
```powershell
docker-compose logs postgres
docker-compose logs redis
```

### 问题2: 数据库迁移失败

**症状**：运行 `npm run prisma:migrate` 时报错

**检查数据库是否存在**：
```powershell
docker exec -it game-postgres psql -U game_user -d game_db
```

**如果数据库不存在，手动创建**：
```powershell
docker exec -it game-postgres psql -U game_user -c "CREATE DATABASE game_db;"
```

**然后重新运行迁移**：
```powershell
npm run prisma:migrate
```

### 问题3: 端口被占用

**症状**：Docker 容器启动失败，提示端口被占用

**解决方案**：

1. **修改 docker-compose.yml 中的端口映射**：
   ```yaml
   ports:
     - "5433:5432"  # 改为其他端口，例如 5433
   ```

2. **修改 .env 中的 DATABASE_URL 端口号**：
   ```env
   DATABASE_URL="postgresql://game_user:game_password@localhost:5433/game_db?schema=public"
   ```

3. **重启容器**：
   ```powershell
   docker-compose down
   docker-compose up -d
   ```

### 问题4: .env 文件未找到

**症状**：后端启动时报错，提示环境变量未设置

**解决方案**：
- 确保 `.env` 文件位于 `rebuild\production\backend` 目录下
- 确保文件名是 `.env`（不是 `.env.txt` 或其他）
- 运行 `scripts\setup-env.ps1` 自动创建

### 问题5: 数据库连接超时

**症状**：`npm run check:db` 显示连接超时

**检查清单**：
- [ ] Docker 容器是否正在运行（`docker ps`）
- [ ] `.env` 文件中的 `DATABASE_URL` 是否正确
- [ ] 端口号是否正确（默认 5432）
- [ ] 防火墙是否阻止了连接

**解决方案**：
```powershell
# 重启 Docker 容器
docker-compose restart postgres

# 等待几秒后重试
npm run check:db
```

### 问题6: Prisma 客户端未生成

**症状**：运行时提示 Prisma 客户端未找到

**解决方案**：
```powershell
cd "rebuild\production\backend"
npm run prisma:generate
```

---

## 六、验证清单

完成配置后，请检查以下项目：

- [ ] **Docker 容器运行中**
  ```powershell
  docker ps
  ```
  应该看到 `game-postgres` 和 `game-redis` 容器

- [ ] **.env 文件已创建并配置正确**
  - 文件位置：`rebuild\production\backend\.env`
  - 包含所有必需的配置项

- [ ] **数据库迁移已执行**
  ```powershell
  npm run prisma:migrate
  ```
  显示 "Migration applied successfully"

- [ ] **诊断脚本通过**
  ```powershell
  npm run check:db
  ```
  显示所有检查项通过（✓）

- [ ] **后端服务可以正常启动**
  ```powershell
  npm run dev
  ```
  访问 http://localhost:3000/health 返回 `{"status":"ok",...}`

- [ ] **前端服务可以正常启动**
  ```powershell
  cd "rebuild\production\frontend"
  npm run dev
  ```
  访问 http://localhost:5173 可以看到前端页面

---

## 七、获取帮助

如果按照以上步骤仍然无法解决问题：

1. **检查后端终端输出**：查看是否有错误信息
2. **检查前端终端输出**：查看是否有编译错误
3. **检查浏览器控制台**：F12 打开开发者工具，查看是否有错误
4. **查看 Docker 日志**：
   ```powershell
   docker-compose logs postgres
   docker-compose logs redis
   ```
5. **参考项目文档**：
   - `必读说明.md` - 项目整体说明
   - `rebuild\production\启动说明.md` - 启动相关说明

---

**文档版本**：v2.0  
**最后更新**：2024年12月  
**维护者**：开发团队
