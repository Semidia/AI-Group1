# æ•°æ®åº“æ“ä½œæµç¨‹æ³³é“å›¾

## æ•°æ®åº“ï¼šPostgreSQL + Prisma ORM

---

## æ³³é“å›¾ï¼ˆMermaid Flowchart æ ¼å¼ï¼‰

```mermaid
flowchart TB
    subgraph ç”¨æˆ·["ğŸ‘¤ ç”¨æˆ·"]
        A([å¼€å§‹])
        B[å‘èµ·ä¸šåŠ¡è¯·æ±‚]
        C[ç­‰å¾…å“åº”]
        L[æŸ¥çœ‹æ“ä½œç»“æœ]
        M([ç»“æŸ])
    end

    subgraph æ™ºèƒ½ä½“å¤§è„‘["ğŸ§  æ™ºèƒ½ä½“å¤§è„‘"]
        D{è¯·æ±‚ç±»å‹<br/>åˆ¤æ–­}
        E[æ„å»ºæŸ¥è¯¢æ¡ä»¶]
        F[æ•°æ®æ ¡éªŒ]
        G{äº‹åŠ¡æ˜¯å¦<br/>éœ€è¦?}
        H[å¼€å¯äº‹åŠ¡]
        I[æ‰§è¡Œä¸šåŠ¡é€»è¾‘]
        J{æ“ä½œæ˜¯å¦<br/>æˆåŠŸ?}
        K[æäº¤/å›æ»šäº‹åŠ¡]
    end

    subgraph æ™ºèƒ½ä½“æ‰‹è„š["ğŸ¦¾ æ™ºèƒ½ä½“æ‰‹è„š"]
        D1[(Userè¡¨)]
        D2[(Roomè¡¨)]
        D3[(GameSessionè¡¨)]
        D4[(PlayerActionè¡¨)]
        D5[(TemporaryEventè¡¨)]
        D6[(Tradeè¡¨)]
        D7[(GameSaveè¡¨)]
        D8[(Taskè¡¨)]
        D9[(Strategyè¡¨)]
    end

    %% æµç¨‹è¿æ¥
    A --> B
    B --> D
    
    D -->|æŸ¥è¯¢| E
    D -->|å†™å…¥| F
    D -->|æ›´æ–°| F
    D -->|åˆ é™¤| F
    
    E --> D1
    E --> D2
    E --> D3
    
    F --> G
    
    G -->|Yes| H
    G -->|No| I
    
    H --> I
    I --> D4
    I --> D5
    I --> D6
    I --> D7
    I --> D8
    I --> D9
    
    D1 --> J
    D2 --> J
    D3 --> J
    D4 --> J
    D5 --> J
    D6 --> J
    D7 --> J
    D8 --> J
    D9 --> J
    
    J -->|Yes| K
    J -->|No| K
    
    K --> C
    C --> L
    L --> M

    %% æ ·å¼
    style A fill:#e1f5fe
    style M fill:#e1f5fe
    style D fill:#fff3e0
    style G fill:#fff3e0
    style J fill:#fff3e0
    style D1 fill:#f3e5f5
    style D2 fill:#f3e5f5
    style D3 fill:#f3e5f5
    style D4 fill:#f3e5f5
    style D5 fill:#f3e5f5
    style D6 fill:#f3e5f5
    style D7 fill:#f3e5f5
    style D8 fill:#f3e5f5
    style D9 fill:#f3e5f5
```

---

## æ•°æ®åº“è¡¨ç»“æ„

### æ ¸å¿ƒè¡¨å…³ç³»

```mermaid
erDiagram
    User ||--o{ Room : creates
    User ||--o{ RoomPlayer : joins
    Room ||--o{ RoomPlayer : contains
    Room ||--|| HostConfig : has
    Room ||--|| GameSession : has
    GameSession ||--o{ PlayerAction : contains
    GameSession ||--o{ TemporaryEvent : contains
    GameSession ||--o{ Trade : contains
    GameSession ||--o{ GameSave : contains
    GameSession ||--o{ Task : contains
    User ||--o{ Strategy : owns
    Task ||--o{ TaskProgress : tracks
```

### è¡¨æ¸…å•

| è¡¨å | ä¸­æ–‡å | ä¸»è¦å­—æ®µ | è¯´æ˜ |
|------|--------|----------|------|
| users | ç”¨æˆ·è¡¨ | id, username, password, nickname, level | ç”¨æˆ·è´¦æˆ·ä¿¡æ¯ |
| game_rooms | æˆ¿é—´è¡¨ | id, name, hostId, status, maxPlayers | æ¸¸æˆæˆ¿é—´ |
| room_players | æˆ¿é—´ç©å®¶è¡¨ | roomId, userId, role, playerIndex | æˆ¿é—´æˆå‘˜å…³ç³» |
| host_configurations | ä¸»æŒäººé…ç½®è¡¨ | roomId, apiConfig, gameRules | AIå’Œè§„åˆ™é…ç½® |
| game_sessions | æ¸¸æˆä¼šè¯è¡¨ | roomId, currentRound, roundStatus | æ¸¸æˆè¿›è¡ŒçŠ¶æ€ |
| player_actions | ç©å®¶è¡ŒåŠ¨è¡¨ | sessionId, userId, round, actionText | å†³ç­–è®°å½• |
| temporary_events | ä¸´æ—¶äº‹ä»¶è¡¨ | sessionId, eventType, effectiveRounds | å¤šå›åˆäº‹ä»¶ |
| trades | äº¤æ˜“è¡¨ | sessionId, initiatorId, targetId, resources | ç©å®¶äº¤æ˜“ |
| game_saves | æ¸¸æˆå­˜æ¡£è¡¨ | sessionId, saveData, isAutoSave | å­˜æ¡£å¿«ç…§ |
| game_tasks | ä»»åŠ¡è¡¨ | sessionId, title, requirements, rewards | æ¸¸æˆä»»åŠ¡ |
| task_progress | ä»»åŠ¡è¿›åº¦è¡¨ | taskId, userId, progress, status | ç©å®¶ä»»åŠ¡è¿›åº¦ |
| user_strategies | ç­–ç•¥è¡¨ | userId, strategyData, winRate | ç”¨æˆ·ç­–ç•¥åˆ†æ |

---

## æµç¨‹è¯´æ˜

| æ­¥éª¤ | æ³³é“ | èŠ‚ç‚¹ | è¯´æ˜ |
|------|------|------|------|
| 1 | ç”¨æˆ· | å¼€å§‹ | ç”¨æˆ·å‘èµ·æ“ä½œ |
| 2 | ç”¨æˆ· | å‘èµ·ä¸šåŠ¡è¯·æ±‚ | HTTP/WebSocketè¯·æ±‚ |
| 3 | æ™ºèƒ½ä½“å¤§è„‘ | è¯·æ±‚ç±»å‹åˆ¤æ–­ | åŒºåˆ†CRUDæ“ä½œ |
| 4 | æ™ºèƒ½ä½“å¤§è„‘ | æ„å»ºæŸ¥è¯¢æ¡ä»¶ | PrismaæŸ¥è¯¢æ„å»º |
| 5 | æ™ºèƒ½ä½“å¤§è„‘ | æ•°æ®æ ¡éªŒ | Zod SchemaéªŒè¯ |
| 6 | æ™ºèƒ½ä½“å¤§è„‘ | äº‹åŠ¡æ˜¯å¦éœ€è¦? | åˆ¤æ–­æ˜¯å¦å¤šè¡¨æ“ä½œ |
| 7 | æ™ºèƒ½ä½“å¤§è„‘ | å¼€å¯äº‹åŠ¡ | prisma.$transaction |
| 8 | æ™ºèƒ½ä½“å¤§è„‘ | æ‰§è¡Œä¸šåŠ¡é€»è¾‘ | è°ƒç”¨Prismaæ–¹æ³• |
| 9 | æ™ºèƒ½ä½“æ‰‹è„š | æ“ä½œæ•°æ®è¡¨ | æ‰§è¡ŒSQLè¯­å¥ |
| 10 | æ™ºèƒ½ä½“å¤§è„‘ | æ“ä½œæ˜¯å¦æˆåŠŸ? | æ£€æŸ¥æ‰§è¡Œç»“æœ |
| 11 | æ™ºèƒ½ä½“å¤§è„‘ | æäº¤/å›æ»šäº‹åŠ¡ | äº‹åŠ¡å¤„ç† |
| 12 | ç”¨æˆ· | ç­‰å¾…å“åº” | ç­‰å¾…APIè¿”å› |
| 13 | ç”¨æˆ· | æŸ¥çœ‹æ“ä½œç»“æœ | å±•ç¤ºæˆåŠŸ/å¤±è´¥ |
| 14 | ç”¨æˆ· | ç»“æŸ | æ“ä½œå®Œæˆ |

---

## æ ¸å¿ƒCRUDæ“ä½œ

### ç”¨æˆ·æ¨¡å—

| æ“ä½œ | API | æ•°æ®è¡¨ | Prismaæ–¹æ³• |
|------|-----|--------|------------|
| æ³¨å†Œ | POST /auth/register | users | create |
| ç™»å½• | POST /auth/login | users | findUnique + update |
| è·å–ä¿¡æ¯ | GET /user/info | users | findUnique |
| æ›´æ–°ä¿¡æ¯ | PUT /user/info | users | update |

### æˆ¿é—´æ¨¡å—

| æ“ä½œ | API | æ•°æ®è¡¨ | Prismaæ–¹æ³• |
|------|-----|--------|------------|
| åˆ›å»ºæˆ¿é—´ | POST /rooms | game_rooms | create |
| åŠ å…¥æˆ¿é—´ | POST /rooms/:id/join | room_players | create |
| ç¦»å¼€æˆ¿é—´ | POST /rooms/:id/leave | room_players | update |
| å…³é—­æˆ¿é—´ | POST /rooms/:id/close | game_rooms | update |

### æ¸¸æˆæ¨¡å—

| æ“ä½œ | API | æ•°æ®è¡¨ | Prismaæ–¹æ³• |
|------|-----|--------|------------|
| å¼€å§‹æ¸¸æˆ | POST /game/:roomId/start | game_sessions | create/update |
| æäº¤å†³ç­– | POST /game/:id/decision | player_actions | create/update |
| æ·»åŠ äº‹ä»¶ | POST /game/:id/temporary-event | temporary_events | create |
| ä¿å­˜å­˜æ¡£ | POST /game/:id/save | game_saves | create |
| è·å–çŠ¶æ€ | GET /game/:id/state | game_sessions | findUnique |

### äº¤æ˜“æ¨¡å—

| æ“ä½œ | API | æ•°æ®è¡¨ | Prismaæ–¹æ³• |
|------|-----|--------|------------|
| å‘èµ·äº¤æ˜“ | POST /trade | trades | create |
| å“åº”äº¤æ˜“ | POST /trade/:id/respond | trades | update |
| å–æ¶ˆäº¤æ˜“ | POST /trade/:id/cancel | trades | update |

---

## äº‹åŠ¡å¤„ç†åœºæ™¯

| åœºæ™¯ | æ¶‰åŠè¡¨ | äº‹åŠ¡æ“ä½œ |
|------|--------|----------|
| å¼€å§‹æ¸¸æˆ | game_sessions, room_players | åˆ›å»ºä¼šè¯ + æ›´æ–°ç©å®¶çŠ¶æ€ |
| æ¥å—äº¤æ˜“ | trades, users(èµ„æº) | æ›´æ–°äº¤æ˜“çŠ¶æ€ + è½¬ç§»èµ„æº |
| å®Œæˆä»»åŠ¡ | task_progress, users | æ›´æ–°è¿›åº¦ + å‘æ”¾å¥–åŠ± |
| å›åˆç»“ç®— | player_actions, game_sessions | ä¿å­˜ç»“æœ + æ›´æ–°å›åˆ |

---

## æ•°æ®å¯¹è±¡

| å›¾æ ‡ | æ•°æ®å¯¹è±¡ | è¯´æ˜ |
|------|----------|------|
| ğŸ‘¤ | User | ç”¨æˆ·è´¦æˆ· |
| ğŸ  | Room | æ¸¸æˆæˆ¿é—´ |
| ğŸ® | GameSession | æ¸¸æˆä¼šè¯ |
| âœ‹ | PlayerAction | ç©å®¶å†³ç­– |
| âš¡ | TemporaryEvent | ä¸´æ—¶äº‹ä»¶ |
| ğŸ’± | Trade | ç©å®¶äº¤æ˜“ |
| ğŸ’¾ | GameSave | æ¸¸æˆå­˜æ¡£ |
| ğŸ“‹ | Task | æ¸¸æˆä»»åŠ¡ |
| ğŸ“Š | Strategy | ç”¨æˆ·ç­–ç•¥ |
