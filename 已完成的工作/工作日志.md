# 项目工作日志：凡墙皆是门 (Every Wall is a Door)

**记录时间**: 2025-12-15
**项目阶段**: V2.0 后端架构升级完成 (Client-Server)
**项目阶段**: V2.1 云服务器部署方案完成 (Server Deployment)
**项目阶段**: V2.2 初始化设定与背景故事生成功能完成
**项目阶段**: V2.3 决策建议选项确认逻辑优化完成
**项目阶段**: V2.4 帮助内容模块化完成
**项目阶段**: V2.5 帮助内容自动同步功能完成
## 1. 项目概览
本项目旨在创建一个基于文字的公司经营模拟游戏。玩家扮演 CEO，与 AI 互动制定决策。
- **核心理念**: "凡墙皆是门" (Every Wall is a Door) - 危机即转机。
- **技术栈**: React (Vite) + **Python (FastAPI)** + Vanilla CSS。
- **架构**: Client-Server 前后端分离架构。

## 2. 已完成工作 (Task Log)

### A. 基础设施与架构
- [x] **V1.0 初始化**: 搭建 React + Vite 环境，配置基础依赖。
- [x] **V1.1 架构重构**: 
    - 实施“前后端分离”，建立 `前端/` 和 `后端/` 目录。
    - 将 React 项目完整迁移至 `前端` 目录。
    - 修复 `package.json` 和 `vite.config.js` 路径，验证启动成功。

### B. 视觉设计 (UI/UX)
- [x] **设计语言**: 确立赛博科幻风格，编写 `index.css` 实现玻璃拟态 (Glassmorphism)。
- [x] **组件实现**:
    - **Dashboard**: 动态进度条显示公司属性 (Cash, Morale, etc.)。
    - **Terminal**: 打字机风格的消息记录器。
    - **InputArea**: 现代化指令输入与快捷按钮。
    - **HelpModal**: 内置《玩家手册》帮助弹窗。
    - **[NEW] LandingPage**: 游戏首页，支持 **🧪 演示模式** (前端模拟) 和 **🚀 正式模式** (后端 API) 切换。
    - **Header**: 增加“← 返回首页”按钮，优化模式显示。
    - **API 配置**: 正式模式新增“本地部署”与“远程调用”通道选择，支持自定义 Key。
    - **启动脚本**: 创建 `一键启动游戏.bat`，支持双击自动运行并打开浏览器。

### D. 文档与规范
- [x] **文件说明**: 更新 `1_文件功能说明.md`，涵盖新模块与 API 逻辑。
- [x] **玩家手册**: 更新 `2_玩家手册.md`，新增游戏模式与连接通道说明。
- [x] **开发者指南**: 更新 `3_开发者指南.md`，补充双模式调试与 API 配置指南。

### C. 游戏核心逻辑
- [x] **状态管理**: 实现 `gameLogic.js` 处理现金流、士气等数值增减。
- [x] **模拟智能 (Mock AI)**: 开发 `mockAI.js`，根据公司状态动态生成选项与剧情文本。

### D. 文档交付
- [x] 完成《文件功能说明》与《游戏操作指南》。
- [x] 整合任务清单与实施计划至本日志。
- [x] 创建 `一键启动游戏.bat`。

### E. V2.0 后端开发 (Python)
- [x] **初始化**: 创建 `后端/` 基础结构 (`main.py`, `requirements.txt`)。
- [x] **框架选型**: 采用 FastAPI + Uvicorn 作为后端服务框架。
- [x] **API 开发**:
    - [x] `GET /init`: 获取游戏初始状态。
    - [x] `POST /action`: 处理玩家决策。
    - [ ] `POST /ai/generate`: 调用 LLM 生成剧情 (V2.1)。
- [x] **前后端联调**: 更新前端调用真实 API。

### F. V2.1 云服务器部署方案
- [x] **服务器评估**: 完成阿里云香港服务器配置评估。
- [x] **网络优势分析**: 确认香港节点可直接访问国际主流 API。
- [x] **部署方案制定**: 创建 `云端/云服务器现有配置的使用方案.md`，包含：
    - 国际 API 使用评估
    - 本地大模型部署可行性分析
    - 用户网络环境要求
    - 项目部署适配性
    - 最佳使用方案
- [x] **架构优化建议**: 确定作为 API 中转与业务逻辑处理服务器的最佳用途。

### G. V2.2 初始化设定与背景故事生成
- [x] **演示模式背景故事**: 在 `前端/src/engine/gameLogic.js` 中添加完整的预制背景故事，包括：
    - 公司背景介绍
    - 当前困境分析
    - 行业环境描述
    - 玩家任务说明
- [x] **初始化设定模态框**: 在 `前端/src/App.jsx` 中实现 `InitSettingsModal` 组件，允许玩家输入自定义游戏规则和 AI 行为要求
- [x] **API 配置界面优化**: 添加 "初始化设定" 按钮，支持保存和重置设定
- [x] **API 调用增强**: 修改 `前端/src/engine/api.js`，让 `initGame` 函数支持传递初始化设定
- [x] **后端支持**: 
    - 在 `后端/models.py` 中添加 `InitSettings` 模型
    - 将 `后端/main.py` 中的 `/api/init` 端点从 GET 改为 POST
    - 增强 `后端/engine.py` 中的 `MockAI` 类，支持保存和使用初始化设定
- [x] **前后端联调**: 验证正式模式下，初始化设定能正确传递给后端并用于生成背景故事

### H. V2.3 决策建议选项确认逻辑优化
- [x] **多选功能实现**: 在 `前端/src/components/InputArea/InputArea.jsx` 中实现选项多选功能，允许用户通过点击操作同时选择多个决策建议选项
- [x] **自定义输入与选项合并**: 优化界面设计，将自定义输入和选项选择合并到同一个提交流程中
- [x] **执行确认环节**: 实现统一的执行确认环节，利用界面已有的"执行"按钮，用户完成选项选择和自定义内容输入后，需点击该按钮提交所有决策信息
- [x] **交互流程优化**: 确保所有选择和输入内容在点击"执行"按钮前可修改，点击后将完整决策信息（包括所选建议和自定义内容）统一传入交互系统
- [x] **界面优化**: 确保多选状态清晰可辨，自定义输入区域易于访问，并在用户未选择任何选项且未输入自定义内容时提供适当提示
- [x] **前后端适配**: 修改 `前端/src/App.jsx` 中的处理逻辑，支持合并多个选项的效果并统一提交
- [x] **测试验证**: 确保两种模式下新的决策交互流程都能正常工作

### I. V2.4 帮助内容模块化
- [x] **提取帮助内容**: 从 `前端/src/App.jsx` 中提取帮助按钮内的文字内容
- [x] **创建独立文件**: 将提取的内容保存到 `/github小组开发库说明书/帮助按钮里的内容.md`
- [x] **创建中间文件**: 在 `前端/src/engine/helpContent.js` 中存储帮助内容，便于前端引用
- [x] **更新引用路径**: 修改 `App.jsx` 中的 `HelpModal` 组件，使用外部导入的帮助内容
- [x] **更新文档**: 更新文件功能说明，添加 `helpContent.js` 的说明

### J. V2.5 帮助内容自动同步
- [x] **创建同步脚本**: 开发 `sync-help-content.js` 脚本，支持两种模式：
    - 单次同步：`node sync-help-content.js`
    - 自动监听：`node sync-help-content.js --watch`
- [x] **优化脚本功能**: 
    - 自动将 markdown 文件转换为 JavaScript 模板字面量
    - 添加详细的日志输出和错误处理
    - 支持从任意目录运行
- [x] **更新 package.json**: 
    - 在根目录 `package.json` 中添加 `sync-help:watch` 命令
    - 在前端目录 `package.json` 中添加 `sync-help:watch` 命令
- [x] **更新文档**: 
    - 更新 `1_文件功能说明.md`，添加 V2.5 更新提示和脚本说明
    - 更新 `3_开发者指南.md`，添加自动同步功能的详细使用说明
    - 更新 `3_开发者指南.md`，添加自动同步功能的详细使用说明
    - 测试自动同步功能，验证修改 markdown 文件后 JS 文件能自动更新

### K. V2.6 后端基础设施与数据库 (Backend Basics)
- [x] **数据库接入**: 引入 `sqlalchemy` 和 SQLite，创建 `database.py` 和 `db_models.py`。
- [x] **持久化存储**: 替代全局变量，使用数据库存储 `GameSession` 和 `GameHistory`，实现重启不丢进度。
- [x] **云端连接器**: 创建 `cloud_connector.py` 和 `keep_alive_tunnel.bat`，支持连接阿里云 MongoDB。

### L. V2.7 LLM 核心引擎 (The Brain)
- [x] **OpenAI 接入**: 在 `backend/llm_engine.py` 中实现真实 LLM 调用。
- [x] **因果链逻辑 (Causal Loop)**: 
    - 实现 `process_turn` 闭环：输入(History/State) -> 处理(Filters/Calculation) -> 输出(Narrative/Options).
    - 引入“周易变量” (Random Seed) 影响剧情走向。
- [x] **逻辑链展示**: 强制 AI 输出思维链 (Chain of Thought) 和数值计算公式，并在前端展示 [逻辑链]。
- [x] **Prompt 工程**: 提炼《主持手册》为 System Prompt，确保 AI 遵守游戏规则。

### M. V2.8 双模式存储与增强 (Dual Mode)
- [x] **记忆扩展**: 将历史记录读取范围扩展至最近 30 条，消除 AI 幻觉。
- [x] **双通道模式**: 
    - 🟢 **LOCAL 模式**: 使用 `local_game_data.json`，无需联网，适合开发测试。
    - ☁️ **CLOUD 模式**: 使用 `CloudBridge` 连接远程 MongoDB (需 SSH 隧道)。
- [x] **动态切换**: 新增 `/api/toggle_mode` 接口，支持热切换存储模式。

### N. V3.0 完整链路跑通 (Milestone)
- [x] **后端中枢重构**: `main.py` 逻辑重组，支持 前端 -> 后端 -> Engine/Cloud -> 返回 的完整闭环。
- [x] **通道明确**: 明确“本地部署通道”与“远程调用通道”的区别与适用场景。

## 3. 未来展望 (Roadmap)
- [ ] **接入 LLM API (V2.1)**: 将后端 Mock AI 替换为真实的大语言模型 (如 Gemini/GPT)，实现无限剧情生成。
- [ ] **数据持久化**: 连接数据库 (SQLite/Redis) 实现存档功能。
- [ ] **丰富事件库**: 增加更多随机事件与决策分支。
- [ ] **前端 UI 升级**: 适配新的“逻辑链”显示，优化打字机效果。

---

### V3.9 团队贡献里程碑 (Team Contributions)

#### 事件进度监控系统
- [x] **系统输出优化**: 让多回合才能处理完的事件显示在系统输出内容中，并每回合更新进度。
- [x] **推演结果展示**: 事件完成后在推演中输出数据结果。

#### 互动模块与架构增强
- [x] **互动模块**: 完成了人类玩家和 AI 玩家的互动模块。
- [x] **多角色系统**: 实现了多角色玩家系统，并完成了决策流程自动化。
- [x] **数据持久化**: 实现了数据持久化，所有决策信息写入本地 JSON 文件。
- [x] **系统稳定性**: 增强了系统容错性，即使 LLM API 连接失败也能保持游戏流程。
- [x] **API 规范**: 将 API Base URL 和模型名称等所有 LLM API 配置更新为 DeepSeek 官方地址和支持的模型。
- [x] **格式修复**: 
    - 修复了核心 LLM 引擎 Prompt 中的 JSON 示例大括号转义问题。
    - 修复了数据完整性问题，确保游戏状态初始化和 `/api/action` 接口请求参数格式正确。
    - 所有核心接口 (`/api/init`, `/api/action`) 和数据流均已通过验证测试。

---

### V4.0 界面与逻辑深化优化 (UI/UX Refinements)
- [x] **侧边栏重构**:
    - 将侧边栏拆分为三个独立板块：**核心数据 (Dashboard)**、**团队成员 (TeamList)**、**事件记载 (EventLog)**。
    - 极致压缩侧边栏宽度 (260px -> 190px) 和字体大小 (0.65rem)，最大化利用屏幕空间。
    - 移除仪表盘进度条，改为纯文本紧凑列表，数据单位明确为“万”。
- [x] **顶部导航优化**:
    - 将玩家信息 (CEO, Turn, Mode) 从侧边栏移至顶部标题下方。
    - 压缩顶部高度，减少视觉干扰。
- [x] **事件日志系统**:
    - 新增 `EventLog` 组件，独立显示每回合的关键事件摘要。
    - 修复后端 API 数据流，确保 `event_summary` 正确生成并传递至前端。
- [x] **AI 逻辑增强**:
    - **成本推断**: 强制 AI 对玩家自定义指令（如“举办派对”）进行成本估算并扣除资金。
    - **叙事控制**: 严格限制剧情生成字数 (<200字) 和事件摘要字数 (<10字)，提升阅读效率。
    - **初始选项**: 游戏初始化时即生成带有成本说明的选项。
- [x] **交互修复**:
    - 修复“执行”按钮逻辑，增加 `isLoading` 状态锁定。
    - 在 AI 思考期间禁用输入区，防止重复提交，并提供即时反馈 ("AI 正在推演...").

---
*本日志自动生成，已合并《任务清单》与《实施计划》。*
