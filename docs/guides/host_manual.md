# 🛠️ 主持人操作手册

作为主持人（Host），你是游戏规则的制定者和推进者。本手册将指导你如何配置房间、接入 AI 并掌控游戏节奏。

---

## 📋 目录

1. [房间创建](#1-房间创建)
2. [主持人配置 (Host Setup)](#2-主持人配置-host-setup)
3. [游戏流程控制](#3-游戏流程控制)
4. [页面导航说明](#4-页面导航说明)
5. [故障处理](#5-故障处理)

---

## 1. 房间创建

### 1.1 启动游戏服务

1. 在项目根目录双击 `run-dev.bat` 启动服务。
2. 等待启动完成，控制台会显示：
   ```
   LAN Access URLs (for other computers):
     Frontend: http://192.168.x.x:5173
     Backend:  http://192.168.x.x:3000
   ```
3. 将 Frontend 地址分享给其他玩家。

### 1.2 创建房间

1. 登录后在游戏大厅（`/rooms`）点击 **"创建房间"**。
2. 填写基本信息：
   - **房间名称**：清晰易懂的标题。
   - **最大人数**：限制可加入的真实玩家数量（默认 4 人）。
   - **密码**（可选）：私密游戏建议设置。
3. 创建后你将自动成为 **房主（Host）** 并进入等待房间（`/rooms/:roomId/wait`）。
4. 等待其他玩家加入房间。

---

## 2. 主持人配置 (Host Setup)

在所有玩家准备好之后，你需要进入 **"主持人设定"** 页面（`/rooms/:roomId/host-setup`）完成初始化配置。这是一个三步向导式流程：

### 第一步：API 配置

这是游戏的大脑，负责调用 AI 进行推演。

**必填项**：
- **API Provider**：选择 `openai`、`deepseek` 或 `custom`。
- **Endpoint**：LLM 服务的接口地址（例如 `https://api.deepseek.com/v1/chat/completions`）。
- **Headers**：填入你的 API Key（JSON 格式，例如 `{"Authorization":"Bearer sk-..."}`）。
- **Body 模板**：配置请求结构，系统会用 `{{prompt}}` 自动替换每轮的上下文（JSON 格式）。

**示例配置（DeepSeek）**：
```json
Headers:
{
  "Content-Type": "application/json",
  "Authorization": "Bearer sk-your-api-key"
}

Body 模板:
{
  "model": "deepseek-chat",
  "messages": [
    {
      "role": "system",
      "content": "你是一个游戏推演引擎，根据玩家的决策和游戏规则，生成游戏剧情和结果。"
    },
    {
      "role": "user",
      "content": "{{prompt}}"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 2000
}
```

配置完成后点击 **"保存 API 配置"**，系统会验证配置的有效性。

### 第二步：规则配置

设置游戏的背景和规则，这会直接作为 System Prompt 的一部分发送给 AI。

- **游戏规则**：在文本框中输入游戏的背景设定和胜负规则。
  - 可以包含游戏世界观、角色设定、资源系统、胜利条件等。
  - 建议使用 Markdown 格式编写，结构清晰。

**示例规则**：
```markdown
# 末日生存：废土之王

**背景**：2050年，资源枯竭，世界陷入混乱。

**规则**：
1. 每回合提交一项决策。
2. 决策影响生命值、食物和金钱。
3. 支持玩家间交易。
4. 生命值归零则失败。
```

配置完成后点击 **"保存规则"**。

### 第三步：玩家配置

设置游戏的基本参数。

**必填项**：
- **总决策主体数**：**重要！** 等于 `人类玩家数 + AI 玩家数`。
  - 例如有 3 个真人玩家，你想加 2 个 AI 对手，此处填 5。
  - 必须等于或大于当前房间中的人类玩家数。
- **人类玩家数**：当前房间中的真实玩家数量（包括你）。
- **AI 玩家数**：AI 对手的数量（0 或更多）。
- **决策时限**：设置每回合玩家思考的时间（分钟，默认 4 分钟）。
- **超时策略**：选择 `auto_submit`（自动提交）或 `skip`（跳过）。

配置完成后点击 **"保存玩家配置"**。

### 验证与完成

1. 点击 **"标记验证通过"** 确认配置无误。
2. 点击 **"完成配置"**，此时房间状态变为 `waiting`。
3. 点击 **"开始游戏"**，游戏会话创建，所有玩家自动跳转到游戏页面。

---

## 3. 游戏流程控制（季度制，动态主体数）

游戏按 **回合制** 进行，默认 **季度一回合（Q1/Q2/Q3/Q4）**。主体数量由房间配置决定，不假定固定 ABCD。

### 🔵 决策阶段 (Decision)

- **玩家操作**：玩家在游戏会话页面（`/game/:sessionId`）提交决策文本。
- **主持人操作**：
  - 在游戏状态页面（`/game/:sessionId/state`）查看整体状态。
  - 查看玩家提交进度（已提交/未提交）。
  - 查看倒计时（如果设置了决策时限）。
- **阶段结束条件**：
  - 所有玩家已提交决策，或
  - 决策时限到达（根据超时策略处理）。
- **进入下一阶段**：主持人点击 **"开始审核"** 按钮（在游戏状态页面），游戏进入审核阶段。

### 🟡 审核阶段 (Review)

**主持人关键操作页面**：`/game/:sessionId/review`

在这个阶段，主持人拥有以下权力：

1. **查看所有玩家决策**：
   - 显示每个玩家提交的决策文本。
   - 显示决策状态（pending/submitted/reviewed）。

2. **修改玩家决策**（可选）：
   - 点击决策卡片可以编辑玩家的决策文本。
   - 如果玩家输入了违规内容或不合理的指令，你可以进行修改。
   - 修改后系统会记录修改说明。

3. **添加临时事件**：
   - 点击 **"添加临时事件"** 按钮。
   - 选择事件类型：
     - **单回合事件**：仅本回合有效。
     - **多回合事件**：指定回合数有效，需要填写有效回合数。
   - 输入事件内容和描述。
   - 事件会在 AI 推演时自动包含在 Prompt 中。

4. **添加临时规则**：
   - 点击 **"添加临时规则"** 按钮。
   - 输入规则内容。
   - 可以设置规则的有效回合数（默认为 1，即仅本回合有效）。
   - 规则会在 AI 推演时自动包含在 Prompt 中。

5. **提交给 AI 推演**：
   - 确认所有决策无误后，点击 **"提交给 AI 推演"** 按钮。
   - 游戏进入推演阶段。

### 🟢 推演阶段 (Inference)

- **系统操作**：后端调用配置好的 LLM API，进行异步推演。
- **主持人/玩家操作**：
  - 自动跳转到推演结果页面（`/game/:sessionId/round/:round/inference`）。
  - 查看推演进度（如果支持流式输出）。
  - 等待推演完成。
- **推演结果**（已对齐 TurnResultDTO）：
  - 剧情叙述（narrative，季度节奏）。
  - 每主体属性面板（perEntityPanel：现金/市占/声誉/创新/被动收支/creditRating/paletteKey）。
  - 排行榜（leaderboard）。
  - 事件（events）与遮蔽段落（redactedSegments，如有）。
  - 财务核算（ledger：被动/主动分列）。
  - 策略选项（options，含 expectedDelta）。
  - 风险/机会/效益卡（risk/opportunity/benefit）。
  - 分支叙事（branchingNarratives，可选）。
  - 下一回合提示（nextRoundHints）。
- **阶段结束**：推演完成后，游戏自动进入结果阶段。

### 🟣 结果阶段 (Result)

**页面**：`/game/:sessionId/round/:round/inference`

- **所有玩家查看**：
  - 叙事（打字机效果）。
  - 属性面板、排行榜、事件、财务核算、策略选项、风险/机会/效益。
  - 分支叙事与下一回合提示。

- **主持人操作**：
  - 查看推演结果详情。
  - 可以在推演结果页面或游戏状态页面点击 **"进入下一回合"** 按钮。
  - 点击后，游戏进入下一回合的决策阶段（回合数 +1）。

- **游戏结束**：
  - 如果达到设定的总回合数，游戏自动结束。
  - 游戏状态变为 `finished`。

---

## 4. 页面导航说明

### 主持人主要页面

1. **游戏状态页面** (`/game/:sessionId/state`)
   - **用途**：查看游戏整体状态，控制游戏流程。
   - **功能**：
     - 查看当前回合数、阶段状态。
     - 查看玩家提交进度。
     - 查看活跃事件列表。
     - 查看推演结果摘要。
     - **开始审核**（决策阶段）→ 跳转到审核页面。
     - **进入下一回合**（结果阶段）→ 进入下一回合决策阶段。

2. **主持人审核页面** (`/game/:sessionId/review`)
   - **用途**：审核玩家决策，添加临时事件/规则。
   - **功能**：
     - 查看所有玩家决策。
     - 编辑玩家决策。
     - 添加临时事件。
     - 添加临时规则。
     - **提交给 AI 推演** → 跳转到推演结果页面。

3. **推演结果页面** (`/game/:sessionId/round/:round/inference`)
   - **用途**：查看 AI 推演结果。
   - **功能**：
     - 查看推演进度（如果支持）。
     - 查看推演结果（剧情、结果、事件）。
     - 进入下一回合（主持人）。

### 页面跳转流程

```
游戏状态页面 (决策阶段)
    ↓ [开始审核]
审核页面
    ↓ [提交给 AI 推演]
推演结果页面 (推演阶段 → 结果阶段)
    ↓ [进入下一回合] (主持人)
游戏状态页面 (下一回合决策阶段)

### 高级视图：商业决策控制台
- 路径：`/game/:sessionId/decision-console`（受保护）。
- 内容：周易卦象、财务核算（被动锁定 vs 主动高亮、现金覆盖度与破产预警）、排行榜（含信用/市占/评分）、多主体对比、叙事与分支线索、风险/机会/效益、AI 策略选项+自定义输入。
- 节奏：季度制（Q1/Q2/Q3/Q4），标识符不使用 emoji，如需文案 emoji 可仅出现在文本中。
```

---

## 5. 故障处理

### 玩家无法连接

- **检查网络**：确保所有玩家在同一局域网内。
- **检查防火墙**：Windows 防火墙可能阻止连接，需要允许 Node.js 通过防火墙。
- **检查服务状态**：确认后端和前端服务都在运行。
- **手动配置**：让玩家访问"服务器配置"页面，手动输入正确的服务器 IP 和端口。

### 玩家掉线

- 系统支持重连，让玩家刷新页面重新进入房间即可。
- WebSocket 会自动重连，状态会同步。

### AI 推演报错

- **检查后端控制台日志**，查看具体错误信息。
- **常见原因**：
  - API Key 过期或无效。
  - 网络超时。
  - API 端点配置错误。
  - Body 模板格式错误。
- **解决方案**：
  - 重新进入"主持人设定"页面（`/rooms/:roomId/host-setup`）更新 API 配置。
  - 检查 API Key 是否有效。
  - 检查网络连接。

### 游戏卡死

- **检查当前阶段**：在游戏状态页面查看当前回合和阶段状态。
- **检查推演状态**：如果推演阶段卡住，检查推演结果页面是否有错误信息。
- **手动重置**：如果无法恢复，可以联系超级管理员重置房间状态（需使用后台管理权限）。

### 决策提交失败

- 检查网络连接。
- 检查是否在决策阶段（如果超时，需要等待主持人进入审核阶段）。
- 刷新页面重试。

### 无法进入下一回合

- 确保当前阶段是 **结果阶段**（result）。
- 检查是否达到总回合数（如果设置了总回合数）。
- 刷新游戏状态页面重试。

---

## 📌 注意事项

1. **配置顺序**：必须按照 API → 规则 → 玩家的顺序完成配置，不能跳步。
2. **总决策主体数**：必须等于人类玩家数 + AI 玩家数，否则游戏无法正常进行。
3. **决策时限**：建议根据游戏复杂度设置合理的时限，太短可能影响玩家体验。
4. **临时事件/规则**：多回合事件/规则会自动跟踪进度，在有效回合数内持续生效。
5. **推演结果缓存**：推演结果会在 Redis 中缓存 24 小时，期间可以随时查看。
6. **游戏存档**：可以使用游戏存档功能保存游戏进度，支持手动保存和自动保存。

---

**掌控全场，享受博弈！** 🎮
