# 🛠️ 主持人操作手册

作为主持人（Host），你是游戏规则的制定者和推进者。本手册将指导你如何配置房间、接入 AI 并掌控游戏节奏。

---

## 📋 目录

1. [房间创建](#1-房间创建)
2. [主持人配置 (Host Setup)](#2-主持人配置-host-setup)
3. [三层规则架构](#3-三层规则架构)
4. [游戏流程控制](#4-游戏流程控制)
5. [卦象与成就系统](#5-卦象与成就系统)
6. [页面导航说明](#6-页面导航说明)
7. [故障处理](#7-故障处理)

---

## 1. 房间创建

1. 登录后在游戏大厅（`/rooms`）点击 **"创建房间"**。
2. 填写基本信息：
   - **房间名称**：清晰易懂的标题。
   - **最大人数**：限制可加入的真实玩家数量（默认 4 人）。
   - **密码**（可选）：私密游戏建议设置。
3. 创建后你将自动成为 **房主（Host）** 并进入等待房间（`/rooms/:roomId/wait`）。
4. 等待其他玩家加入房间。

---

## 2. 主持人配置 (Host Setup)

在所有玩家准备好之后，进入 **"主持人设定"** 页面（`/rooms/:roomId/host-setup`）完成初始化配置。

### 第一步：AI 模型配置

这是游戏的大脑，负责调用 AI 进行推演。

**配置项说明**：

| 配置项 | 说明 |
|--------|------|
| AI 服务提供商 | 选择 DeepSeek（推荐）、OpenAI、Claude、智谱、通义千问、Moonshot 或自定义 |
| 模型 | 根据提供商自动列出可用模型，推荐 deepseek-chat |
| API Key | 从对应服务商获取的密钥，格式如 `sk-xxxxxxxx` |
| 流式输出 | 是否逐字显示 AI 响应（目前后端暂不支持，建议关闭） |

**推荐配置（DeepSeek）**：
- 提供商：DeepSeek
- 模型：deepseek-chat
- API Key：从 [DeepSeek 官网](https://platform.deepseek.com/) 获取
- 流式输出：关闭

配置完成后点击 **"保存 API 配置"**。

### 第二步：规则与玩家配置

**游戏规则**：
- 留空则使用默认的《凡墙皆是门》蓝本规则
- 可自定义游戏背景、胜负条件、特殊规则等
- 支持 Markdown 格式

**玩家配置**：

| 配置项 | 说明 |
|--------|------|
| 总决策主体数 | 游戏中参与决策的企业/角色总数（2-10） |
| 人类玩家数 | 真实玩家数量 |
| AI 玩家数 | AI 对手数量（总数 = 人类 + AI） |
| 决策时限 | 每回合思考时间（分钟） |
| 超时策略 | auto_submit（自动提交）/ skip（跳过）/ extend（延长） |

### 第三步：游戏初始化

配置初始参数后，AI 将自动生成：
- **商业背景故事**（约600字）
- **主体初始状态**（名称、资金、属性、被动收支）
- **年度卦象**（影响本年度事件风格）
- **初始决策选项**（3个可选策略）

**配置项**：
- 初始资金：每个主体的起始资金
- 游戏模式：多主体操控 / 单主角模式
- 行业主题：科技、零售、制造、金融等

### 验证与完成

1. 点击 **"标记验证通过"** 确认配置无误
2. 点击 **"完成配置"**
3. 点击 **"开始游戏"** 启动游戏会话

---

## 3. 三层规则架构

游戏采用三层规则架构，确保规则的稳定性和灵活性：

### 3.1 核心规则 (Immutable Core)

**不可违背的物理定律**，写入 AI 的 System Prompt：

- **现金流原则**：现金 < 0 判定破产
- **决策权原则**：玩家指令绝对优先，AI 不得代替玩家决策
- **回合制流程**：决策 → 审核 → 推演 → 结果
- **禁止事项**：
  - 系统不得代替玩家进行主体决策
  - 系统不得自动发起玩家行为
  - 系统不得撮合主体间合作

### 3.2 场景规则 (Default Scenario)

**本局游戏的世界观**，在游戏初始化时配置：

- 初始资金、行业背景
- 被动收支公式
- 胜利条件
- 特殊规则

### 3.3 临时规则 (Mutable/Temporary)

**随回合变化的动态规则**：

- **卦象效果**：年度起卦带来的修正（如：乾卦增加扩张收益）
- **事件效果**：突发事件带来的临时约束
- **成就奖励**：解锁成就后的永久/临时加成

**主持人可以在审核阶段添加临时事件/规则**。

---

## 4. 游戏流程控制

游戏按 **回合制** 进行，每回合代表 **半年（6个月）**。

### 🔵 决策阶段 (Decision)

- 玩家在游戏会话页面提交决策
- 主持人可查看提交进度和倒计时
- 阶段结束条件：所有玩家提交 或 时限到达

### 🟡 审核阶段 (Review)

**主持人关键操作页面**：`/game/:sessionId/review`

主持人权限：
1. **查看所有玩家决策**
2. **修改玩家决策**（如有违规内容）
3. **添加临时事件**：
   - 单回合事件：仅本回合有效
   - 多回合事件：指定回合数有效
4. **添加临时规则**：设置有效回合数
5. **提交给 AI 推演**

### 🟢 推演阶段 (Inference)

- 后端调用 AI API 进行推演
- 自动跳转到推演结果页面
- 等待推演完成

### 🟣 结果阶段 (Result)

推演结果包含：
- 剧情叙述（narrative）
- 主体面板（现金、属性、被动收支）
- 排行榜（综合得分）
- 事件列表
- 财务核算（被动/主动分列）
- 策略选项（含预期变动）
- 风险/机会/效益卡
- 成就解锁

主持人点击 **"进入下一回合"** 继续游戏。

---

## 5. 卦象与成就系统

### 5.1 卦象系统

- **年度起卦**：每年（2回合）随机生成一个周易卦象
- **卦象影响**：
  - 乾卦：扩张性投资收益 +20%
  - 坤卦：防守型策略成本 -15%
  - 坎卦：现金流波动加剧
  - 离卦：品牌曝光度提升
  - 等等...
- **查看方式**：游戏界面顶部的规则状态栏

### 5.2 成就系统

- **成就类型**：
  - 行业领袖：品牌声誉永久 +5
  - 创新先锋：研发成本永久 -10%
  - 稳健经营：被动收入 +5%
- **触发条件**：由 AI 根据决策结果判定
- **查看方式**：推演结果页面的成就弹窗

### 5.3 主持人管理

- 在审核阶段可以手动添加事件/规则
- 查看当前生效的所有 Modifier
- 无法直接修改核心规则

---

## 6. 页面导航说明

### 主持人主要页面

| 页面 | 路径 | 用途 |
|------|------|------|
| 主持人配置 | `/rooms/:roomId/host-setup` | 初始化配置 |
| 游戏状态 | `/game/:sessionId/state` | 查看整体状态，控制流程 |
| 审核页面 | `/game/:sessionId/review` | 审核决策，添加事件/规则 |
| 推演结果 | `/game/:sessionId/round/:round/inference` | 查看 AI 推演结果 |

### 页面跳转流程

```
游戏状态页面 (决策阶段)
    ↓ [开始审核]
审核页面
    ↓ [提交给 AI 推演]
推演结果页面 (推演阶段 → 结果阶段)
    ↓ [进入下一回合]
游戏状态页面 (下一回合决策阶段)
```

---

## 7. 故障处理

### AI 推演报错

**常见原因**：
- API Key 过期或无效
- 网络超时
- API 端点配置错误

**解决方案**：
1. 检查后端控制台日志
2. 重新进入主持人设定页面更新 API 配置
3. 确认 API Key 有效

### 玩家掉线

- 系统支持重连，让玩家刷新页面即可
- WebSocket 会自动重连

### 游戏卡死

1. 检查当前阶段状态
2. 检查推演结果页面是否有错误
3. 如无法恢复，联系管理员重置

---

## 📌 注意事项

1. **配置顺序**：必须按 API → 规则 → 玩家 → 初始化 的顺序完成
2. **总决策主体数**：必须等于人类玩家数 + AI 玩家数
3. **临时事件/规则**：多回合有效的会自动跟踪进度
4. **推演结果缓存**：在 Redis 中缓存 24 小时
5. **保存配置后刷新快照**：确认配置已正确保存

---

**掌控全场，享受博弈！** 🎮
