# AI文字交互式游戏后端需求文档
## 1. 项目概述

> 进度与验收（后端）  
> - 阶段1 基础搭建：已通过 `全阶段共同测试/test-phase1-2.ps1`  
> - 阶段2 用户认证：已通过同上脚本（注册/登录/刷新/忘记密码等）  
> - 阶段3 房间系统基础：已通过 `第三阶段测试/test-phase3.ps1`（create/list/join/leave）  
> - 已知待修复：未授权访问在联合脚本中返回 500（期望 401），需补充错误处理。

### 1.1 项目简介
**游戏名称**：《凡墙皆是门》

本项目是AI文字交互式多人竞争博弈游戏《凡墙皆是门》的后端系统。玩家通过文字指令进行游戏，系统通过AI推演决策结果和剧情发展，实现多人实时同步的竞争博弈体验。

### 1.2 核心特性
- **AI驱动剧情推演**：使用AI模型实时生成剧情和决策结果
- **多人实时同步**：支持多玩家同时在线，实时同步游戏状态
- **竞争博弈机制**：玩家之间通过策略和决策进行竞争
- **文字交互界面**：纯文字交互，通过自然语言指令进行游戏

### 1.3 技术栈建议
- **后端框架**：Node.js (Express/Koa) 或 Python (FastAPI/Django)
- **实时通信**：WebSocket (Socket.io 或 WebSocket)
- **数据库**：PostgreSQL (主数据) + Redis (缓存/会话)
- **AI集成**：OpenAI API / 本地LLM模型
- **消息队列**：RabbitMQ / Redis Pub/Sub (用于AI任务队列)
- **容器化**：Docker + Docker Compose

### 1.4 通用体验/协同要求
- 前端需保持浏览器垂直滚动条可用（body/root 溢出可滚动），避免全屏 flex 居中导致无法滚动查看内容（房间列表、等待页等）；此为验收项，后端接口格式不变，仅作为前后端协同约束。

## 2. 核心功能需求

### 2.1 用户系统
#### 2.1.1 用户注册与认证
- 用户注册（邮箱/手机号/用户名）
- 用户登录（JWT Token认证）
- 用户信息管理（昵称、头像、个人简介）
- 用户等级与经验值系统
- 用户游戏历史记录

#### 2.1.3 管理员/开发者工具 - 在册用户管理
- 在册用户列表查询（仅开发者可用）
  - 接口：`GET /api/admin/users?status=&page=&limit=`
  - 返回字段：用户ID、用户名、邮箱、昵称、状态（active/frozen）、创建时间、最近登录时间、是否在线、当前所在房间（ID+名称+状态）
- 用户状态管理
  - 冻结/拉黑用户：`POST /api/admin/users/{user_id}/freeze`（状态置为 `frozen`，禁止登录和加入房间）
  - 解冻用户：`POST /api/admin/users/{user_id}/unfreeze`（状态恢复为 `active`）
  - 物理删除用户：`DELETE /api/admin/users/{user_id}`（仅对非当前开发者账号，且后续可扩展“存在关键关联时禁止删除”的规则）
- 管理权限控制
  - 仅开发者账号可访问 `/api/admin/*` 接口（后端通过 `ADMIN_USERNAME` 环境变量或默认 `admin` 判断）
  - 冻结账号在登录接口中返回 403，提示“账号已冻结”

#### 2.1.4 管理员/开发者工具 - 在线房间管理
- 在线/活跃房间列表查询（仅开发者可用）
  - 接口：`GET /api/admin/rooms?status=&page=&limit=`
  - 默认仅返回活跃房间（waiting/playing），支持按状态筛选（waiting/playing/closed/all）
  - 返回字段：房间ID、名称、状态、人数（当前/上限）、创建时间、开始/结束时间、房主信息（id/username/nickname）
- 房间强制关闭
  - 接口：`POST /api/admin/rooms/{room_id}/close`
  - 功能：开发者可在任何状态下关闭指定房间（将状态置为 closed，结束关联 GameSession，将 room_players 标记为 left，currentPlayers=0）
  - 用途：清理异常房间、结束卡死的游戏进程

#### 2.1.2 用户会话管理
- 会话状态维护
- 断线重连机制
- 多设备登录管理

### 2.2 游戏房间系统
#### 2.2.1 房间创建与管理
- 创建游戏房间（设置房间名称、最大玩家数、游戏模式）
- 加入/离开房间
- 房间列表查询（公开房间/私有房间）
- 房间状态管理（等待中/配置中/游戏中/已结束）
- 房间密码保护（可选）
- 主持人角色分配（房间创建者默认为主持人）

#### 2.2.2 房间配置
- 游戏模式选择（竞争模式/合作模式/自由模式）
- 游戏难度设置
- 游戏时长限制
- 玩家数量限制（2-10人）

#### 2.2.x 第三阶段交付要点（当前迭代）
- 实现最小房间流：创建（POST `/api/rooms/create`）→ 列表（GET `/api/rooms/list`）→ 加入（POST `/api/rooms/{room_id}/join`）→ 离开（POST `/api/rooms/{room_id}/leave`）。
- 房间数据落库：`rooms` 与 `room_players` 基础字段（name/max_players/status/creator_id/host_id/player_count/password? 可空）。
- 房间状态缓存（建议）：活跃房间列表与成员放入 Redis，便于快速查询与断线恢复。
- WebSocket 基础广播：房间内推送 `player_joined` / `player_left` / `system_message`，遵循“后端驱动状态同步”原则。
- Socket 目录结构预留（必须采纳）：`socket/roomHandler.ts` 负责 join/leave/match，`socket/index.ts` 挂载。
- 基础校验：人数上限、房间存在性、权限校验（主持人/成员），密码房间校验（可选开启）。
- 测试对齐：`第三阶段测试/test-phase3.ps1` 验证健康检查、注册/登录、房间创建、列表、加入、离开。

#### 2.2.3 主持人初始化设定
- **API配置管理**
  - AI服务端点配置（API URL）
  - API请求方法选择（GET/POST/PUT/DELETE等）
  - 请求头配置（Content-Type、Authorization等）
  - 请求体模板配置
  - 网络权限配置（CORS、代理设置等）
  - 默认AI服务提供商选择（DeepSeek/OpenAI/本地模型等）
  - 自定义AI服务配置（可覆盖默认设置）

- **游戏规则配置**
  - 游戏底层规则指令输入（文本编辑器）
  - 规则验证与格式化
  - 规则模板管理（保存/加载常用规则）
  - 规则预览功能

- **玩家位数配置**
  - 决策主体数量设置（本场游戏的决策主体总数）
  - 人类玩家数量设置（允许加入的人类玩家数量）
  - AI玩家数量自动计算（决策主体数 - 人类玩家数）
  - 玩家位数验证（确保人类玩家数 ≤ 决策主体数）

- **决策时限配置**
  - 每回合决策时限设置（单位：分钟，默认4分钟）
  - 时限范围：1-30分钟
  - 超时处理策略配置（自动提交/跳过/惩罚）

### 2.3 游戏核心机制
#### 2.3.1 游戏状态管理
- 游戏初始化流程
  1. 主持人完成初始化设定（API配置、游戏规则、玩家位数）
  2. 主持人确认开始游戏
  3. 系统根据配置初始化游戏（生成初始场景、分配角色/资源）
  4. 根据玩家位数配置创建决策主体（人类玩家 + AI玩家）
- 游戏回合管理（回合开始/结束、回合倒计时）
- 游戏状态同步（所有玩家实时同步）
- **游戏存档与恢复**
  - 游戏状态快照保存（完整游戏状态、玩家状态、回合信息）
  - 存档列表管理（多个存档点）
  - 存档恢复功能（恢复到指定存档点）
  - 自动存档（每回合结束自动保存）
  - 手动存档（玩家主动保存）

#### 2.3.0 主持人功能
- 主持人权限管理（仅主持人可进行初始化设定）
- 初始化设定保存与验证
- 初始化设定锁定（游戏开始后不可修改）
- 主持人转让功能（可选）
- **决策审核功能**
  - 查看所有玩家提交的决策
  - 决策状态管理（待审核/已审核/已提交AI）
  - 批量审核决策
  - 提交决策给AI推演
- **临时事件/规则管理**
  - 添加临时事件（仅本回合有效）
  - 添加多回合事件（指定回合数有效）
  - **多回合事件进度跟踪**
    - 事件进度记录（当前进度/目标进度）
    - 每回合自动更新事件进度状态
    - 主持人可手动更新事件进度
    - 事件进度提醒（每回合推演时自动包含进度信息）
    - 事件完成判定（进度达到100%时自动标记完成）
    - 事件超时处理（超过有效回合数未完成则标记失败）
  - 添加临时规则（仅本回合有效）
  - 添加多回合规则（指定回合数有效）
  - 规则优先级管理

#### 2.3.1 回合决策流程
- **决策阶段**
  1. 回合开始，启动决策倒计时
  2. **AI生成决策选项**（异步进行，不阻塞游戏流程）
     - 系统分析当前游戏状态
     - 为每个玩家生成3个个性化决策选项
     - 选项生成完成后推送给玩家
     - 如果生成失败，玩家可使用自由输入
  3. 玩家提交决策（可选择选项、输入自定义文本，或两者结合）
     - 玩家可以选择0-3个选项（多选）
     - 玩家可以输入自定义文本
     - 选项和自定义文本可以组合提交
  4. 决策状态实时更新（已提交/未提交）
  5. 决策时限到达或所有玩家提交后进入审核阶段
- **审核阶段**
  1. 主持人查看所有玩家决策
     - 显示玩家选择的选项（如有）
     - 显示选项组合建议
     - 显示自定义文本（如有）
     - 显示组合有效性标识
  2. 主持人可编辑玩家决策（可选）
     - 修改选项选择
     - 修改自定义文本
     - 添加修改说明
  3. 主持人可添加临时事件、临时规则、多回合规则
  4. 主持人确认提交给AI推演
- **推演阶段**
  1. 系统收集所有决策和临时事件/规则
     - 收集玩家选择的选项和自定义文本
     - 如果主持人修改了决策，使用修改后的内容
  2. **自动收集所有活跃的多回合事件及其当前进度**
  3. 将事件进度信息包含在AI推演Prompt中，提醒AI关注事件发展
  4. 调用AI模型进行推演（Prompt中包含事件进度和决策选项信息）
  5. 根据AI推演结果更新多回合事件进度
  6. 生成推演结果和剧情
  7. 更新游戏状态
  8. **成就检测**
     - 检测玩家是否满足成就解锁条件
     - 解锁成就并推送通知
  9. **大事纪记录**
     - 检测并记录重要事件
     - 推送大事纪通知
  10. 推送事件进度更新通知给所有玩家
  11. 进入下一回合

#### 2.3.2 玩家操作处理
- 接收玩家文字指令（决策）
- 指令解析与验证
- 决策状态记录（待审核）
- 决策提交时间记录
- 超时处理（决策时限到达时的处理）

#### 2.3.3 AI剧情推演
- 接收主持人审核后的决策集合
- 接收临时事件和规则
- **多回合事件进度管理**
  - 每回合推演前自动收集所有活跃的多回合事件及其当前进度
  - 将事件进度信息包含在AI推演的Prompt中
  - 提醒AI关注事件进度，确保事件线程不丢失
  - 推演后根据AI返回结果更新事件进度
  - 事件进度达到100%时自动标记为完成
  - 超过有效回合数未完成时标记为失败
- 整合游戏规则、临时规则、多回合规则
- 调用AI模型生成剧情发展
- 推演决策结果（成功/失败/部分成功）
- 生成场景描述和事件
- 计算玩家状态变化（资源、属性、关系等）
- 更新多回合事件进度
- **成就检测**
  - 推演后自动检测玩家是否满足成就解锁条件
  - 支持的成就类型：
    - 资源类：累计获得/消耗资源达到阈值
    - 策略类：连续决策成功、决策成功率等
    - 社交类：达成合作次数、交易次数等
    - 竞争类：获得第1名、排名提升等
    - 特殊类：绝地反击、完美决策等
  - 成就解锁时：
    - 记录解锁时间和回合
    - 推送成就解锁通知给所有玩家
    - 更新玩家成就列表
- **大事纪记录**
  - 推演后自动检测并记录重要事件
  - 记录的事件类型：
    - 重大交易（交易金额超过阈值）
    - 重要合作（多轮谈判后达成、涉及多个玩家等）
    - 排名重大变化（从后3名升至前3名、获得第1名等）
    - 特殊事件（多回合事件完成/失败、玩家淘汰等）
    - 关键决策（影响全局的决策、高风险高收益决策等）
  - 事件重要性判定：
    - 高重要性：影响全局、涉及多个玩家、资源变化巨大
    - 中重要性：影响部分玩家、资源变化中等
    - 低重要性：影响单个玩家、资源变化较小
  - 大事纪记录时：
    - 生成事件标题和描述
    - 记录涉及玩家
    - 保存相关数据（交易ID、合作ID等）
    - 推送大事纪通知给所有玩家

### 2.4 实时通信系统
#### 2.4.1 WebSocket连接管理
- 建立WebSocket连接
- 心跳检测与保活
- 连接断开处理
- 消息队列管理

#### 2.4.2 消息类型
- **游戏状态更新**：游戏状态变化时推送给所有玩家
- **玩家操作通知**：玩家操作结果通知
- **AI剧情推送**：AI生成的剧情内容
- **系统消息**：系统提示、错误信息
- **玩家聊天**：玩家之间的文字交流（可选）

### 2.5 竞争博弈机制
#### 2.5.1 资源系统
- 玩家资源管理（金币、能量、道具等）
- 资源获取与消耗
- **资源交易（玩家间交易）**
  - 玩家发起交易请求（指定交易对象、资源类型、数量）
  - 交易确认机制（对方确认后完成交易）
  - 交易记录保存
  - 交易合法性验证（资源充足性检查）
  - 交易超时处理（未确认的交易自动取消）

#### 2.5.2 竞争机制
- 玩家排名系统
- **竞争任务/挑战**
  - 任务系统（由AI或主持人发布）
  - 任务类型：收集任务、战斗任务、探索任务、合作任务等
  - 任务奖励（资源、经验、特殊道具）
  - 任务进度跟踪
  - 任务完成判定
  - 挑战系统（玩家间挑战、限时挑战）
- 玩家对抗机制
- 胜负判定规则

#### 2.5.3 策略系统
- **玩家策略记录**
  - 记录玩家每回合的决策内容
  - 记录决策结果和效果
  - 策略标签分类（攻击型、防御型、合作型等）
- **策略效果评估**
  - 计算策略成功率
  - 评估策略收益（资源变化、排名变化）
  - 策略适用场景分析
- **历史策略分析**
  - 玩家常用策略统计
  - 策略效果对比分析
  - 推荐策略建议

### 2.6 历史记录管理
#### 2.6.1 历史记录查询
- 用户游戏历史列表查询
- 支持多条件筛选（时间范围、游戏模式、结果等）
- 分页查询
- 排序功能（按时间、时长、结果等）

#### 2.6.2 历史记录详情
- 游戏完整记录查看
- 玩家操作历史查看
- 游戏状态快照查看
- 推演结果查看
- 游戏总结查看

#### 2.6.3 历史记录删除
- 单个记录删除
- 批量删除
- 删除确认机制
- 软删除（可选，保留数据但标记为已删除）
- 删除权限验证（只能删除自己的记录）

## 3. 系统架构设计

### 3.1 整体架构
```
┌─────────────┐
│  客户端层   │
└──────┬──────┘
       │ WebSocket/HTTP
┌──────▼─────────────────────────────────┐
│           API网关层                     │
│  (路由、认证、限流、负载均衡)            │
└──────┬─────────────────────────────────┘
       │
┌──────▼─────────────────────────────────┐
│          业务逻辑层                     │
│  ┌──────────┐  ┌──────────┐           │
│  │游戏管理  │  │用户管理  │           │
│  └──────────┘  └──────────┘           │
│  ┌──────────┐  ┌──────────┐           │
│  │AI推演引擎│  │实时同步  │           │
│  └──────────┘  └──────────┘           │
└──────┬─────────────────────────────────┘
       │
┌──────▼─────────────────────────────────┐
│          数据访问层                     │
│  ┌──────────┐  ┌──────────┐           │
│  │PostgreSQL│  │  Redis   │           │
│  └──────────┘  └──────────┘           │
└────────────────────────────────────────┘
       │
┌──────▼─────────────────────────────────┐
│          AI服务层                       │
│  (OpenAI API / 本地LLM模型)             │
└────────────────────────────────────────┘
```

### 3.2 核心模块划分

#### 3.2.1 用户服务模块 (User Service)
- 用户注册、登录、信息管理
- 用户会话管理
- 用户数据统计

#### 3.2.2 房间服务模块 (Room Service)
- 房间创建、加入、离开
- 房间状态管理
- 房间配置管理

#### 3.2.3 游戏引擎模块 (Game Engine)
- 游戏状态管理
- 游戏规则执行
- 回合管理
- 胜负判定

#### 3.2.4 AI推演模块 (AI Inference Engine)
- 从主持人配置读取API配置
- 根据配置构建AI请求（endpoint、method、headers、body）
- 玩家指令解析
- AI模型调用（使用配置的API）
- 剧情生成（结合游戏规则）
- 决策结果推演

#### 3.2.5 实时同步模块 (Real-time Sync)
- **Socket处理器架构**（必须采纳）
  - `socket/roomHandler.ts` - 房间加入/离开/匹配逻辑
  - `socket/gameHandler.ts` - 回合切换/博弈逻辑校验/计时器
  - `socket/messageHandler.ts` - 消息路由和广播
  - `socket/index.ts` - Socket.io初始化
- **后端驱动状态同步**（必须采纳）
  - 所有状态变更在后端计算，前端仅发送动作
  - 后端作为"单一事实来源（Single Source of Truth）"
  - 状态变更后通过Socket.io广播给房间内所有玩家
- **Redis房间状态管理**（必须采纳）
  - 活跃房间状态存储在Redis（快速读写）
  - 历史数据存储在PostgreSQL（持久化）
  - 断线重连时从Redis读取快照恢复
- WebSocket连接管理
- 消息广播
- 状态同步
- 事件推送
- **断线重连机制**（必须采纳）
  - 客户端断线检测（心跳机制）
  - Redis快照保存（游戏状态快照）
  - 重连后自动同步最新游戏状态（从Redis读取快照）
  - 保留玩家操作队列（断线期间的操作）
  - 自动重试机制
- **Socket.io Acknowledgments机制**（建议采纳）
  - 关键状态更新使用acknowledgments确认接收
  - 确保消息可靠传递

> **实现进度（第四阶段 - 最小实时子系统）**  
> - 已在当前代码中落地的最小实现：  
>   - `backend/src/server.ts` + `backend/src/socket/index.ts`：完成 Socket.io 初始化与连接管理。  
>   - `backend/src/socket/authSocket.ts`：基于 JWT 的连接认证（从 `handshake.auth.token` / `Authorization` 头读取）。  
>   - `backend/src/socket/roomHandlers.ts`：实现 `join_room` / `leave_room` / `system_broadcast` / `sync_state` 事件，触发：  
>     - `player_joined` / `player_left`  
>     - `game_state_update`（房间在线玩家及基础状态）  
>     - `system_message`（系统广播）  
>     - `error`（错误消息封装）  
>   - `backend/src/services/roomStateService.ts`：使用 Redis 维护简化的房间状态：  
>     - `room:{room_id}:players`：房间在线玩家ID集合  
>     - `room:{room_id}:state`：房间基础状态字段 `status`（默认 `waiting`）  
> - 本阶段仅实现“最小可用子集”，为后续完整 3.2.5 方案（多种消息类型、完整断线重连、Ack 机制）打基础。

#### 3.2.6 数据持久化模块 (Data Persistence)
- 数据库操作
- 缓存管理
- 数据备份
- **Redis状态存储策略**（必须采纳）
  - 活跃房间状态 → Redis（快速读写）
  - 历史数据 → PostgreSQL（持久化）
  - 断线恢复 → 从Redis读取快照

## 4. 数据模型设计

### 4.1 用户表 (users)
```sql
- id: UUID (主键)
- username: VARCHAR(50) (唯一)
- email: VARCHAR(100) (唯一)
- password_hash: VARCHAR(255)
- nickname: VARCHAR(50)
- avatar_url: VARCHAR(255)
- level: INTEGER (默认1)
- experience: INTEGER (默认0)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
- last_login_at: TIMESTAMP
```

### 4.2 游戏房间表 (game_rooms)
```sql
- id: UUID (主键)
- name: VARCHAR(100)
- creator_id: UUID (外键 -> users.id, 主持人)
- host_id: UUID (外键 -> users.id, 主持人，默认等于creator_id)
- max_players: INTEGER
- current_players: INTEGER
- status: ENUM ('waiting', 'configuring', 'playing', 'finished')
- game_mode: VARCHAR(50)
- password: VARCHAR(255) (可选，加密存储)
- config: JSONB (游戏配置)
- initialization_completed: BOOLEAN (默认false, 主持人完成初始化设定后为true)
- created_at: TIMESTAMP
- started_at: TIMESTAMP
- finished_at: TIMESTAMP
```

### 4.3 房间玩家关系表 (room_players)
```sql
- id: UUID (主键)
- room_id: UUID (外键 -> game_rooms.id)
- user_id: UUID (外键 -> users.id)
- role: VARCHAR(50) (玩家角色: 'host', 'human_player', 'ai_player')
- player_index: INTEGER (决策主体索引，1-N)
- is_human: BOOLEAN (是否为人类玩家)
- status: ENUM ('joined', 'ready', 'playing', 'left')
- joined_at: TIMESTAMP
- left_at: TIMESTAMP
```

### 4.4 游戏会话表 (game_sessions)
```sql
- id: UUID (主键)
- room_id: UUID (外键 -> game_rooms.id)
- current_round: INTEGER
- total_rounds: INTEGER
- game_state: JSONB (完整游戏状态)
- status: ENUM ('initializing', 'playing', 'paused', 'finished')
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 4.5 玩家操作记录表 (player_actions)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- user_id: UUID (外键 -> users.id)
- player_index: INTEGER (玩家索引)
- round: INTEGER
- selected_option_ids: JSONB (选中的选项ID数组，可为空)
- action_text: TEXT (玩家原始指令，包含自定义文本)
- action_type: VARCHAR(50)
- action_data: JSONB (解析后的操作数据，包含选项和自定义文本的组合)
- combination_suggestion: TEXT (AI生成的选项组合建议，可为空)
- host_modified: BOOLEAN (是否被主持人修改，默认false)
- host_modification: JSONB (主持人修改内容，可为空)
  {
    "modified_options": [...], // 修改后的选项
    "modified_text": "...", // 修改后的文本
    "modification_reason": "...", // 修改原因
    "modified_at": "2024-01-01T12:00:00Z",
    "modified_by": "uuid" // 主持人用户ID
  }
- ai_response: JSONB (AI生成的响应)
- result: JSONB (操作结果)
- created_at: TIMESTAMP
```
注意：selected_option_ids存储玩家选择的选项ID数组，action_text包含自定义文本，两者可以组合

### 4.6 游戏历史表 (game_history)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- winner_id: UUID (外键 -> users.id, 可为空)
- final_ranking: JSONB (最终排名)
- game_summary: TEXT (游戏总结)
- duration: INTEGER (游戏时长，秒)
- finished_at: TIMESTAMP
```

### 4.7 主持人配置表 (host_configurations)
```sql
- id: UUID (主键)
- room_id: UUID (外键 -> game_rooms.id, 唯一)
- api_config: JSONB (API配置)
  {
    "provider": "deepseek" | "openai" | "custom",
    "endpoint": "string",
    "method": "POST" | "GET" | "PUT" | "DELETE",
    "headers": {
      "Content-Type": "application/json",
      "Authorization": "Bearer {token}",
      ...
    },
    "request_body_template": "string",
    "network_permissions": {
      "cors_enabled": boolean,
      "proxy_settings": {...}
    }
  }
- game_rules: TEXT (游戏底层规则指令)
- total_decision_entities: INTEGER (决策主体总数)
- human_player_count: INTEGER (人类玩家数量)
- ai_player_count: INTEGER (AI玩家数量，自动计算)
- decision_time_limit: INTEGER (每回合决策时限，单位：分钟，默认4)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 4.8 临时事件表 (temporary_events)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- round: INTEGER (生效回合)
- event_type: ENUM ('single_round', 'multi_round') (单回合/多回合)
- event_content: TEXT (事件内容描述)
- effective_rounds: INTEGER (有效回合数，单回合为1)
- progress: JSONB (事件进度信息)
  {
    "current": 0, // 当前进度值
    "target": 100, // 目标进度值
    "progress_percentage": 0, // 进度百分比
    "status": "active" | "completed" | "failed", // 事件状态
    "progress_history": [ // 进度历史记录
      {
        "round": 1,
        "progress": 20,
        "description": "事件进展描述",
        "updated_at": "2024-01-01T12:00:00Z"
      }
    ],
    "last_updated_round": 1 // 最后更新进度时的回合数
  }
- created_by: UUID (外键 -> users.id, 创建人，主持人)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
- completed_at: TIMESTAMP (完成时间，可为空)
```

### 4.9 合作申请表 (cooperations)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- round: INTEGER (达成回合)
- initiator_player_index: INTEGER (发起方玩家索引)
- target_player_index: INTEGER (接收方玩家索引)
- cooperation_type: ENUM ('resource', 'action', 'strategy') (合作类型)
- cooperation_content: TEXT (合作内容，富文本)
- conditions: TEXT (合作条件/要求)
- expected_benefits: TEXT (预期收益说明)
- negotiation_round: INTEGER (谈判轮次，默认0，表示未谈判)
- status: ENUM ('pending', 'negotiating', 'accepted', 'rejected', 'expired', 'cancelled') (合作申请状态)
- host_processing_status: ENUM ('original', 'modified', 'deleted') (主持人处理状态，默认'original')
- modified_content: TEXT (主持人修改后的合作内容，可为空)
- modification_reason: TEXT (主持人修改说明，可为空)
- created_at: TIMESTAMP
- accepted_at: TIMESTAMP (接受时间，可为空)
- modified_at: TIMESTAMP (主持人修改时间，可为空)
- expires_at: TIMESTAMP (过期时间)
```

### 4.10 合作申请谈判历史表 (cooperation_negotiations)
```sql
- id: UUID (主键)
- cooperation_id: UUID (外键 -> cooperations.id)
- round: INTEGER (谈判轮次)
- sender_player_index: INTEGER (发送方玩家索引)
- cooperation_content: TEXT (本轮谈判的合作内容)
- conditions: TEXT (本轮谈判的合作条件)
- expected_benefits: TEXT (本轮谈判的预期收益)
- modification_reason: TEXT (修改说明)
- created_at: TIMESTAMP
```

### 4.11 公开声明表 (public_statements)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- round: INTEGER (发布回合)
- player_index: INTEGER (发布者玩家索引)
- player_name: VARCHAR(50) (发布者昵称)
- player_avatar: VARCHAR(255) (发布者头像URL，可为空)
- content: TEXT (声明内容，最大长度500字)
- published_at: TIMESTAMP (发布时间)
- created_at: TIMESTAMP
```
注意：公开声明仅在决策阶段可以发布，所有玩家可见

### 4.12 成就表 (achievements)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- player_index: INTEGER (玩家索引)
- achievement_id: VARCHAR(50) (成就ID，如"millionaire")
- name: VARCHAR(100) (成就名称)
- description: TEXT (成就描述)
- icon: VARCHAR(255) (成就图标URL)
- type: ENUM ('resource', 'strategy', 'social', 'competitive', 'special') (成就类型)
- rarity: ENUM ('common', 'rare', 'epic', 'legendary') (成就稀有度)
- unlocked_at: TIMESTAMP (解锁时间，可为空)
- round_unlocked: INTEGER (解锁回合，可为空)
- progress: INTEGER (当前进度，0-100)
- target: INTEGER (目标值)
- created_at: TIMESTAMP
```
注意：成就系统支持跨局游戏成就（可选），需要额外的用户成就表

### 4.13 大事纪表 (milestones)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- round: INTEGER (发生回合)
- type: ENUM ('trade', 'cooperation', 'ranking', 'event', 'decision', 'elimination') (事件类型)
- title: VARCHAR(200) (事件标题)
- description: TEXT (事件描述)
- importance: ENUM ('low', 'medium', 'high') (重要性)
- participants: JSONB (涉及玩家列表)
  [
    {
      "player_index": 1,
      "player_name": "玩家1",
      "avatar": "url"
    },
    ...
  ]
- related_data: JSONB (相关数据)
  {
    "trade_id": "uuid", // 如果是交易类型
    "cooperation_id": "uuid", // 如果是合作类型
    "ranking_change": {...}, // 如果是排名类型
    ...
  }
- created_at: TIMESTAMP
```
注意：大事纪在游戏进行中自动记录，重要事件由系统判定或主持人标记

### 4.14 决策选项表 (decision_options)
```sql
- id: UUID (主键)
- session_id: UUID (外键 -> game_sessions.id)
- round: INTEGER (回合数)
- player_index: INTEGER (玩家索引)
- option_id: VARCHAR(50) (选项ID)
- text: TEXT (选项文本)
- expected_effect: TEXT (预期效果提示)
- category: VARCHAR(50) (选项类别：attack/defense/cooperation/explore/trade)
- generated_at: TIMESTAMP (生成时间)
- refresh_count: INTEGER (刷新次数，默认0)
```
注意：选项由AI批量生成，每回合为每个玩家生成3个选项

### 4.15 Redis数据结构
```
- session:{session_id}:state -> 游戏状态缓存
- session:{session_id}:round:{round}:decisions -> 当前回合决策列表
- session:{session_id}:round:{round}:decision_status -> 决策状态映射
- session:{session_id}:round:{round}:decision_options -> 当前回合决策选项（按玩家索引）
- session:{session_id}:round:{round}:cooperations -> 当前回合合作事件列表
- session:{session_id}:round:{round}:public_statements -> 当前回合公开声明列表
- session:{session_id}:events:active -> 活跃的多回合事件列表
- session:{session_id}:events:{event_id}:progress -> 事件进度缓存
- session:{session_id}:cooperations:{cooperation_id} -> 合作申请详情缓存
- session:{session_id}:milestones -> 大事纪列表缓存
- session:{session_id}:player:{player_index}:achievements -> 玩家成就列表缓存
- room:{room_id}:players -> 房间玩家列表
- room:{room_id}:host_config -> 主持人配置缓存
- user:{user_id}:session -> 用户当前会话
- ws:{user_id}:connection -> WebSocket连接信息
- queue:ai_tasks -> AI任务队列
- queue:option_generation -> 决策选项生成任务队列
```

## 5. API接口设计

### 5.0 系统相关接口

#### 5.0.1 获取游戏信息
```
GET /api/system/info
Response:
{
  "code": 200,
  "data": {
    "game_name": "凡墙皆是门",
    "game_name_en": "Every Wall is a Door",
    "version": "1.0.0",
    "description": "AI文字交互式多人竞争博弈游戏",
    "features": [
      "AI驱动剧情推演",
      "多人实时同步",
      "竞争博弈机制",
      "文字交互界面"
    ]
  }
}
```
注意：此接口无需认证，前端可在首页调用以获取游戏名称等信息

#### 5.0.2 帮助内容相关接口
```
GET /api/system/help
Response:
{
  "code": 200,
  "data": {
    "content": "string", // 帮助内容（富文本）
    "updated_at": "2024-01-01T12:00:00Z",
    "updated_by": "uuid" // 最后更新者ID
  }
}
```
注意：此接口无需认证，所有用户可访问

```
PUT /api/system/help
Headers: Authorization: Bearer {token}
Request Body:
{
  "content": "string" // 帮助内容（富文本）
}
Response:
{
  "code": 200,
  "message": "帮助内容已更新",
  "data": {
    "content": "string",
    "updated_at": "2024-01-01T12:00:00Z",
    "updated_by": "uuid"
  }
}
```
注意：此接口需要管理员权限，仅管理员可修改帮助内容

### 5.1 用户相关接口

#### 5.1.1 用户注册
```
POST /api/auth/register
Request Body:
{
  "username": "string",
  "email": "string",
  "password": "string",
  "nickname": "string"
}
Response:
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user_id": "uuid",
    "token": "jwt_token"
  }
}
```

#### 5.1.2 用户登录
```
POST /api/auth/login
Request Body:
{
  "username": "string",
  "password": "string"
}
Response:
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user_id": "uuid",
    "token": "jwt_token",
    "user_info": {...}
  }
}
```

#### 5.1.3 获取用户信息
```
GET /api/user/info
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "user_id": "uuid",
    "username": "string",
    "nickname": "string",
    "email": "string",
    "avatar_url": "string",
    "bio": "string",
    "level": 10,
    "experience": 1500,
    "created_at": "2024-01-01T12:00:00Z",
    "last_login_at": "2024-01-01T12:00:00Z"
  }
}
```

#### 5.1.4 更新用户信息
```
PUT /api/user/info
Headers: Authorization: Bearer {token}
Request Body:
{
  "nickname": "string" (可选),
  "bio": "string" (可选),
  "avatar_url": "string" (可选)
}
Response:
{
  "code": 200,
  "message": "用户信息已更新",
  "data": {
    "user_id": "uuid",
    "nickname": "string",
    "bio": "string",
    "avatar_url": "string"
  }
}
```

#### 5.1.5 上传用户头像
```
POST /api/user/avatar
Headers: Authorization: Bearer {token}
Content-Type: multipart/form-data
Request Body:
{
  "avatar": File (图片文件)
}
Response:
{
  "code": 200,
  "message": "头像上传成功",
  "data": {
    "avatar_url": "https://..."
  }
}
```

#### 5.1.6 忘记密码
```
POST /api/auth/forgot-password
Request Body:
{
  "email": "string"
}
Response:
{
  "code": 200,
  "message": "密码重置邮件已发送"
}
```

#### 5.1.7 重置密码
```
POST /api/auth/reset-password
Request Body:
{
  "token": "string" (重置令牌),
  "new_password": "string"
}
Response:
{
  "code": 200,
  "message": "密码重置成功"
}
```

### 5.2 房间相关接口

#### 5.2.1 创建房间
```
POST /api/rooms/create
Headers: Authorization: Bearer {token}
Request Body:
{
  "name": "string",
  "max_players": 4,
  "game_mode": "competitive",
  "password": "string" (可选),
  "config": {...}
}
Response:
{
  "code": 200,
  "data": {
    "room_id": "uuid",
    "room_info": {...}
  }
}
```

#### 5.2.2 获取房间列表
```
GET /api/rooms/list?status=waiting&page=1&limit=20
Response:
{
  "code": 200,
  "data": {
    "rooms": [
      {
        "id": "uuid",
        "name": "string",
        "status": "waiting|playing|closed",
        "maxPlayers": 4,
        "currentPlayers": 2,
        "hostId": "uuid",
        "hostName": "主持人昵称或用户名",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

#### 5.2.3 加入房间
```
POST /api/rooms/{room_id}/join
Headers: Authorization: Bearer {token}
Request Body:
{
  "password": "string" (可选)
}
Response:
{
  "code": 200,
  "data": {
    "room_id": "uuid",
    "joined": true
  }
}
```

#### 5.2.4 离开房间
```
POST /api/rooms/{room_id}/leave
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "已离开房间"
}
```

#### 5.2.5 获取主持人配置
```
GET /api/rooms/{room_id}/host-config
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "room_id": "uuid",
    "api_config": {...},
    "game_rules": "string",
    "total_decision_entities": 4,
    "human_player_count": 2,
    "ai_player_count": 2,
    "initialization_completed": false
  }
}
```

#### 5.2.6 转让主持人
```
POST /api/rooms/{room_id}/transfer-host
Headers: Authorization: Bearer {token}
Request Body:
{
  "new_host_id": "uuid" (新主持人用户ID)
}
Response:
{
  "code": 200,
  "message": "主持人已转让",
  "data": {
    "new_host_id": "uuid",
    "new_host_name": "string"
  }
}
注意：只有当前主持人可以转让权限
```

#### 5.2.7 保存主持人配置（分步保存）
```
POST /api/rooms/{room_id}/host-config/api
Headers: Authorization: Bearer {token}
Request Body:
{
  "provider": "deepseek" | "openai" | "custom",
  "endpoint": "https://api.deepseek.com/v1/chat/completions",
  "method": "POST",
  "headers": {
    "Content-Type": "application/json",
    "Authorization": "Bearer {token}"
  },
  "request_body_template": "{\"model\": \"deepseek-chat\", \"messages\": [...]}",
  "network_permissions": {
    "cors_enabled": true,
    "proxy_settings": {}
  }
}
Response:
{
  "code": 200,
  "message": "API配置已保存"
}
```

```
POST /api/rooms/{room_id}/host-config/rules
Headers: Authorization: Bearer {token}
Request Body:
{
  "game_rules": "你是一个游戏推演系统。游戏规则如下：\n1. 玩家通过文字指令进行操作\n2. 每个操作都有成功概率\n3. ..."
}
Response:
{
  "code": 200,
  "message": "游戏规则已保存"
}
```

```
POST /api/rooms/{room_id}/host-config/players
Headers: Authorization: Bearer {token}
Request Body:
{
  "total_decision_entities": 4,
  "human_player_count": 2,
  "decision_time_limit": 4, // 决策时限，单位：分钟，默认4
  "timeout_strategy": "auto_submit" // 超时处理策略：auto_submit(自动提交)/skip(跳过)/penalty(惩罚)
}
Response:
{
  "code": 200,
  "message": "玩家配置已保存",
  "data": {
    "total_decision_entities": 4,
    "human_player_count": 2,
    "ai_player_count": 2,
    "decision_time_limit": 4,
    "timeout_strategy": "auto_submit"
  }
}
```

#### 5.2.7 完成初始化设定
```
POST /api/rooms/{room_id}/host-config/complete
Headers: Authorization: Bearer {token}
Request Body:
{
  "validate": true (可选，是否验证配置)
}
Response:
{
  "code": 200,
  "message": "初始化设定已完成",
  "data": {
    "room_id": "uuid",
    "initialization_completed": true,
    "can_start_game": true
  }
}
```

#### 5.2.8 验证主持人配置
```
POST /api/rooms/{room_id}/host-config/validate
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "valid": true,
    "errors": [],
    "warnings": []
  }
}
```

### 5.3 游戏相关接口

#### 5.3.1 开始游戏
```
POST /api/game/{room_id}/start
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "session_id": "uuid",
    "game_state": {...}
  }
}
注意：只有主持人可以开始游戏，且需要完成初始化设定
```

#### 5.3.2 获取决策选项
```
GET /api/game/{session_id}/round/{round}/decision-options
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "round": 1,
    "options": [
      {
        "option_id": "uuid1",
        "text": "攻击敌人A",
        "expected_effect": "可能造成15点伤害",
        "category": "attack"
      },
      {
        "option_id": "uuid2",
        "text": "与玩家2合作",
        "expected_effect": "可能获得资源支持",
        "category": "cooperation"
      },
      {
        "option_id": "uuid3",
        "text": "探索新区域",
        "expected_effect": "可能发现隐藏资源",
        "category": "explore"
      }
    ],
    "generated_at": "2024-01-01T12:00:00Z"
  }
}
```
注意：
1. 选项由AI批量生成，基于当前游戏状态为每个玩家生成3个个性化选项
2. 选项在回合开始时生成一次，本回合内保持不变
3. 如果生成失败，返回空数组，玩家可使用自由输入

#### 5.3.2.1 刷新决策选项
```
POST /api/game/{session_id}/round/{round}/decision-options/refresh
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "round": 1,
    "options": [...], // 新的3个选项
    "generated_at": "2024-01-01T12:01:00Z",
    "refresh_count": 1 // 本回合刷新次数
  }
}
```
注意：
1. 每回合限制刷新1次
2. 刷新后生成新的3个选项
3. 如果已达到刷新限制，返回错误

#### 5.3.2.2 提交玩家决策
```
POST /api/game/{session_id}/decision
Headers: Authorization: Bearer {token}
Request Body:
{
  "selected_option_ids": ["uuid1", "uuid3"], // 选中的选项ID数组（可选，可多选）
  "custom_text": "我要先探索新区域，找到资源后再攻击敌人A的弱点", // 自定义文本（可选）
  "round": 1
}
注意：
1. selected_option_ids和custom_text至少提供一个
2. 如果只选择选项，custom_text可为空
3. 如果只输入自定义文本，selected_option_ids可为空数组
4. 可以同时提供选项和自定义文本，组合提交
Response:
{
  "code": 200,
  "data": {
    "action_id": "uuid",
    "status": "submitted",
    "selected_options": [
      {
        "option_id": "uuid1",
        "text": "攻击敌人A"
      },
      {
        "option_id": "uuid3",
        "text": "探索新区域"
      }
    ],
    "custom_text": "我要先探索新区域，找到资源后再攻击敌人A的弱点",
    "submitted_at": "2024-01-01T12:00:00Z",
    "deadline": "2024-01-01T12:04:00Z"
  }
}
```

#### 5.3.2.0 发布公开声明
```
POST /api/game/{session_id}/round/{round}/public-statement
Headers: Authorization: Bearer {token}
Request Body:
{
  "content": "我宣布将全力支持玩家2的行动！" // 声明内容，最大长度500字
}
Response:
{
  "code": 200,
  "message": "公开声明已发布",
  "data": {
    "statement_id": "uuid",
    "player_index": 1,
    "player_name": "玩家1",
    "content": "我宣布将全力支持玩家2的行动！",
    "round": 1,
    "published_at": "2024-01-01T12:00:00Z"
  }
}
```
注意：
1. 仅在决策阶段可以发布公开声明
2. 声明内容会通过WebSocket实时推送给所有玩家
3. 声明内容长度限制（如500字）
4. 每回合可发布多次公开声明（无次数限制，或可配置限制）

#### 5.3.2.0.1 获取本轮公开声明列表
```
GET /api/game/{session_id}/round/{round}/public-statements
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "statements": [
      {
        "statement_id": "uuid",
        "player_index": 1,
        "player_name": "玩家1",
        "player_avatar": "url",
        "content": "我宣布将全力支持玩家2的行动！",
        "round": 1,
        "published_at": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "total": 5
  }
}
```
注意：返回本回合所有公开声明，按时间倒序排列

#### 5.3.2.1 添加临时事件（带进度跟踪）
```
POST /api/game/{session_id}/round/{round}/temporary-event
Headers: Authorization: Bearer {token}
Request Body:
{
  "event_type": "single_round" | "multi_round",
  "event_content": "突然发生地震，所有玩家移动速度减半",
  "effective_rounds": 3, // 多回合事件的有效回合数
  "progress": { // 可选，多回合事件可设置初始进度
    "current": 0,
    "target": 100,
    "description": "事件初始状态"
  }
}
Response:
{
  "code": 200,
  "message": "临时事件已添加",
  "data": {
    "event_id": "uuid",
    "progress": {
      "current": 0,
      "target": 100,
      "progress_percentage": 0,
      "status": "active"
    }
  }
}
```

#### 5.3.2.2 更新多回合事件进度
```
PUT /api/game/{session_id}/events/{event_id}/progress
Headers: Authorization: Bearer {token}
Request Body:
{
  "progress": {
    "current": 50, // 当前进度值
    "description": "事件进展到一半，地震强度减弱" // 可选，进度描述
  },
  "auto_update": false // 是否自动更新（系统每回合自动更新时为true）
}
Response:
{
  "code": 200,
  "message": "事件进度已更新",
  "data": {
    "event_id": "uuid",
    "progress": {
      "current": 50,
      "target": 100,
      "progress_percentage": 50,
      "status": "active",
      "last_updated_round": 2
    }
  }
}
```

#### 5.3.2.3 获取活跃的多回合事件列表
```
GET /api/game/{session_id}/events/active
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "events": [
      {
        "event_id": "uuid",
        "event_content": "突然发生地震...",
        "event_type": "multi_round",
        "effective_rounds": 3,
        "current_round": 2,
        "progress": {
          "current": 50,
          "target": 100,
          "progress_percentage": 50,
          "status": "active",
          "progress_history": [
            {
              "round": 1,
              "progress": 0,
              "description": "事件开始",
              "updated_at": "2024-01-01T12:00:00Z"
            },
            {
              "round": 2,
              "progress": 50,
              "description": "事件进展到一半",
              "updated_at": "2024-01-01T12:05:00Z"
            }
          ],
          "last_updated_round": 2
        },
        "created_at": "2024-01-01T12:00:00Z"
      },
      ...
    ]
  }
}
```

#### 5.3.2.4 获取本轮合作事件列表（仅主持人）
```
GET /api/game/{session_id}/round/{round}/cooperations
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "cooperations": [
      {
        "cooperation_id": "uuid",
        "initiator_player_index": 1,
        "initiator_name": "玩家1",
        "target_player_index": 2,
        "target_name": "玩家2",
        "cooperation_type": "resource" | "action" | "strategy",
        "cooperation_content": "...", // 原始合作内容
        "conditions": "...",
        "expected_benefits": "...",
        "status": "original" | "modified" | "deleted", // 主持人处理状态
        "modified_content": "...", // 主持人修改后的内容（如果已修改）
        "modification_reason": "...", // 修改说明（如果已修改）
        "negotiation_round": 2, // 谈判轮次
        "accepted_at": "2024-01-01T12:00:00Z",
        "modified_at": "2024-01-01T12:01:00Z" // 主持人修改时间（如果已修改）
      }
    ],
    "total": 3,
    "original_count": 1,
    "modified_count": 1,
    "deleted_count": 1,
    "will_participate_count": 2 // 将参与推演的数量（原始+已修改）
  }
}
```
注意：此接口仅主持人可访问，返回本回合所有达成的合作申请

#### 5.3.2.5 修改合作事件（仅主持人）
```
PUT /api/game/{session_id}/round/{round}/cooperations/{cooperation_id}
Headers: Authorization: Bearer {token}
Request Body:
{
  "cooperation_content": "...", // 修改后的合作内容（可选）
  "conditions": "...", // 修改后的合作条件（可选）
  "expected_benefits": "...", // 修改后的预期收益（可选）
  "modification_reason": "..." // 修改说明（可选）
}
Response:
{
  "code": 200,
  "message": "合作事件已修改",
  "data": {
    "cooperation_id": "uuid",
    "status": "modified",
    "original_content": {...}, // 原始内容
    "modified_content": {...}, // 修改后的内容
    "modification_reason": "...",
    "modified_at": "2024-01-01T12:01:00Z"
  }
}
```

#### 5.3.2.6 删除/恢复合作事件（仅主持人）
```
POST /api/game/{session_id}/round/{round}/cooperations/{cooperation_id}/toggle-delete
Headers: Authorization: Bearer {token}
Request Body:
{
  "delete": true // true=删除（标记为不参与推演），false=恢复
}
Response:
{
  "code": 200,
  "message": "合作事件已删除" | "合作事件已恢复",
  "data": {
    "cooperation_id": "uuid",
    "status": "deleted" | "original" | "modified"
  }
}
```

#### 5.3.2.7 获取决策审核列表（仅主持人）
```
GET /api/game/{session_id}/round/{round}/decisions/review
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "decisions": [
      {
        "action_id": "uuid",
        "player_index": 1,
        "player_name": "玩家1",
        "player_avatar": "url",
        "selected_options": [
          {
            "option_id": "uuid1",
            "text": "攻击敌人A",
            "category": "attack"
          },
          {
            "option_id": "uuid3",
            "text": "探索新区域",
            "category": "explore"
          }
        ],
        "combination_suggestion": "先探索新区域，找到资源后再攻击敌人A的弱点",
        "combination_validity": "valid" | "warning" | "conflict", // 组合有效性
        "custom_text": "我要先探索新区域，找到资源后再攻击敌人A的弱点",
        "submitted_at": "2024-01-01T12:00:00Z",
        "host_modified": false,
        "host_modification": null,
        "review_status": "pending" | "reviewed"
      },
      ...
    ],
    "total": 4,
    "pending_count": 2,
    "reviewed_count": 2
  }
}
```
注意：此接口仅主持人可访问，返回本回合所有玩家决策，包含选项信息和组合建议

#### 5.3.2.8 编辑玩家决策（仅主持人）
```
PUT /api/game/{session_id}/round/{round}/decisions/{action_id}
Headers: Authorization: Bearer {token}
Request Body:
{
  "selected_options": [
    {
      "option_id": "uuid1",
      "text": "攻击敌人A"
    },
    {
      "option_id": "uuid2",
      "text": "使用道具B"
    }
  ],
  "custom_text": "使用道具B增强对敌人A的攻击",
  "modification_reason": "优化决策组合，提高成功率" // 可选
}
Response:
{
  "code": 200,
  "message": "决策已修改",
  "data": {
    "action_id": "uuid",
    "player_index": 1,
    "original_decision": {
      "selected_options": [...],
      "custom_text": "..."
    },
    "modified_decision": {
      "selected_options": [...],
      "custom_text": "..."
    },
    "modification_reason": "优化决策组合，提高成功率",
    "modified_at": "2024-01-01T12:01:00Z",
    "modified_by": "uuid" // 主持人用户ID
  }
}
```
注意：
1. 主持人可以修改玩家的决策选项和自定义文本
2. 修改记录保存在player_actions表的host_modification字段
3. 修改后的决策将用于AI推演

#### 5.3.3 主持人提交决策给AI推演
```
POST /api/game/{session_id}/round/{round}/submit-to-ai
Headers: Authorization: Bearer {token}
Request Body:
{
  "decision_ids": ["uuid1", "uuid2", ...] (可选，不传则提交所有已审核决策),
  "temporary_events": [
    {
      "event_type": "single_round" | "multi_round",
      "event_content": "突然发生地震...",
      "effective_rounds": 1,
      "progress": {...} // 多回合事件需包含进度信息
    }
  ],
  "temporary_rules": [...],
  "cooperation_ids": ["uuid1", "uuid2", ...] (可选，不传则提交所有状态为"原始"或"已修改"的合作事件)
}
注意：
1. 系统会自动收集所有活跃的多回合事件及其当前进度，包含在推演Prompt中
2. 系统会自动收集所有状态为"原始"或"已修改"的合作事件，包含在推演Prompt中
3. 合作事件作为决策的一部分，与玩家决策一起提交给AI推演
Response:
{
  "code": 200,
  "data": {
    "inference_id": "uuid",
    "status": "processing",
    "estimated_time": 30,
    "active_multi_round_events": [ // 系统自动包含的活跃事件
      {
        "event_id": "uuid",
        "event_content": "...",
        "progress": {...}
      }
    ],
    "cooperations": [ // 系统自动包含的合作事件
      {
        "cooperation_id": "uuid",
        "initiator": "玩家1",
        "target": "玩家2",
        "cooperation_type": "resource",
        "cooperation_content": "...", // 使用修改后的内容（如果已修改）
        "conditions": "...",
        "expected_benefits": "..."
      }
    ]
  }
}
```

#### 5.3.4 获取游戏状态
```
GET /api/game/{session_id}/state
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "session_id": "uuid",
    "current_round": 1,
    "game_state": {...},
    "players": [...],
    "active_multi_round_events": [...] // 活跃的多回合事件列表
  }
}
```

#### 5.3.4.1 获取玩家详细信息
```
GET /api/game/{session_id}/player/{player_index}/details
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "player_index": 1,
    "player_name": "玩家1",
    "avatar": "url",
    "level": 10,
    "is_human": true,
    "current_ranking": 2,
    "previous_ranking": 3,
    "ranking_change": 1, // 排名变化（+1表示上升1位，-1表示下降1位，0表示无变化）
    "current_round": 5,
    "resources": {
      "gold": 100,
      "energy": 50,
      "wood": 20
    },
    "attributes": {
      "health": 80,
      "attack": 15,
      "defense": 10
    },
    "decision_history": [
      {
        "round": 1,
        "action_text": "我要攻击敌人A",
        "submitted_at": "2024-01-01T12:00:00Z",
        "decision_time": 120, // 决策时长（秒）
        "result": "success",
        "narrative": "你成功攻击了敌人A，造成15点伤害...",
        "effects": {
          "resources": {
            "gold": +50
          },
          "attributes": {
            "health": -5
          }
        }
      },
      ...
    ],
    "decision_statistics": {
      "total_decisions": 5,
      "successful_decisions": 4,
      "success_rate": 0.8,
      "average_decision_time": 120, // 平均决策时长（秒）
      "decision_types": {
        "attack": 2,
        "defense": 1,
        "cooperation": 2
      }
    },
    "cooperation_records": [
      {
        "cooperation_id": "uuid",
        "type": "initiated" | "received",
        "target_player_index": 2,
        "target_player_name": "玩家2",
        "cooperation_type": "resource" | "action" | "strategy",
        "cooperation_content": "...",
        "status": "accepted" | "rejected" | "pending" | "negotiating",
        "round": 3,
        "created_at": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "trade_records": [
      {
        "trade_id": "uuid",
        "type": "initiated" | "received",
        "target_player_index": 2,
        "target_player_name": "玩家2",
        "resources_given": {
          "gold": 100
        },
        "resources_received": {
          "energy": 50
        },
        "status": "completed" | "rejected" | "pending" | "expired",
        "round": 2,
        "created_at": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "resource_changes": [
      {
        "round": 1,
        "resource_type": "gold",
        "change": 50,
        "reason": "完成任务奖励",
        "timestamp": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "attribute_changes": [
      {
        "round": 1,
        "attribute_type": "health",
        "change": -5,
        "reason": "受到攻击",
        "timestamp": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "achievements": [
      {
        "achievement_id": "uuid",
        "name": "百万富翁",
        "description": "累计获得1000金币",
        "icon": "url",
        "type": "resource",
        "unlocked_at": "2024-01-01T12:00:00Z",
        "round_unlocked": 5,
        "rarity": "common" | "rare" | "epic" | "legendary"
      },
      ...
    ]
  }
}
```
注意：
1. player_index为当前玩家在游戏中的索引（1-N）
2. 如果查询的是其他玩家信息，需要验证权限（仅同局游戏玩家可查看）
3. 排名变化基于上一回合的排名计算
4. 决策历史按回合倒序排列
5. 资源变化和属性变化记录最近20条
6. achievements字段包含本局游戏已解锁的成就列表

#### 5.3.4.1.1 获取玩家成就列表
```
GET /api/game/{session_id}/player/{player_index}/achievements
Headers: Authorization: Bearer {token}
Query Parameters:
- include_unlocked: boolean (是否包含未解锁成就，默认true)
- type: string (成就类型筛选，可选)
Response:
{
  "code": 200,
  "data": {
    "player_index": 1,
    "player_name": "玩家1",
    "achievements": [
      {
        "achievement_id": "uuid",
        "name": "百万富翁",
        "description": "累计获得1000金币",
        "icon": "url",
        "type": "resource",
        "unlocked_at": "2024-01-01T12:00:00Z",
        "round_unlocked": 5,
        "rarity": "common",
        "progress": 100, // 进度（0-100）
        "target": 1000 // 目标值
      },
      {
        "achievement_id": "uuid2",
        "name": "完美决策",
        "description": "连续5回合决策成功",
        "icon": "url",
        "type": "strategy",
        "unlocked_at": null, // 未解锁
        "round_unlocked": null,
        "rarity": "rare",
        "progress": 60, // 当前进度60%
        "target": 5
      },
      ...
    ],
    "statistics": {
      "total_achievements": 20,
      "unlocked_count": 8,
      "completion_rate": 0.4,
      "by_type": {
        "resource": 3,
        "strategy": 2,
        "social": 2,
        "competitive": 1,
        "special": 0
      }
    }
  }
}
```

#### 5.3.4.2 获取游戏统计数据
```
GET /api/game/{session_id}/statistics
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "session_id": "uuid",
    "current_round": 5,
    "players_comparison": {
      "resources": {
        "gold": [
          {"player_index": 1, "player_name": "玩家1", "value": 100},
          {"player_index": 2, "player_name": "玩家2", "value": 150},
          {"player_index": 3, "player_name": "玩家3", "value": 80}
        ],
        "energy": [
          {"player_index": 1, "player_name": "玩家1", "value": 50},
          {"player_index": 2, "player_name": "玩家2", "value": 60},
          {"player_index": 3, "player_name": "玩家3", "value": 40}
        ]
      },
      "attributes": {
        "health": [
          {"player_index": 1, "player_name": "玩家1", "value": 80},
          {"player_index": 2, "player_name": "玩家2", "value": 90},
          {"player_index": 3, "player_name": "玩家3", "value": 70}
        ],
        "attack": [
          {"player_index": 1, "player_name": "玩家1", "value": 15},
          {"player_index": 2, "player_name": "玩家2", "value": 18},
          {"player_index": 3, "player_name": "玩家3", "value": 12}
        ]
      }
    },
    "ranking_trends": [
      {
        "player_index": 1,
        "player_name": "玩家1",
        "avatar": "url",
        "rankings_by_round": [
          {"round": 1, "ranking": 2},
          {"round": 2, "ranking": 1},
          {"round": 3, "ranking": 1},
          {"round": 4, "ranking": 2},
          {"round": 5, "ranking": 2}
        ]
      },
      {
        "player_index": 2,
        "player_name": "玩家2",
        "avatar": "url",
        "rankings_by_round": [
          {"round": 1, "ranking": 1},
          {"round": 2, "ranking": 2},
          {"round": 3, "ranking": 2},
          {"round": 4, "ranking": 1},
          {"round": 5, "ranking": 1}
        ]
      },
      ...
    ],
    "decision_statistics": {
      "overall_submission_rate": 0.85, // 总体提交率
      "players_submission": [
        {
          "player_index": 1,
          "player_name": "玩家1",
          "submitted_count": 4,
          "total_count": 5,
          "submission_rate": 0.8,
          "average_submit_time": 120, // 平均提交时间（秒）
          "fastest_submit_time": 60, // 最快提交时间（秒）
          "slowest_submit_time": 180 // 最慢提交时间（秒）
        },
        ...
      ],
      "submission_time_distribution": [
        {
          "time_range": "0-60s",
          "count": 3,
          "percentage": 0.15
        },
        {
          "time_range": "60-120s",
          "count": 8,
          "percentage": 0.40
        },
        {
          "time_range": "120-180s",
          "count": 6,
          "percentage": 0.30
        },
        {
          "time_range": "180-240s",
          "count": 3,
          "percentage": 0.15
        }
      ],
      "decision_keywords": [
        {"keyword": "攻击", "count": 15, "frequency": 0.30},
        {"keyword": "防御", "count": 10, "frequency": 0.20},
        {"keyword": "合作", "count": 8, "frequency": 0.16},
        ...
      ]
    },
    "players_summary": [
      {
        "player_index": 1,
        "player_name": "玩家1",
        "avatar": "url",
        "is_human": true,
        "current_ranking": 2,
        "ranking_change": 0,
        "main_resources": {
          "gold": 100,
          "energy": 50
        },
        "decision_status": "submitted" | "pending", // 当前回合决策状态
        "total_resources_value": 150 // 资源总值（用于排序）
      },
      ...
    ],
    "milestones_summary": {
      "total_count": 15,
      "by_type": {
        "trade": 3,
        "cooperation": 4,
        "ranking": 2,
        "event": 3,
        "decision": 2,
        "elimination": 1
      },
      "by_importance": {
        "high": 3,
        "medium": 7,
        "low": 5
      },
      "recent_milestones": [
        {
          "milestone_id": "uuid",
          "round": 5,
          "type": "trade",
          "title": "重大交易达成",
          "description": "玩家1与玩家2达成1000金币的交易",
          "importance": "high",
          "participants": [1, 2],
          "timestamp": "2024-01-01T12:00:00Z"
        },
        ...
      ]
    }
  }
}
```
注意：
1. 此接口返回游戏的整体统计数据，用于群体面板展示
2. 数据按当前回合计算
3. 排名趋势包含所有已完成的回合
4. 决策关键词从所有玩家的决策内容中提取（中文分词）
5. 建议使用Redis缓存此接口数据，缓存时间5秒（与前端刷新频率一致）
6. 玩家列表按当前排名排序
7. milestones_summary包含大事纪的统计信息和最近事件

#### 5.3.4.2.1 获取大事纪列表
```
GET /api/game/{session_id}/milestones
Headers: Authorization: Bearer {token}
Query Parameters:
- type: string (事件类型筛选：trade/cooperation/ranking/event/decision/elimination，可选)
- importance: string (重要性筛选：high/medium/low，可选)
- round_start: integer (起始回合，可选)
- round_end: integer (结束回合，可选)
- player_index: integer (玩家索引，筛选涉及该玩家的事件，可选)
- page: integer (页码，默认1)
- limit: integer (每页数量，默认20)
Response:
{
  "code": 200,
  "data": {
    "milestones": [
      {
        "milestone_id": "uuid",
        "round": 5,
        "type": "trade",
        "title": "重大交易达成",
        "description": "玩家1与玩家2达成1000金币的交易，这是本局游戏迄今为止最大的交易",
        "importance": "high",
        "participants": [
          {
            "player_index": 1,
            "player_name": "玩家1",
            "avatar": "url"
          },
          {
            "player_index": 2,
            "player_name": "玩家2",
            "avatar": "url"
          }
        ],
        "related_data": {
          "trade_id": "uuid",
          "resources_exchanged": {
            "gold": 1000
          }
        },
        "timestamp": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "total": 15,
    "page": 1,
    "limit": 20,
    "total_pages": 1
  }
}
```
注意：
1. 大事纪按回合倒序排列（最新在前）
2. 支持多条件筛选组合
3. 分页查询，默认每页20条
4. related_data包含相关事件的详细信息（如交易ID、合作ID等）

#### 5.3.5 获取游戏历史
```
GET /api/game/history?user_id={user_id}&page=1&limit=20&start_date={date}&end_date={date}&game_mode={mode}&result={result}&sort={sort}
Headers: Authorization: Bearer {token}
Query Parameters:
- user_id: UUID (可选，不传则查询当前用户)
- page: INTEGER (页码，默认1)
- limit: INTEGER (每页数量，默认20)
- start_date: DATE (开始日期，可选)
- end_date: DATE (结束日期，可选)
- game_mode: STRING (游戏模式筛选，可选)
- result: STRING (结果筛选：win/lose/draw，可选)
- sort: STRING (排序：time_desc/time_asc/duration_desc/duration_asc，默认time_desc)
Response:
{
  "code": 200,
  "data": {
    "games": [
      {
        "id": "uuid",
        "session_id": "uuid",
        "room_name": "房间名称",
        "game_mode": "competitive",
        "started_at": "2024-01-01T12:00:00Z",
        "finished_at": "2024-01-01T13:00:00Z",
        "duration": 3600,
        "total_rounds": 10,
        "players": [
          {
            "user_id": "uuid",
            "player_name": "玩家1",
            "final_ranking": 1,
            "is_winner": true
          },
          ...
        ],
        "result": "win",
        "summary": "游戏总结..."
      },
      ...
    ],
    "total": 50,
    "page": 1,
    "limit": 20,
    "total_pages": 3
  }
}
```

#### 5.3.6 获取游戏历史详情
```
GET /api/game/history/{history_id}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "id": "uuid",
    "session_id": "uuid",
    "room_id": "uuid",
    "room_name": "房间名称",
    "game_mode": "competitive",
    "started_at": "2024-01-01T12:00:00Z",
    "finished_at": "2024-01-01T13:00:00Z",
    "duration": 3600,
    "total_rounds": 10,
    "current_round": 10,
    "winner_id": "uuid",
    "final_ranking": [
      {
        "user_id": "uuid",
        "player_name": "玩家1",
        "player_index": 1,
        "ranking": 1,
        "final_resources": {...},
        "is_winner": true
      },
      ...
    ],
    "game_summary": "游戏总结...",
    "players": [...],
    "rounds": [
      {
        "round": 1,
        "decisions": [...],
        "narrative": "...",
        "results": [...],
        "game_state_snapshot": {...}
      },
      ...
    ],
    "all_actions": [...],
    "temporary_events": [...],
    "temporary_rules": [...]
  }
}
```

#### 5.3.7 删除游戏历史
```
DELETE /api/game/history/{history_id}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "历史记录已删除"
}
```

#### 5.3.8 批量删除游戏历史
```
DELETE /api/game/history/batch
Headers: Authorization: Bearer {token}
Request Body:
{
  "history_ids": ["uuid1", "uuid2", ...]
}
Response:
{
  "code": 200,
  "message": "已删除 {count} 条历史记录",
  "data": {
    "deleted_count": 3,
    "failed_ids": []
  }
}
```

#### 5.3.9 获取游戏历史统计
```
GET /api/game/history/statistics?user_id={user_id}&start_date={date}&end_date={date}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "total_games": 100,
    "win_count": 45,
    "lose_count": 40,
    "draw_count": 15,
    "win_rate": 0.45,
    "total_duration": 360000,
    "average_duration": 3600,
    "favorite_game_mode": "competitive",
    "recent_games": 10
  }
}
```

#### 5.3.10 资源交易相关接口
```
POST /api/game/{session_id}/trade/request
Headers: Authorization: Bearer {token}
Request Body:
{
  "target_player_index": 2,
  "resources": {
    "gold": 100, // 交易的金币数量
    "energy": 50 // 交易的能源数量
  },
  "request_resources": {
    "gold": 200 // 请求对方给予的资源
  },
  "message": "用100金币换200金币" // 可选，交易说明
}
Response:
{
  "code": 200,
  "data": {
    "trade_id": "uuid",
    "status": "pending",
    "expires_at": "2024-01-01T12:05:00Z"
  }
}
```

```
POST /api/game/{session_id}/trade/{trade_id}/accept
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "交易已接受",
  "data": {
    "trade_id": "uuid",
    "status": "completed",
    "resources_exchanged": {...}
  }
}
```

```
POST /api/game/{session_id}/trade/{trade_id}/reject
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "交易已拒绝"
}
```

```
GET /api/game/{session_id}/trade/list
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "pending_trades": [
      {
        "trade_id": "uuid",
        "initiator": "玩家1",
        "target": "玩家2",
        "resources": {...},
        "request_resources": {...},
        "created_at": "2024-01-01T12:00:00Z",
        "expires_at": "2024-01-01T12:05:00Z"
      }
    ],
    "my_trades": [...]
  }
}
```

#### 5.3.11 合作申请相关接口
```
POST /api/game/{session_id}/cooperation/request
Headers: Authorization: Bearer {token}
Request Body:
{
  "target_player_index": 2,
  "cooperation_type": "resource" | "action" | "strategy", // 合作类型
  "cooperation_content": "string", // 合作内容（富文本）
  "conditions": "string", // 合作条件/要求
  "expected_benefits": "string", // 预期收益说明
  "expires_in": 300 // 过期时间（秒，默认300秒）
}
Response:
{
  "code": 200,
  "data": {
    "cooperation_id": "uuid",
    "status": "pending",
    "expires_at": "2024-01-01T12:05:00Z"
  }
}
```

```
POST /api/game/{session_id}/cooperation/{cooperation_id}/accept
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "合作申请已接受",
  "data": {
    "cooperation_id": "uuid",
    "status": "accepted"
  }
}
```

```
POST /api/game/{session_id}/cooperation/{cooperation_id}/reject
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "合作申请已拒绝",
  "data": {
    "cooperation_id": "uuid",
    "status": "rejected"
  }
}
```

```
POST /api/game/{session_id}/cooperation/{cooperation_id}/negotiate
Headers: Authorization: Bearer {token}
Request Body:
{
  "cooperation_type": "resource" | "action" | "strategy",
  "cooperation_content": "string", // 重新编辑的合作内容
  "conditions": "string",
  "expected_benefits": "string",
  "modification_reason": "string" // 修改说明
}
Response:
{
  "code": 200,
  "message": "谈判内容已发送",
  "data": {
    "cooperation_id": "uuid",
    "status": "negotiating",
    "negotiation_round": 2, // 谈判轮次
    "negotiation_history": [...]
  }
}
```

```
GET /api/game/{session_id}/cooperation/list
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "pending_cooperations": [
      {
        "cooperation_id": "uuid",
        "initiator": "玩家1",
        "target": "玩家2",
        "cooperation_type": "resource",
        "cooperation_content": "...",
        "conditions": "...",
        "expected_benefits": "...",
        "status": "pending" | "negotiating" | "accepted" | "rejected" | "expired",
        "negotiation_round": 0,
        "created_at": "2024-01-01T12:00:00Z",
        "expires_at": "2024-01-01T12:05:00Z"
      }
    ],
    "my_cooperations": [...],
    "negotiating_cooperations": [...]
  }
}
```

```
GET /api/game/{session_id}/cooperation/{cooperation_id}/negotiation-history
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "cooperation_id": "uuid",
    "negotiation_history": [
      {
        "round": 1,
        "sender": "玩家1",
        "cooperation_content": "...",
        "conditions": "...",
        "expected_benefits": "...",
        "modification_reason": "...",
        "created_at": "2024-01-01T12:00:00Z"
      },
      {
        "round": 2,
        "sender": "玩家2",
        "cooperation_content": "...",
        "conditions": "...",
        "expected_benefits": "...",
        "modification_reason": "...",
        "created_at": "2024-01-01T12:02:00Z"
      }
    ],
    "current_round": 2,
    "max_rounds": 5
  }
}
```

```
POST /api/game/{session_id}/cooperation/{cooperation_id}/cancel
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "合作申请已取消",
  "data": {
    "cooperation_id": "uuid",
    "status": "cancelled"
  }
}
```
注意：仅发起方可以取消，且只能在未接受前取消

#### 5.3.12 游戏存档相关接口
```
POST /api/game/{session_id}/save
Headers: Authorization: Bearer {token}
Request Body:
{
  "save_name": "第3回合存档", // 可选，存档名称
  "description": "保存当前游戏状态" // 可选，存档描述
}
Response:
{
  "code": 200,
  "message": "游戏已保存",
  "data": {
    "save_id": "uuid",
    "save_name": "第3回合存档",
    "round": 3,
    "saved_at": "2024-01-01T12:00:00Z"
  }
}
```

```
GET /api/game/{session_id}/saves
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "saves": [
      {
        "save_id": "uuid",
        "save_name": "第3回合存档",
        "round": 3,
        "saved_at": "2024-01-01T12:00:00Z",
        "is_auto_save": false
      },
      ...
    ]
  }
}
```

```
POST /api/game/{session_id}/restore/{save_id}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "游戏已恢复到指定存档点",
  "data": {
    "save_id": "uuid",
    "round": 3,
    "game_state": {...}
  }
}
注意：恢复存档需要所有玩家同意或仅主持人操作
```

```
DELETE /api/game/{session_id}/saves/{save_id}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "message": "存档已删除"
}
```

#### 5.3.12 任务/挑战相关接口
```
GET /api/game/{session_id}/tasks
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "tasks": [
      {
        "task_id": "uuid",
        "task_type": "collect" | "battle" | "explore" | "cooperation",
        "title": "收集100个金币",
        "description": "在3回合内收集100个金币",
        "reward": {
          "gold": 50,
          "experience": 100
        },
        "progress": {
          "current": 60,
          "target": 100
        },
        "status": "active" | "completed" | "failed",
        "deadline": "2024-01-01T12:10:00Z",
        "created_at": "2024-01-01T12:00:00Z"
      },
      ...
    ]
  }
}
```

```
GET /api/game/{session_id}/tasks/{task_id}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "task_id": "uuid",
    "task_type": "collect",
    "title": "收集100个金币",
    "description": "详细描述...",
    "reward": {...},
    "progress": {...},
    "status": "active",
    "participants": [...], // 参与任务的玩家
    "completion_history": [...] // 完成历史
  }
}
```

#### 5.3.13 策略分析相关接口
```
GET /api/user/strategies?user_id={user_id}&game_mode={mode}&limit={limit}
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "strategies": [
      {
        "strategy_id": "uuid",
        "strategy_type": "attack" | "defense" | "cooperation" | "mixed",
        "description": "积极攻击型策略",
        "usage_count": 15,
        "success_rate": 0.73,
        "average_gain": {
          "gold": 50,
          "ranking_change": 1.2
        },
        "best_scenario": "多人竞争模式",
        "last_used": "2024-01-01T12:00:00Z"
      },
      ...
    ],
    "statistics": {
      "total_strategies": 20,
      "most_used": "attack",
      "most_successful": "cooperation",
      "average_success_rate": 0.65
    }
  }
}
```

```
GET /api/user/strategies/{strategy_id}/analysis
Headers: Authorization: Bearer {token}
Response:
{
  "code": 200,
  "data": {
    "strategy_id": "uuid",
    "detailed_analysis": {
      "usage_history": [...],
      "success_cases": [...],
      "failure_cases": [...],
      "recommended_scenarios": [...],
      "improvement_suggestions": [...]
    }
  }
}
```

### 5.4 WebSocket消息协议

#### 5.4.1 连接建立
```javascript
// 客户端连接时发送认证
{
  "type": "auth",
  "token": "jwt_token"
}
```

#### 5.4.2 游戏状态更新
```javascript
// 服务器推送
{
  "type": "game_state_update",
  "session_id": "uuid",
  "game_state": {...},
  "timestamp": 1234567890
}
```

#### 5.4.3 玩家操作结果
```javascript
// 服务器推送
{
  "type": "action_result",
  "action_id": "uuid",
  "user_id": "uuid",
  "action_text": "我要攻击敌人A",
  "ai_response": {
    "narrative": "你向敌人A发起了攻击...",
    "result": "success",
    "effects": {...}
  },
  "updated_game_state": {...}
}
```

#### 5.4.4 AI剧情推送
```javascript
// 服务器推送
{
  "type": "narrative",
  "session_id": "uuid",
  "round": 1,
  "content": "突然，一阵狂风袭来...",
  "triggered_by": "system" // system, player_action, event
}
```

#### 5.4.5 玩家加入/离开
```javascript
// 服务器推送
{
  "type": "player_joined",
  "room_id": "uuid",
  "user_id": "uuid",
  "user_info": {...}
}

{
  "type": "player_left",
  "room_id": "uuid",
  "user_id": "uuid"
}
```

#### 5.4.6 错误消息
```javascript
// 服务器推送
{
  "type": "error",
  "code": "INVALID_ACTION",
  "message": "操作不合法",
  "details": {...}
}
```

#### 5.4.7 主持人配置更新
```javascript
// 服务器推送（当主持人更新配置时）
{
  "type": "host_config_updated",
  "room_id": "uuid",
  "config_type": "api" | "rules" | "players",
  "data": {...}
}
```

#### 5.4.8 初始化完成通知
```javascript
// 服务器推送（当主持人完成初始化设定时）
{
  "type": "initialization_completed",
  "room_id": "uuid",
  "can_start_game": true
}
```

#### 5.4.9 决策提交通知
```javascript
// 服务器推送（当玩家提交决策时）
{
  "type": "decision_submitted",
  "session_id": "uuid",
  "round": 1,
  "player_index": 1,
  "player_name": "玩家1",
  "submitted_at": "2024-01-01T12:00:00Z"
}
```

#### 5.4.10 决策状态更新
```javascript
// 服务器推送（决策状态变化时）
{
  "type": "decision_status_update",
  "session_id": "uuid",
  "round": 1,
  "decisions": [
    {
      "player_index": 1,
      "status": "submitted" | "pending",
      "submitted_at": "2024-01-01T12:00:00Z"
    },
    ...
  ],
  "total_players": 4,
  "submitted_count": 2
}
```

#### 5.4.11 决策时限更新
```javascript
// 服务器推送（决策倒计时更新）
{
  "type": "decision_deadline_update",
  "session_id": "uuid",
  "round": 1,
  "deadline": "2024-01-01T12:04:00Z",
  "time_remaining": 180, // 剩余秒数
  "warning": true // 是否进入警告时间，如剩余30秒
}
```

#### 5.4.12 回合阶段切换
```javascript
// 服务器推送（回合阶段切换时）
{
  "type": "round_stage_changed",
  "session_id": "uuid",
  "round": 1,
  "stage": "decision" | "review" | "inference" | "result",
  "message": "决策阶段已结束，进入审核阶段"
}
```

#### 5.4.13 推演开始/完成通知
```javascript
// 服务器推送（推演开始时）
{
  "type": "inference_started",
  "session_id": "uuid",
  "round": 1,
  "estimated_time": 30 // 预估时间（秒）
}

// 服务器推送（推演完成时）
{
  "type": "inference_completed",
  "session_id": "uuid",
  "round": 1,
  "narrative": "你向敌人A发起了攻击...",
  "results": [...]
}
```

#### 5.4.14 聊天消息
```javascript
// 服务器推送（玩家发送聊天消息时）
{
  "type": "chat_message",
  "session_id": "uuid",
  "user_id": "uuid",
  "player_name": "玩家1",
  "message": "大家好！",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

#### 5.4.23 公开声明通知
```javascript
// 服务器推送（玩家发布公开声明时，推送给所有玩家）
{
  "type": "public_statement",
  "session_id": "uuid",
  "round": 1,
  "statement_id": "uuid",
  "player_index": 1,
  "player_name": "玩家1",
  "player_avatar": "url",
  "content": "我宣布将全力支持玩家2的行动！",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

#### 5.4.15 交易请求通知
```javascript
// 服务器推送（收到交易请求时）
{
  "type": "trade_request",
  "session_id": "uuid",
  "trade_id": "uuid",
  "initiator": "玩家1",
  "target": "玩家2",
  "resources": {...},
  "request_resources": {...}
}
```

#### 5.4.16 交易状态更新
```javascript
// 服务器推送（交易状态变化时）
{
  "type": "trade_status_update",
  "session_id": "uuid",
  "trade_id": "uuid",
  "status": "accepted" | "rejected" | "completed" | "expired",
  "message": "交易已接受"
}
```

#### 5.4.17 任务更新通知
```javascript
// 服务器推送（任务状态变化时）
{
  "type": "task_update",
  "session_id": "uuid",
  "task_id": "uuid",
  "task_type": "collect",
  "status": "active" | "completed" | "failed",
  "progress": {
    "current": 60,
    "target": 100
  },
  "message": "任务进度已更新"
}
```

#### 5.4.18 多回合事件进度更新
```javascript
// 服务器推送（多回合事件进度更新时）
{
  "type": "multi_round_event_progress",
  "session_id": "uuid",
  "event_id": "uuid",
  "round": 2,
  "event_content": "突然发生地震...",
  "progress": {
    "current": 50,
    "target": 100,
    "progress_percentage": 50,
    "status": "active",
    "description": "事件进展到一半，地震强度减弱",
    "last_updated_round": 2
  },
  "progress_history": [
    {
      "round": 1,
      "progress": 0,
      "description": "事件开始",
      "updated_at": "2024-01-01T12:00:00Z"
    },
    {
      "round": 2,
      "progress": 50,
      "description": "事件进展到一半",
      "updated_at": "2024-01-01T12:05:00Z"
    }
  ]
}
```

#### 5.4.19 多回合事件完成/失败通知
```javascript
// 服务器推送（多回合事件完成或失败时）
{
  "type": "multi_round_event_completed",
  "session_id": "uuid",
  "event_id": "uuid",
  "round": 3,
  "event_content": "突然发生地震...",
  "status": "completed" | "failed",
  "final_progress": {
    "current": 100,
    "target": 100,
    "progress_percentage": 100
  },
  "message": "多回合事件已完成" | "多回合事件已失败（超时）"
}
```

#### 5.4.20 合作申请请求通知
```javascript
// 服务器推送（收到合作申请时）
{
  "type": "cooperation_request",
  "session_id": "uuid",
  "cooperation_id": "uuid",
  "initiator": "玩家1",
  "target": "玩家2",
  "cooperation_type": "resource" | "action" | "strategy",
  "cooperation_content": "...",
  "conditions": "...",
  "expected_benefits": "...",
  "created_at": "2024-01-01T12:00:00Z",
  "expires_at": "2024-01-01T12:05:00Z"
}
```

#### 5.4.21 合作申请状态更新
```javascript
// 服务器推送（合作申请状态变化时）
{
  "type": "cooperation_status_update",
  "session_id": "uuid",
  "cooperation_id": "uuid",
  "status": "accepted" | "rejected" | "negotiating" | "expired" | "cancelled",
  "message": "合作申请已接受" | "合作申请已拒绝" | "进入谈判模式" | "合作申请已过期" | "合作申请已取消"
}
```

#### 5.4.22 合作申请谈判通知
```javascript
// 服务器推送（收到谈判内容时）
{
  "type": "cooperation_negotiation",
  "session_id": "uuid",
  "cooperation_id": "uuid",
  "negotiation_round": 2,
  "sender": "玩家2",
  "cooperation_content": "...", // 重新编辑的合作内容
  "conditions": "...",
  "expected_benefits": "...",
  "modification_reason": "...", // 修改说明
  "created_at": "2024-01-01T12:02:00Z"
}
```

#### 5.4.24 决策选项生成完成通知
```javascript
// 服务器推送（决策选项生成完成时）
{
  "type": "decision_options_ready",
  "session_id": "uuid",
  "round": 1,
  "options": [
    {
      "option_id": "uuid1",
      "text": "攻击敌人A",
      "expected_effect": "可能造成15点伤害",
      "category": "attack"
    },
    ...
  ],
  "generated_at": "2024-01-01T12:00:00Z"
}
```

#### 5.4.25 成就解锁通知
```javascript
// 服务器推送（玩家解锁成就时）
{
  "type": "achievement_unlocked",
  "session_id": "uuid",
  "player_index": 1,
  "player_name": "玩家1",
  "achievement": {
    "achievement_id": "uuid",
    "name": "百万富翁",
    "description": "累计获得1000金币",
    "icon": "url",
    "type": "resource",
    "rarity": "common",
    "round_unlocked": 5
  },
  "unlocked_at": "2024-01-01T12:00:00Z"
}
```
注意：成就解锁通知推送给所有玩家，增加游戏趣味性

#### 5.4.26 大事纪记录通知
```javascript
// 服务器推送（记录大事纪时）
{
  "type": "milestone_recorded",
  "session_id": "uuid",
  "milestone": {
    "milestone_id": "uuid",
    "round": 5,
    "type": "trade",
    "title": "重大交易达成",
    "description": "玩家1与玩家2达成1000金币的交易",
    "importance": "high",
    "participants": [1, 2],
    "timestamp": "2024-01-01T12:00:00Z"
  }
}
```
注意：大事纪通知推送给所有玩家，重要事件高亮显示
```

## 6. AI集成需求

### 6.1 AI模型选择
- **默认方案**：DeepSeek API（主持人可配置）
- **推荐方案1**：OpenAI GPT-4 / GPT-3.5-turbo
- **推荐方案2**：本地部署LLM（如Llama 2, ChatGLM等）
- **推荐方案3**：自定义API端点（主持人可配置）
- **配置来源**：使用主持人初始化设定中配置的API信息

### 6.1.1 AI API配置使用
- 系统从主持人配置中读取API配置
- 根据配置的endpoint、method、headers、request_body_template构建请求
- 支持动态切换AI服务提供商
- 支持自定义请求格式和参数

### 6.2 AI Prompt设计

#### 6.2.0 决策选项生成Prompt
```
{game_rules}  // 主持人配置的游戏规则

当前游戏状态：
{game_state}

玩家信息：
- 玩家索引：{player_index}
- 玩家名称：{player_name}
- 当前资源：{resources}
- 当前属性：{attributes}
- 当前排名：{ranking}
- 最近决策：{recent_decisions}

其他玩家状态：
{other_players_state}

活跃的多回合事件：
{active_multi_round_events}

请为玩家{player_index}生成3个最相关的决策选项。要求：
1. 选项要基于当前游戏状态，具有可行性和相关性
2. 选项要多样化，涵盖不同的策略方向（攻击/防御/合作/探索/交易等）
3. 每个选项包含：
   - 选项文本（简洁明了，10-20字）
   - 预期效果提示（说明该选项可能带来的效果）
   - 选项类别（attack/defense/cooperation/explore/trade）
4. 选项要符合游戏规则，不能包含非法操作
5. 选项要考虑玩家的当前状态和资源情况

请返回JSON格式：
{
  "options": [
    {
      "text": "选项文本",
      "expected_effect": "预期效果提示",
      "category": "attack" | "defense" | "cooperation" | "explore" | "trade"
    },
    ...
  ]
}
```

注意：
1. 此Prompt用于批量生成所有玩家的决策选项
2. 可以一次性为所有玩家生成，减少API调用次数
3. 选项生成失败时，玩家可使用自由输入

#### 6.2.1 游戏场景初始化Prompt
```
{game_rules}  // 主持人配置的游戏规则

当前游戏场景：
- 游戏模式：{game_mode}
- 决策主体数量：{total_decision_entities}
- 人类玩家数量：{human_player_count}
- AI玩家数量：{ai_player_count}
- 当前回合：{round}

请生成一个初始游戏场景描述，包括：
1. 场景背景设定
2. 玩家初始状态
3. 可用的行动选项提示

要求：场景要有竞争性和策略性，适合多人博弈。
```

#### 6.2.2 玩家操作推演Prompt
```
{game_rules}  // 主持人配置的游戏规则

当前游戏状态：
{game_state}

活跃的多回合事件（需要特别关注）：
{active_multi_round_events}
每个事件包含：
- 事件内容：{event_content}
- 当前进度：{current_progress}/{target_progress} ({progress_percentage}%)
- 事件状态：{status}
- 进度历史：{progress_history}
- 最后更新回合：{last_updated_round}

重要提醒：如果存在多回合事件，必须在推演中考虑这些事件的当前进度，并在剧情中体现事件的发展状态。每回合都要更新事件进度，确保事件线程不会丢失。

本轮达成的合作事件（重要，作为决策的一部分）：
{round_cooperations}
每个合作事件包含：
- 合作双方：{initiator} 和 {target}
- 合作类型：{cooperation_type}（资源合作/行动合作/策略合作等）
- 合作内容：{cooperation_content}
- 合作条件/要求：{conditions}
- 预期收益：{expected_benefits}
- 谈判轮次：{negotiation_round}（如果经过谈判）
- 主持人修改状态：{status}（原始/已修改）
- 主持人修改说明：{modification_reason}（如果已修改）

重要提醒：合作事件是玩家之间达成的合作协议，也是本回合的重要决策。必须在推演中：
1. 考虑合作事件对游戏状态的影响
2. 推演合作执行的可行性
3. 评估合作双方的收益
4. 在剧情中体现合作的内容和执行情况
5. 如果合作涉及资源交换，需要更新相关玩家的资源状态
6. 如果合作涉及行动协调，需要在剧情中体现协同行动的效果

玩家操作：
- 玩家ID：{user_id}
- 玩家索引：{player_index}
- 选中的选项（如有）：
  {selected_options}
  每个选项包含：
  - 选项文本：{option_text}
  - 选项类别：{option_category}
  - 预期效果：{expected_effect}
- 自定义文本（如有）：{custom_text}
- 选项组合建议（如有）：{combination_suggestion}
- 操作内容（最终）：{action_text}（由选项和自定义文本组合而成，或主持人修改后的内容）
- 当前回合：{round}
注意：
1. 如果玩家选择了选项，操作内容应基于选项进行推演
2. 如果玩家同时提供了选项和自定义文本，需要综合考虑
3. 如果主持人修改了决策，使用修改后的内容进行推演
4. 多个选项组合时，需要考虑组合的合理性和可行性

请根据上述游戏规则和当前状态，推演该操作的结果：
1. 操作是否合法
2. 操作成功概率
3. 操作结果描述（成功/失败/部分成功）
4. 对游戏状态的影响
5. 对多回合事件进度的影响（如有）
6. 对合作事件的影响（如有，考虑操作是否影响合作的执行）
7. 生成一段生动的剧情描述

要求：
- 严格遵循游戏规则
- 结果要符合游戏逻辑
- 剧情要有趣味性
- 考虑其他玩家的影响
- 如果存在多回合事件，必须在推演中体现事件进度，并更新事件状态
- 如果存在合作事件，必须在推演中体现合作的内容和执行情况
```

#### 6.2.3 回合总结Prompt
```
当前回合所有玩家操作：
{all_actions}

请生成：
1. 回合总结描述
2. 玩家排名变化
3. 下一回合的提示
```

### 6.3 AI调用策略

#### 6.3.1 异步处理
- 玩家操作提交后，立即返回"处理中"状态
- AI推演在后台异步执行
- 完成后通过WebSocket推送结果

#### 6.3.2 任务队列
- 使用消息队列（RabbitMQ/Redis）管理AI任务
- 支持任务优先级（紧急操作优先）
- 支持任务重试机制

#### 6.3.3 缓存策略
- 相似操作结果缓存（减少AI调用）
- 场景模板缓存
- 常用剧情片段缓存

#### 6.3.4 成本控制
- 限制每个会话的AI调用频率
- 使用流式响应（Streaming）提升体验
- 批量处理相似操作

### 6.4 AI响应数据结构
```json
{
  "valid": true,
  "success_probability": 0.85,
  "result": "success",
  "narrative": "你成功攻击了敌人A，造成15点伤害...",
  "effects": {
    "damage": 15,
    "enemy_health": 85,
    "player_energy": -10
  },
  "game_state_changes": {
    "enemies": [...],
    "players": [...]
  },
  "next_actions_hint": ["你可以继续攻击", "或者选择防御"]
}
```

## 7. 实时同步机制

### 7.1 状态同步策略
- **全量同步**：游戏初始化时发送完整状态
- **增量同步**：游戏进行中只同步变化部分
- **定时同步**：每N秒发送一次完整状态（防止不一致）
- **事件驱动**：关键事件立即同步

### 7.2 冲突处理
- **操作锁机制**：同一回合同一玩家只能提交一次操作
- **时间戳验证**：操作必须基于最新游戏状态
- **状态版本号**：每次状态更新递增版本号
- **冲突回滚**：检测到冲突时回滚到上一个稳定状态

### 7.3 断线重连
- 客户端断线检测（心跳机制）
- 重连后自动同步最新游戏状态
- 保留玩家操作队列（断线期间的操作）
- 自动重试机制

### 7.4 消息顺序保证
- 使用消息序列号确保顺序
- 客户端缓存未确认消息
- 服务器确认机制

## 8. 安全性要求

### 8.1 认证与授权
- JWT Token认证
- Token刷新机制
- 权限验证（房间创建者权限等）
- API限流（防止滥用）

### 8.2 数据安全
- 密码加密存储（bcrypt/argon2）
- 敏感数据加密传输（HTTPS/WSS）
- SQL注入防护
- XSS防护

### 8.3 游戏安全
- 操作合法性验证
- 防作弊机制（操作频率限制、异常检测）
- 游戏状态校验
- 日志记录（审计追踪）

### 8.4 系统安全
- DDoS防护
- 资源限制（防止资源耗尽）
- 输入验证与清理
- 错误信息脱敏

## 9. 性能要求

### 9.1 响应时间
- API响应时间：< 200ms（非AI操作）
- AI推演响应时间：< 5s（可接受范围）
- WebSocket消息延迟：< 100ms
- 数据库查询：< 50ms

### 9.2 并发能力
- 支持同时在线用户：1000+
- 支持同时游戏房间：100+
- 支持单房间最大玩家：10人
- WebSocket连接数：1000+

### 9.3 可扩展性
- 水平扩展支持（多服务器部署）
- 数据库读写分离
- 缓存层优化
- 负载均衡

### 9.4 资源使用
- 内存使用：< 2GB/服务器实例
- CPU使用：< 70%（正常负载）
- 数据库连接池：合理配置
- AI API调用：控制频率和成本

## 10. 监控与日志

### 10.1 日志系统
- **访问日志**：记录所有API请求
- **错误日志**：记录系统错误和异常
- **游戏日志**：记录游戏操作和状态变化
- **AI日志**：记录AI调用和响应
- **性能日志**：记录响应时间和资源使用

### 10.2 监控指标
- 服务器CPU、内存、磁盘使用率
- 数据库连接数和查询性能
- WebSocket连接数和消息吞吐量
- AI API调用次数和响应时间
- 游戏房间数和在线玩家数
- 错误率和异常情况

### 10.3 告警机制
- 服务器资源告警（CPU/内存过高）
- 数据库性能告警
- AI服务异常告警
- 错误率告警
- 玩家投诉处理

## 11. 部署要求

### 11.1 环境要求
- **开发环境**：本地开发，支持热重载
- **测试环境**：独立测试服务器
- **生产环境**：高可用部署，负载均衡

### 11.2 容器化部署
- Docker镜像构建
- Docker Compose编排
- 环境变量配置
- 健康检查配置

### 11.3 数据库部署
- PostgreSQL主从复制
- Redis集群部署
- 数据备份策略
- 数据恢复方案

### 11.4 CI/CD流程
- 代码提交触发构建
- 自动化测试
- 自动化部署
- 回滚机制

## 12. 开发计划建议

### 12.1 第一阶段：基础功能（2-3周）
- 用户系统（注册、登录）
- 房间系统（创建、加入、离开）
- 基础WebSocket通信
- 数据库设计实现

### 12.2 第二阶段：游戏核心（3-4周）
- 游戏状态管理
- 玩家操作处理
- 基础AI集成（简单规则引擎）
- 实时同步机制

### 12.3 第三阶段：AI增强（2-3周）
- 完整AI推演引擎
- 剧情生成优化
- AI响应缓存
- Prompt工程优化

### 12.4 第四阶段：优化与完善（2-3周）
- 性能优化
- 安全性加固
- 监控与日志
- 测试与修复

## 13. 风险评估

### 13.1 技术风险
- **AI API稳定性**：依赖第三方AI服务，需要降级方案
- **实时同步复杂度**：多人同步可能出现状态不一致
- **性能瓶颈**：AI调用可能成为性能瓶颈

### 13.2 业务风险
- **游戏平衡性**：AI生成的剧情可能不平衡
- **用户体验**：AI响应时间可能影响体验
- **成本控制**：AI API调用成本可能较高

### 13.3 应对措施
- 实现本地规则引擎作为AI降级方案
- 完善状态同步和冲突处理机制
- 优化AI调用策略，使用缓存和批量处理
- 建立游戏平衡性测试流程
- 实现流式响应提升用户体验
- 设置AI调用预算和监控

## 14. 附录

### 14.1 术语表
- **游戏会话（Game Session）**：一次完整的游戏过程
- **回合（Round）**：游戏中的一个时间单位，所有玩家完成操作后进入下一回合
- **游戏状态（Game State）**：当前游戏的完整状态信息
- **AI推演**：使用AI模型根据玩家操作生成剧情和结果

### 14.2 参考资源
- WebSocket协议规范
- JWT认证最佳实践
- AI Prompt工程指南
- 游戏服务器架构设计模式

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护者**：开发团队

