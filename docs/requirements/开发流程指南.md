# AI文字交互式游戏开发流程指南

## 开发原则
1. **自底向上**：先开发基础功能，再开发依赖功能
2. **可测试性**：每个阶段都要能独立测试
3. **迭代开发**：先实现核心功能，再完善细节
4. **前后端并行**：前后端可同时开发，通过API对接

> 进度与验收：
> - 阶段1（基础搭建）：通过（脚本 `各阶段测试用/全阶段共同测试/test-phase1-2.ps1`）
> - 阶段2（用户认证）：通过（同上脚本）
> - 阶段3（房间系统基础）：通过（脚本 `各阶段测试用/全阶段共同测试/test-phase1-3.ps1` 串联调用 `已完成3阶段测试/test-phase3.ps1`）
> - 阶段4（WebSocket 实时通信基础 - 最小实时子系统）：通过（脚本 `各阶段测试用/4阶段测试/test-phase4.ps1`）

---

> 当前状态：前三阶段已完成并通过联合脚本 `各阶段测试用/全阶段共同测试/test-phase1-3.ps1`；未授权 500 已修复为 401。进入第四阶段（WebSocket 实时通信基础）筹备。

## 第一阶段：项目基础搭建（1-2周）

### 1.1 后端项目初始化
- [x] 选择技术栈（Node.js/Python）
- [x] 初始化项目结构
- [x] 配置开发环境（ESLint、Prettier等）
- [x] 配置数据库（PostgreSQL + Redis）
- [x] 配置Docker开发环境
- [ ] 设置CI/CD基础流程

### 1.2 前端项目初始化
- [x] 选择技术栈（React/Vue）
- [x] 初始化项目结构
- [x] 配置开发环境（ESLint、Prettier、TypeScript）
- [x] 配置构建工具（Vite/Webpack）
- [x] 配置路由系统
- [x] 配置状态管理（Redux/Zustand）

### 1.3 基础工具和配置
- [x] 配置API客户端（Axios）
- [x] 配置环境变量管理
- [x] 配置日志系统
- [x] 配置错误处理机制
- [x] 编写基础工具函数

---

## 第二阶段：用户认证系统（1周）

### 2.1 后端开发
- [x] 设计用户表结构
- [x] 实现用户注册API（POST /api/auth/register）
- [x] 实现用户登录API（POST /api/auth/login）
- [x] 实现JWT Token生成和验证
- [x] 实现获取用户信息API（GET /api/user/info）
- [x] 实现更新用户信息API（PUT /api/user/info）
- [x] 实现上传头像API（POST /api/user/avatar）
- [x] 实现忘记密码API（POST /api/auth/forgot-password）
- [x] 实现重置密码API（POST /api/auth/reset-password）
- [x] 实现Token刷新机制
- [ ] 编写单元测试

### 2.2 前端开发
- [x] 设计登录页面UI
- [x] 设计注册页面UI
- [x] 实现登录功能组件
- [x] 实现注册功能组件
- [x] 实现Token管理（localStorage）
- [x] 实现请求拦截器（自动添加Token）
- [x] 实现响应拦截器（Token过期处理）
- [x] 实现路由守卫（未登录跳转）
- [ ] 编写组件测试

### 2.3 联调测试
- [x] 测试注册流程
- [x] 测试登录流程
- [x] 测试Token刷新
- [x] 测试Token过期处理
- [x] 测试用户信息更新

---

## 第三阶段：房间系统基础（1-2周）

> 交付目标：最小可用的房间流转（创建 / 列表 / 加入 / 离开）、房间基础信息展示、房间成员变更的实时广播，确保后续初始化设定与游戏逻辑可在此基础上扩展。验收使用 `第三阶段测试/test-phase3.ps1`。

### 3.1 后端开发
- [x] 设计房间表结构（rooms / room_players，最小字段即可落库）
- [x] 实现创建房间API（POST `/api/rooms/create`，返回房间ID和基本信息）
- [x] 实现获取房间列表API（GET `/api/rooms/list`，支持分页/状态筛选，可先返回全部）
  - [x] 默认仅返回活跃房间（waiting/playing），支持按状态筛选与查看全部/历史
- [x] 实现加入房间API（POST `/api/rooms/{room_id}/join`，校验人数上限/密码可选）
- [x] 实现离开房间API（POST `/api/rooms/{room_id}/leave`，房主离开后的主持人转移可暂忽略）
  - [x] 实现关闭房间API（POST `/api/rooms/{room_id}/close`，软删除，由房主将房间标记为已关闭并从默认列表隐藏）
- [ ] 实现房间状态管理（可选：将活跃房间状态缓存到 Redis，加速列表与重连）
- [x] 实现房间玩家关系管理（room_players 表，role/status 基础字段）
- [x] WebSocket：广播 `player_joined` / `player_left` / `system_message` 给房间成员（可用 Socket.io）
- [ ] Socket 目录结构预留：`socket/roomHandler.ts` 挂载 join/leave 消息路由（符合“必须采纳”架构）
- [ ] 编写最小单元/集成测试（接口 201/200/401/403/404 场景）

### 3.2 前端开发
- [x] 设计房间列表页面UI（状态/人数/模式/密码标记）
- [x] 设计创建房间页面UI（名称/人数上限/模式/密码可选）
- [x] 设计房间等待页面UI（房间信息、玩家列表、准备/踢人按钮预留，已上线最小版 `/rooms/:roomId/wait`）
- [x] 实现房间列表组件（调用 `/api/rooms/list`，分页可先简化）
- [x] 实现创建房间表单组件（调用 `/api/rooms/create`，成功后跳转等待页）
- [x] 实现房间卡片组件（显示状态、人数、房主）
  - [x] 支持房主在房间列表中关闭房间（调用 `/api/rooms/{room_id}/close`，关闭后默认不再展示）
- [x] 全局滚动体验：body/root 保持可滚动，避免全屏居中导致无法滚轮浏览
- [ ] 实现房间筛选功能（可先支持状态）
- [ ] 实现分页功能（可简化为“加载更多”）
- [x] WebSocket：订阅 `player_joined` / `player_left` / `system_message`，在等待页实时刷新（当前列表页订阅并刷新）
- [ ] 编写组件测试（列表渲染、创建表单校验、等待页成员变更）

### 3.3 联调测试
- [x] 测试创建房间
- [x] 测试房间列表查询
- [x] 测试加入/离开房间（含人数上限、密码错误等异常）
- [x] 测试房间状态更新（WebSocket 广播 player_joined/player_left）
- [x] 运行 `重新打造/各阶段测试用/第三阶段测试/test-phase3.ps1` 并记录结果；`test-phase1-3.ps1` 联合通过

---

## 第四阶段：WebSocket实时通信基础（1周）

> 目标：先实现“最小可用”实时子系统（Socket.io + Redis 房间状态），覆盖房间列表/等待页的核心实时能力，其余高级消息类型与完整断线重连机制留待后续阶段迭代。

### 4.1 后端开发
- [x] 配置WebSocket服务器（Socket.io）（`backend/src/server.ts` + `backend/src/socket/index.ts`）
- [x] 实现WebSocket连接管理（连接/断开日志、统一入口）
- [x] 实现连接认证（Token验证，`socket.handshake.auth.token` / `Authorization`）
- [x] 实现心跳检测机制（Socket.io 内建心跳 + disconnect 事件清理房间状态；支持前端 heartbeat 事件）
- [x] 实现自动重连机制（支持 `rejoin_rooms`，重连后自动 re-join 并推送最新 game_state_update）
- [x] **Socket处理器目录结构**（必须采纳，房间/游戏/消息处理器齐备）
  - [x] 创建 `backend/src/socket/` 目录
  - [x] 实现 `roomHandlers.ts` - 处理房间加入/离开/匹配逻辑，支持 ack
  - [x] 实现 `gameHandler.ts` - 回合阶段/决策状态/推演开始结束广播，支持会话快照
  - [x] 实现 `messageHandler.ts` - 房间 chat_message 路由和广播
  - [x] 实现 `index.ts` - Socket.io初始化，注册所有处理器，断线清理与重连
- [x] **Redis房间状态管理**（完成：房间在线玩家列表 + 基础状态 + version；会话状态快照 session:{session_id}:state）
  - [x] 扩展 `backend/src/services/roomStateService.ts`，添加房间/会话状态管理函数
  - [x] 实现房间状态存储（`room:{room_id}:players` / `room:{room_id}:state.status` / `version`）
  - [x] 实现游戏会话状态存储（`session:{session_id}:state` + version）
  - [x] 实现断线重连快照恢复机制（会话状态 session_state / 房间状态 game_state_update）
- [x] **后端驱动状态同步**（完成：房间成员变更与会话阶段变更由后端计算并广播，带版本号）
  - [x] 确保状态变更在后端计算并广播
  - [x] 前端仅发送动作，后端计算后广播
  - [x] 实现状态版本控制（房间状态 version，会话 state version）
- [x] **断线重连机制**（完成：连接断开检测 + Redis 在线状态清理 + 重连 rejoin）
  - [x] 实现连接断开检测
  - [x] 实现Redis快照保存（游戏状态/会话状态快照）
  - [x] 实现重连后状态恢复（从Redis读取快照并推送）
  - [x] 实现操作队列预留（通过 version/ack 保障一致性）
- [x] **Socket.io Acknowledgments机制**（完成：join/leave/chat/round_stage/decision_status 等关键消息支持 ack）
  - [x] 关键消息使用acknowledgments确认接收
  - [x] 实现消息重传机制（依赖客户端重连后 rejoin + state 重新推送，ack 兜底）
- [x] 实现基础消息类型（全部完成）：
  - [x] `player_joined` - 玩家加入
  - [x] `player_left` - 玩家离开
  - [x] `game_state_update` - 游戏状态更新
  - [x] `error` - 错误消息
  - [x] `system_message` - 系统消息
  - [x] `decision_submitted` - 决策提交通知
  - [x] `decision_status_update` - 决策状态更新
  - [x] `decision_deadline_update` - 决策时限更新
  - [x] `round_stage_changed` - 回合阶段切换
  - [x] `inference_started` - 推演开始通知
  - [x] `inference_completed` - 推演完成通知
  - [x] `decision_options_ready` - 决策选项生成完成通知
  - [x] `achievement_unlocked` - 成就解锁通知
  - [x] `milestone_recorded` - 大事纪记录通知
  - [x] `public_statement` - 公开声明通知
  - [x] `chat_message` - 聊天消息
  - [x] `trade_request` / `trade_status_update` - 交易相关
  - [x] `cooperation_request` / `cooperation_status_update` / `cooperation_negotiation` - 合作申请相关
  - [x] `task_update` - 任务更新
  - [x] `multi_round_event_progress` / `multi_round_event_completed` - 多回合事件相关
- [ ] 编写单元测试

### 4.2 前端开发
- [x] 封装WebSocket服务类（完整版完成：`wsService` 封装 + 自动重连/重试 + ack 支持 + rejoin_rooms/session_sync 追帧）
- [x] 实现WebSocket连接管理（完整版完成：Rooms / WaitingRoom 使用 `useSocket` 展示连接状态，登录状态变化自动连接/断开）
- [x] 实现消息类型路由处理（完整版完成：`useMessageRouter` 订阅并提示/日志所有后端定义的消息类型）
  - [x] `decision_options_ready` - 决策选项生成完成通知
  - [x] `achievement_unlocked` - 成就解锁通知
  - [x] `milestone_recorded` - 大事纪记录通知
  - [x] 其他所有后端定义的消息类型（trade/cooperation/task/multi_round_event/public_statement 等）
- [x] 实现连接状态显示（完整版完成：Rooms / WaitingRoom 页头 Tag 显示 WebSocket 连接状态）
- [x] 实现自动重连功能（完整版完成：Socket.io 内建重连 + wsService 持久 room 列表重入与会话同步）
- [x] 实现心跳检测（完整版完成：前端周期性发送 `heartbeat`，后端 disconnect/日志配合）
- [x] **实现Socket.io Acknowledgments处理**（完整版完成：wsService.sendWithAck + 关键消息 emit 带 ack，重连后通过 rejoin/state 重推）
  - [x] 关键消息使用acknowledgments确认接收
  - [x] 实现消息重传机制（通过重连 rejoin + state/snapshot 重推兜底）
- [x] **前端Hooks层封装**（最小子集完成：`useSocket` 管理连接状态，`useMessageRouter` 统一消息路由；[ ] 完整版待做：`useGameLoop` / `useRoom` / `useGameState` 细分逻辑）
- [ ] **组件拆分优化**（建议采纳）
  - [ ] 将GameBoard（游戏主面板）与Sidebar（侧边栏）分离
  - [ ] 使用React.memo优化组件渲染
  - [ ] 实现状态隔离，避免频繁Socket更新导致整页重绘
- [ ] 编写组件测试

### 4.3 联调测试
- [x] 测试WebSocket连接建立（最小自测：Rooms/WaitingRoom 连接与状态标签验证，lint 通过）
- [x] 测试消息推送和接收（最小自测：全消息路由订阅并提示/日志，chat/system/round_stage 等验证）
- [ ] 测试断线重连（需多端实机验证 socket.io 重连 + rejoin_rooms + session_sync）
- [ ] 测试多客户端同步（需两端并发校验玩家进出与状态广播）

---

## 第五阶段：主持人初始化设定（1-2周）

### 5.1 后端开发
- [x] 设计主持人配置表结构（Prisma `host_configurations` 含 API/provider/headers/bodyTemplate/规则/人数/时限/超时策略/完成标记）
- [x] 实现获取主持人配置API（GET /api/rooms/{room_id}/host-config）
- [x] 实现保存API配置API（POST /api/rooms/{room_id}/host-config/api）
- [x] 实现保存游戏规则API（POST /api/rooms/{room_id}/host-config/rules）
- [x] 实现保存玩家配置API（POST /api/rooms/{room_id}/host-config/players）
  - [x] 包含决策时限配置
  - [x] 包含超时处理策略配置
- [x] 实现完成初始化API（POST /api/rooms/{room_id}/host-config/complete）
- [x] 实现配置验证API（POST /api/rooms/{room_id}/host-config/validate）
- [x] 实现主持人权限验证（仅房主可操作）
- [ ] 编写单元测试

### 5.2 前端开发
- [x] 设计主持人初始化设定页面UI（新页 `/rooms/:roomId/host-setup`，房主可见入口）
- [x] 实现步骤导航组件（Steps：API 配置 / 规则&玩家 / 验证 / 完成）
- [x] 实现API配置表单组件
  - [x] 提供商选择
  - [x] 端点配置
  - [x] 请求头编辑器（JSON）
  - [x] 请求体模板编辑器（JSON）
  - [ ] API连接测试功能
- [x] 实现游戏规则编辑器组件（使用 TextArea，支持 Markdown 文本）
- [x] 实现玩家配置组件
  - [x] 决策主体数设置
  - [x] 人类玩家数设置
  - [x] 决策时限设置
  - [x] 超时处理策略选择
- [x] 实现配置保存功能（分步保存 API / 规则 / 玩家）
- [x] 实现配置验证功能（验证通过、完成配置）
- [ ] 编写组件测试

### 5.3 联调测试
- [x] 测试API配置保存和加载（脚本 `各阶段测试用/5阶段测试/test-phase5.ps1`）
- [x] 测试游戏规则保存和加载（同上）
- [x] 测试玩家配置保存和加载（同上）
- [x] 测试配置验证（同上）
- [x] 测试完成初始化流程（同上；联合脚本 `test-phase1-5.ps1` 通过）

---

## 第六阶段：游戏核心机制 - 决策流程（2-3周）

### 6.1 后端开发
- [x] 设计游戏会话表结构
- [x] 设计玩家操作记录表结构
- [x] 实现开始游戏API（POST /api/game/{room_id}/start）
- [ ] 实现游戏初始化逻辑
  - [ ] 根据玩家位数创建决策主体
  - [ ] 初始化游戏状态
  - [x] 设置决策时限
- [x] 实现提交决策API（POST /api/game/{session_id}/decision）
- [x] 实现获取决策状态API（GET /api/game/{session_id}/round/{round}/decisions）
- [ ] 实现决策时限管理（定时器）
- [ ] 实现超时处理逻辑
- [ ] 实现回合阶段管理（决策/审核/推演/结果）
- [ ] 编写单元测试

### 6.2 前端开发
- [x] 设计游戏主界面布局
- [x] 实现游戏状态栏组件
- [ ] 实现决策倒计时组件
- [x] 实现决策输入组件
- [x] 实现决策状态显示组件
- [ ] 实现玩家信息面板
- [x] 实现决策提交流程
- [x] 实现决策状态实时更新（WebSocket）
- [ ] 编写组件测试

### 6.3 联调测试
- [x] 测试游戏开始流程
- [x] 测试决策提交
- [x] 测试决策状态同步
- [ ] 测试决策时限倒计时
- [ ] 测试超时处理

---

## 第六阶段（第二部分）：管理员工具与首页用户信息（穿插开发，已上线最小版）

管理员工具：在册用户管理 & 在线房间管理 & 首页用户信息展示

### 管理员后端能力
- [x] 扩展用户状态字段（User.status：`active` / `frozen`）
- [x] 登录流程中拦截冻结账号（status === `frozen` 返回 403，提示账号已冻结）
- [x] 提供在册用户列表接口（GET `/api/admin/users`，仅开发者可用）
  - [x] 支持按状态筛选（全部/active/frozen）
  - [x] 返回最近登录时间与当前房间信息（基于未离开房间的 room_players 记录）
- [x] 提供冻结/解冻接口
  - [x] POST `/api/admin/users/{user_id}/freeze` → 将用户状态置为 frozen
  - [x] POST `/api/admin/users/{user_id}/unfreeze` → 将用户状态置为 active
- [x] 提供物理删除接口
  - [x] DELETE `/api/admin/users/{user_id}` → 删除指定用户（当前开发者账号自身禁止删除）
- [x] 管理员权限校验
  - [x] 通过 `ADMIN_USERNAME` 环境变量或默认 `admin` 判断开发者账号
  - [x] 非开发者调用 `/api/admin/*` 返回 403

### 管理员前端能力
- [x] 在游戏首页增加“在册用户”按钮，仅登录用户可见（`Home` 页）
- [x] 实现 `UserRegistryPanel` 抽屉组件
  - [x] 展示字段：用户ID / 用户名 / 昵称 / 状态 / 在线标记 / 所在房间 / 最近登录时间
  - [x] 支持分页与状态筛选（全部/正常/已冻结）
- [x] 开发者密令机制
  - [x] 面板内提供“开发者密令”输入框
  - [x] 输入 `wskfz` 且当前账号为开发者时开启开发者模式（devModeEnabled）
  - [x] 开发者模式下展示冻结/解冻/删除按钮；未开启时仅为只读视图
- [x] 管理操作调用后端接口
  - [x] 冻结用户：调用 `POST /api/admin/users/{user_id}/freeze`，成功后刷新列表
  - [x] 解冻用户：调用 `POST /api/admin/users/{user_id}/unfreeze`，成功后刷新列表
  - [x] 物理删除用户：调用 `DELETE /api/admin/users/{user_id}`，成功后刷新列表

### 在线房间管理扩展
- [x] 后端提供在线房间列表接口（GET `/api/admin/rooms`，仅开发者可用，默认返回 waiting/playing）
- [x] 后端提供房间强制关闭接口（POST `/api/admin/rooms/{room_id}/close`，将房间状态置为 closed 并结束会话）
- [x] 前端在首页增加“在线房间”按钮，打开 `OnlineRoomsPanel` 抽屉组件
  - [x] 展示字段：房间ID / 名称 / 状态 / 人数 / 房主 / 创建时间
  - [x] 支持按状态筛选（活跃/等待/进行/已关闭/全部）
- [x] 在线房间开发者密令
  - [x] 面板内提供“开发者密令”输入框，沿用密令 `wskfz`
  - [x] 仅当当前账号为开发者（用户名=`ADMIN_USERNAME` 或默认“开发者账号”）且密令正确时展示“关闭房间”按钮

### 首页用户信息展示
- [x] 在首页右上角展示当前登录用户信息（优先显示昵称，其次显示用户名）
- [x] 在首页提供“退出登录”按钮，调用前端 `logout` 方法清除 token 与用户状态并返回未登录状态

### 联调与验收
- [x] 使用开发者账号登录（username=ADMIN_USERNAME 或 “开发者账号”），在首页打开“在册用户”面板
- [x] 验证列表数据与后端返回一致（状态/在线/房间信息）
- [x] 验证非开发者账号无法通过密令进入管理模式
- [x] 验证冻结后账号无法再次登录，解冻后恢复正常
- [x] 验证物理删除用户后，在册列表与登录均不可用

---

## 第七阶段：主持人审核功能（1-2周）✅

### 7.1 后端开发
- [x] 实现获取审核决策列表API（GET /api/game/{session_id}/round/{round}/decisions/review）
- [x] 实现决策审核状态管理
- [x] 实现临时事件/规则数据结构
- [x] 实现添加临时事件API（POST /api/game/{session_id}/round/{round}/temporary-event）
- [x] 实现添加临时规则API（POST /api/game/{session_id}/round/{round}/temporary-rule）
- [x] 实现提交给AI推演API（POST /api/game/{session_id}/round/{round}/submit-to-ai）
  - [x] 自动收集活跃的多回合事件及其进度
  - [x] 整合所有决策和事件/规则
- [x] 实现主持人权限验证
- [ ] 编写单元测试

### 7.2 前端开发
- [x] 设计主持人审核界面UI
- [x] 实现决策审核列表组件
- [x] 实现临时事件添加组件
- [x] 实现临时规则添加组件
- [x] 实现提交推演组件
- [ ] 实现配置预览功能
- [ ] 编写组件测试

### 7.3 联调测试
- [x] 测试决策审核流程
- [x] 测试临时事件/规则添加
- [x] 测试提交给AI推演

---

## 第八阶段：AI推演引擎集成（2-3周）✅

### 8.1 后端开发
- [x] 实现AI API调用封装
  - [x] 根据主持人配置构建请求
  - [x] 支持多种AI服务提供商
  - [x] 实现请求重试机制
- [x] 实现AI Prompt构建
  - [x] 游戏场景初始化Prompt
  - [x] 玩家操作推演Prompt（包含事件进度）
  - [x] 回合总结Prompt
- [x] 实现AI推演任务队列（使用Redis存储任务）
- [x] 实现异步推演处理
- [x] 实现推演结果解析
- [x] 实现推演进度推送（WebSocket）
- [x] 实现获取推演结果API（GET /api/game/{session_id}/round/{round}/inference-result）
- [ ] 编写单元测试和集成测试

### 8.2 前端开发
- [x] 实现AI剧情展示组件（打字机效果）
- [x] 实现推演进度显示
- [x] 实现推演结果展示
- [x] 实现剧情历史滚动查看
- [ ] 编写组件测试

### 8.3 联调测试
- [x] 测试AI API调用
- [x] 测试Prompt构建
- [x] 测试推演结果展示
- [x] 测试推演进度推送

---

## 第九阶段：多回合事件进度跟踪（1-2周）✅

### 9.1 后端开发
- [x] 完善临时事件表结构（添加progress字段）
- [x] 实现事件进度数据结构
- [x] 实现更新事件进度API（PUT /api/game/{session_id}/events/{event_id}/progress）
- [x] 实现获取活跃事件API（GET /api/game/{session_id}/events/active）
- [x] 实现事件进度自动更新逻辑（推演后更新）
- [x] 实现事件完成/失败判定
- [x] 实现事件进度历史记录
- [x] 在AI推演Prompt中自动包含事件进度
- [x] 实现事件进度WebSocket推送
- [ ] 编写单元测试

### 9.2 前端开发
- [x] 设计多回合事件进度面板UI
- [x] 实现事件进度列表组件
- [x] 实现事件进度条组件
- [x] 实现事件进度详情组件
- [x] 实现进度历史时间线组件
- [x] 实现事件进度更新动画
- [x] 实现事件完成/失败提示
- [ ] 编写组件测试

### 9.3 联调测试
- [x] 测试事件进度创建和更新
- [x] 测试事件进度在AI推演中的包含
- [x] 测试事件进度实时推送
- [x] 测试事件完成判定
- [x] 测试事件线程不丢失

---

## 第十阶段：游戏状态同步和回合管理（1-2周）✅

### 10.1 后端开发
- [x] 实现游戏状态完整管理
- [x] 实现回合切换逻辑
- [x] 实现状态版本控制
- [x] 实现状态冲突处理
- [x] 实现游戏状态WebSocket推送
- [x] 实现回合阶段切换通知
- [x] 实现推演开始/完成通知
- [ ] 编写单元测试

### 10.2 前端开发
- [x] 实现游戏状态实时同步
- [x] 实现回合阶段显示
- [x] 实现回合切换动画
- [x] 实现状态变化动画
- [x] 实现状态持久化（刷新恢复）
- [ ] 编写组件测试

### 10.3 联调测试
- [x] 测试游戏状态同步
- [x] 测试回合切换
- [x] 测试状态冲突处理
- [x] 测试断线重连恢复

---

## 第十一阶段：历史记录管理（1周）✅

### 11.1 后端开发
- [x] 设计游戏历史表结构（使用GameSession表）
- [x] 实现获取游戏历史API（GET /api/game/history）
- [x] 实现获取历史详情API（GET /api/game/history/{history_id}）
- [x] 实现删除历史API（DELETE /api/game/history/{history_id}）
- [x] 实现批量删除API（DELETE /api/game/history/batch）
- [x] 实现历史统计API（GET /api/game/history/statistics）
- [x] 实现游戏结束时自动保存历史
- [ ] 编写单元测试

### 11.2 前端开发
- [x] 设计游戏历史页面UI
- [x] 实现历史记录列表组件
- [x] 实现历史筛选组件
- [x] 实现历史详情弹窗组件
- [x] 实现批量删除功能
- [x] 实现历史统计展示
- [ ] 编写组件测试

### 11.3 联调测试
- [x] 测试历史记录查询
- [x] 测试历史详情查看
- [x] 测试历史删除
- [x] 测试历史统计

---

## 第十二阶段：资源交易功能（1周，可选）

### 12.1 后端开发
- [ ] 实现发起交易API（POST /api/game/{session_id}/trade/request）
- [ ] 实现接受/拒绝交易API
- [ ] 实现交易列表API（GET /api/game/{session_id}/trade/list）
- [ ] 实现交易状态管理
- [ ] 实现交易超时处理
- [ ] 实现交易WebSocket通知
- [ ] 编写单元测试

### 12.2 前端开发
- [ ] 设计资源交易UI
- [ ] 实现交易发起组件
- [ ] 实现交易列表组件
- [ ] 实现交易详情组件
- [ ] 编写组件测试

### 12.3 联调测试
- [ ] 测试交易发起和接受
- [ ] 测试交易状态同步

---

## 第十三阶段：游戏存档功能（1周，可选）

### 13.1 后端开发
- [x] 实现保存游戏API（POST /api/game/{session_id}/save）
- [x] 实现获取存档列表API（GET /api/game/{session_id}/saves）
- [x] 实现恢复游戏API（POST /api/game/{session_id}/restore/{save_id}）
- [x] 实现删除存档API（DELETE /api/game/{session_id}/saves/{save_id}）
- [x] 实现自动存档逻辑
- [ ] 编写单元测试

### 13.2 前端开发
- [x] 设计游戏存档UI
- [x] 实现存档列表组件
- [x] 实现保存/恢复功能
- [ ] 编写组件测试

### 13.3 联调测试
- [x] 测试游戏存档和恢复

---

## 第十四阶段：任务/挑战系统（1-2周，可选）

### 14.1 后端开发
- [x] 设计任务表结构
- [x] 实现获取任务列表API（GET /api/game/{session_id}/tasks）
- [x] 实现获取任务详情API（GET /api/game/{session_id}/tasks/{task_id}）
- [x] 实现任务进度跟踪
- [x] 实现任务完成判定
- [x] 实现任务WebSocket通知
- [ ] 编写单元测试

### 14.2 前端开发
- [x] 设计任务面板UI
- [x] 实现任务列表组件
- [x] 实现任务详情组件
- [x] 实现任务进度显示
- [ ] 编写组件测试

### 14.3 联调测试
- [x] 测试任务系统

---

## 第十五阶段：策略分析系统（1周，可选）

### 15.1 后端开发
- [x] 设计策略数据结构
- [x] 实现策略记录逻辑
- [x] 实现策略效果评估
- [x] 实现获取策略列表API（GET /api/user/strategies）
- [x] 实现策略分析API（GET /api/user/strategies/{strategy_id}/analysis）
- [ ] 编写单元测试

### 15.2 前端开发
- [x] 设计策略分析页面UI
- [x] 实现策略列表组件
- [x] 实现策略详情组件
- [x] 实现策略统计图表
- [ ] 编写组件测试

### 15.3 联调测试
- [x] 测试策略分析功能

---

## 第十六阶段：性能优化和测试（1-2周）

### 16.1 后端优化
- [x] 数据库查询优化（添加索引、优化查询）
- [x] Redis缓存优化（推演结果缓存）
- [x] API响应时间优化（异步处理、批量操作）
- [x] WebSocket消息优化（事件驱动）
- [x] AI调用优化（异步处理、错误处理）
- [ ] 负载测试

### 16.2 前端优化
- [x] 代码分割和懒加载（路由懒加载）
- [x] 组件渲染优化（React.memo、useMemo）
- [x] 状态管理优化（Zustand）
- [x] 网络请求优化（请求拦截、错误处理）
- [ ] 性能测试（Lighthouse）

### 16.3 集成测试
- [ ] 端到端测试（E2E）
- [ ] 压力测试
- [ ] 并发测试
- [ ] 异常场景测试

---

## 第十七阶段：安全加固（1周）

### 17.1 后端安全
- [ ] SQL注入防护
- [ ] XSS防护
- [ ] CSRF防护
- [ ] API限流
- [ ] 输入验证和清理
- [ ] 敏感数据加密
- [ ] 安全审计日志

### 17.2 前端安全
- [ ] XSS防护
- [ ] 敏感信息保护
- [ ] 输入验证
- [ ] 安全配置检查

---

## 第十八阶段：部署和监控（1周）

### 18.1 部署准备
- [ ] 配置生产环境
- [ ] Docker镜像构建
- [ ] 数据库迁移脚本
- [ ] 环境变量配置
- [ ] CI/CD流程完善

### 18.2 监控和日志
- [ ] 配置日志收集
- [ ] 配置性能监控
- [ ] 配置错误追踪（Sentry等）
- [ ] 配置告警机制

### 18.3 上线
- [ ] 生产环境部署
- [ ] 功能验证
- [ ] 性能监控
- [ ] 用户反馈收集

---

## 开发建议

### 优先级说明
- **核心功能**（必须）：第一阶段到第十阶段
- **重要功能**（建议）：第十一阶段
- **可选功能**：第十二到第十五阶段（根据项目时间决定）

### 并行开发建议
- 前后端可以并行开发，通过API契约对接
- 先定义好API接口规范，前后端各自开发
- 定期联调，确保接口匹配

### 测试策略
- 每个阶段完成后都要进行单元测试和集成测试
- 关键功能要编写自动化测试
- 定期进行端到端测试

### 版本管理
- 使用Git进行版本控制
- 每个阶段完成后打一个版本标签
- 主分支保持稳定，功能分支开发

---

## 预计总开发时间
- **核心功能**：10-14周
- **完整功能**：14-18周
- **建议团队规模**：3-5人（1-2后端，1-2前端，1全栈）

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护者**：开发团队

