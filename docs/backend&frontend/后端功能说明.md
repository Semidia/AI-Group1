# 后端功能说明文档

本文档详细说明后端 `src/` 目录下所有模块的功能、职责、API 接口和技术实现。

> **项目路径**: `AI-Group1/rebuild/production/backend/src/`

---

## 📋 目录

1. [服务器入口](#服务器入口)
2. [路由模块](#路由模块)
3. [服务层](#服务层)
4. [中间件](#中间件)
5. [WebSocket 处理](#websocket-处理)
6. [工具模块](#工具模块)

---

## 🚀 服务器入口

### `server.ts` - Express 服务器主文件

**功能**:
- 初始化 Express 应用
- 配置中间件（CORS、Helmet、压缩、JSON 解析）
- 初始化 Socket.io 服务器
- 注册所有 API 路由
- 启动 HTTP 服务器
- 确保默认管理员账户存在

**核心配置**:

**CORS 配置**:
- 开发环境：允许所有来源（`origin: '*'`）
- 生产环境：限制为 `allowedOrigins` 列表
- 支持 credentials

**服务器绑定**:
- 绑定到 `0.0.0.0`，允许局域网访问
- 启动时自动检测本机局域网 IP 并输出

**UDP 广播服务**:
- 启动时自动启动 UDP 广播服务
- 每 5 秒向局域网广播服务器信息
- 用于客户端自动发现服务器

**中间件顺序**:
1. Helmet（安全头）
2. Compression（响应压缩）
3. CORS
4. JSON 解析
5. URL 编码解析
6. 静态文件服务（`/uploads`）
7. 健康检查（`/health`，不受限流）
8. 限流中间件
9. API 路由

**Socket.io 配置**:
- 使用与 HTTP 服务器相同的 CORS 配置
- 支持局域网访问
- 初始化 Socket 服务器并注册处理器

**路由注册**:
- `/api/test` - 测试路由
- `/api/auth` - 认证路由
- `/api/user` - 用户路由（包含策略）
- `/api/rooms` - 房间路由
- `/api/game` - 游戏路由
- `/api/trade` - 交易路由
- `/api/tasks` - 任务路由
- `/api/admin` - 管理员路由

**默认管理员账户**:
- 用户名：环境变量 `ADMIN_USERNAME` 或 `'developer'`
- 密码：环境变量 `ADMIN_DEFAULT_PASSWORD` 或 `'000000'`
- 服务器启动时自动创建（如果不存在）

**端口**: 环境变量 `PORT` 或 `3000`

---

## 🛣️ 路由模块

### `routes/auth.ts` - 认证路由

**基础路径**: `/api/auth`

**主要接口**:

#### `POST /api/auth/register` - 用户注册
- **功能**: 注册新用户
- **请求体**: `{ username: string, password: string }`
- **验证**: 用户名 3-50 字符，密码至少 6 字符
- **返回**: `{ code: 201, data: { token, user } }`
- **特性**: 
  - 检查用户名是否已存在
  - 密码使用 bcrypt 加密（10 轮）
  - 自动生成 JWT Token
  - 默认状态为 `active`

#### `POST /api/auth/login` - 用户登录
- **功能**: 用户登录认证
- **请求体**: `{ username: string, password: string }`
- **返回**: `{ code: 200, data: { token, user } }`
- **特性**:
  - 验证用户名和密码
  - 检查账户是否被冻结
  - 更新最后登录时间
  - 生成 JWT Token

#### `POST /api/auth/refresh` - 刷新 Token
- **功能**: 刷新 JWT Token
- **需要认证**: 是
- **返回**: `{ code: 200, data: { token } }`

**技术实现**:
- 使用 `zod` 进行数据验证
- 使用 `bcrypt` 进行密码加密
- 使用 `jsonwebtoken` 生成 JWT
- Token 过期时间：7 天

---

### `routes/user.ts` - 用户路由

**基础路径**: `/api/user`

**主要接口**:

#### `GET /api/user/info` - 获取用户信息
- **功能**: 获取当前登录用户信息
- **需要认证**: 是
- **返回**: 用户信息（id, username, nickname, avatarUrl, level, experience 等）

#### `PUT /api/user/info` - 更新用户信息
- **功能**: 更新用户昵称等信息
- **需要认证**: 是
- **请求体**: `{ nickname?: string }`
- **验证**: 昵称 1-50 字符

#### `POST /api/user/avatar` - 上传头像
- **功能**: 上传用户头像
- **需要认证**: 是
- **请求**: multipart/form-data
- **限制**: 
  - 文件大小：2MB
  - 文件类型：jpeg, jpg, png, gif, webp
- **存储**: `uploads/avatars/` 目录

**技术实现**:
- 使用 `multer` 处理文件上传
- 文件验证（类型、大小）
- 文件路径保存到数据库

---

### `routes/rooms.ts` - 房间路由

**基础路径**: `/api/rooms`

**主要接口**:

#### `GET /api/rooms` - 获取房间列表
- **功能**: 获取房间列表（默认只返回活跃房间）
- **查询参数**: 
  - `status`: 房间状态筛选（可选）
  - `limit`: 限制数量（默认 50）
- **返回**: 房间列表（包含当前人数、房主信息等）

#### `POST /api/rooms` - 创建房间
- **功能**: 创建新房间
- **需要认证**: 是
- **请求体**: `{ name: string, maxPlayers: number, password?: string }`
- **验证**: 
  - 房间名必填
  - 最大人数 2-10
- **返回**: 创建的房间信息

#### `POST /api/rooms/:roomId/join` - 加入房间
- **功能**: 加入指定房间
- **需要认证**: 是
- **路径参数**: `roomId`
- **请求体**: `{ password?: string }`（如果房间有密码）
- **特性**: 
  - 检查房间是否存在、是否已满
  - 验证密码（如果有）
  - 创建 RoomPlayer 记录
  - 通过 WebSocket 广播玩家加入事件

#### `POST /api/rooms/:roomId/leave` - 离开房间
- **功能**: 离开房间
- **需要认证**: 是
- **特性**: 
  - 更新 RoomPlayer 状态为 `left`
  - 通过 WebSocket 广播玩家离开事件

#### `POST /api/rooms/:roomId/close` - 关闭房间
- **功能**: 关闭房间（仅房主）
- **需要认证**: 是
- **权限**: 必须是房主
- **特性**: 更新房间状态为 `closed`

#### `POST /api/rooms/:roomId/kill-game` - 终止游戏
- **功能**: 终止房间中的游戏（仅房主）
- **需要认证**: 是
- **权限**: 必须是房主
- **特性**: 
  - 更新 GameSession 状态为 `finished`
  - 更新房间状态

#### `GET /api/rooms/:roomId/host-config` - 获取主持人配置
- **功能**: 获取房间的主持人配置
- **需要认证**: 是
- **权限**: 必须是房主

#### `PUT /api/rooms/:roomId/host-config/api` - 更新 API 配置
- **功能**: 更新 API 配置（提供商、端点、Headers、Body 模板）
- **需要认证**: 是
- **权限**: 必须是房主

#### `PUT /api/rooms/:roomId/host-config/rules` - 更新游戏规则
- **功能**: 更新游戏规则
- **需要认证**: 是
- **权限**: 必须是房主

#### `PUT /api/rooms/:roomId/host-config/players` - 更新玩家配置
- **功能**: 更新玩家配置（总主体数、人类玩家数、AI 玩家数、决策时限等）
- **需要认证**: 是
- **权限**: 必须是房主

#### `POST /api/rooms/:roomId/host-config/validate` - 验证配置
- **功能**: 标记配置验证通过
- **需要认证**: 是
- **权限**: 必须是房主

#### `POST /api/rooms/:roomId/host-config/complete` - 完成配置
- **功能**: 标记配置完成
- **需要认证**: 是
- **权限**: 必须是房主

---

### `routes/game.ts` - 游戏路由

**基础路径**: `/api/game`

**主要接口**:

#### `POST /api/game/:roomId/start` - 开始游戏
- **功能**: 创建或恢复游戏会话
- **需要认证**: 是
- **权限**: 必须是房主
- **特性**: 
  - 检查主持人配置是否完成
  - 创建或更新 GameSession
  - 设置决策截止时间
  - 通过 WebSocket 广播游戏开始

#### `GET /api/game/:sessionId` - 获取游戏会话信息
- **功能**: 获取游戏会话详细信息
- **需要认证**: 是
- **返回**: 会话信息（包含 hostId）

#### `POST /api/game/:sessionId/decision` - 提交决策
- **功能**: 提交当前回合的决策
- **需要认证**: 是
- **请求体**: 
  - `round`: 回合号（可选，默认当前回合）
  - `actionText`: 决策文本
  - `selectedOptionIds`: 选择的选项 ID（可选）
  - `actionType`: 行动类型（可选）
  - `actionData`: 行动数据（可选）
- **验证**: 
  - 会话必须处于 `playing` 状态
  - 当前阶段必须是 `decision`
  - 未超时
  - 决策内容不能为空
- **特性**: 
  - 支持更新已提交的决策
  - 通过 WebSocket 广播决策状态更新

#### `GET /api/game/:sessionId/round/:round/decisions` - 获取回合决策列表
- **功能**: 获取指定回合的所有决策
- **需要认证**: 是
- **返回**: 决策列表（仅状态，不包含详细内容）

#### `GET /api/game/:sessionId/round/:round/decisions/review` - 获取审核决策列表
- **功能**: 获取审核阶段的决策列表（包含详细内容）
- **需要认证**: 是
- **权限**: 主持人
- **返回**: 决策列表（包含 actionText、选项等详细信息）

#### `GET /api/game/:sessionId/round/:round/decision-options` - 获取 AI 推荐决策选项
- **功能**: 获取 AI 生成的决策选项
- **需要认证**: 是
- **特性**: 
  - 仅在决策阶段可用
  - 调用 AI Service 生成选项
  - 返回 3-4 个推荐选项

#### `POST /api/game/:sessionId/start-review` - 进入审核阶段
- **功能**: 将游戏阶段从 decision 切换到 review
- **需要认证**: 是
- **权限**: 主持人
- **特性**: 通过 WebSocket 广播阶段变化

#### `POST /api/game/:sessionId/round/:round/submit-to-ai` - 提交给 AI 推演
- **功能**: 开始 AI 推演
- **需要认证**: 是
- **权限**: 主持人
- **特性**: 
  - 构建推演请求
  - 调用 AI Service 进行推演
  - 保存推演结果
  - 更新游戏阶段为 `inference` 然后 `result`
  - 通过 WebSocket 广播推演进度和完成事件

#### `GET /api/game/:sessionId/round/:round/inference-result` - 获取推演结果
- **功能**: 获取指定回合的推演结果
- **需要认证**: 是
- **返回**: 推演结果（narrative, outcomes, events, nextRoundHints）

#### `POST /api/game/:sessionId/round/:round/temporary-event` - 添加临时事件
- **功能**: 添加临时事件（单回合或多回合）
- **需要认证**: 是
- **权限**: 主持人
- **请求体**: 
  - `eventType`: `single_round` 或 `multi_round`
  - `eventContent`: 事件内容
  - `effectiveRounds`: 有效回合数（多回合事件）

#### `POST /api/game/:sessionId/round/:round/temporary-rule` - 添加临时规则
- **功能**: 添加临时规则
- **需要认证**: 是
- **权限**: 主持人
- **请求体**: 
  - `ruleContent`: 规则内容
  - `effectiveRounds`: 有效回合数

#### `GET /api/game/:sessionId/state` - 获取游戏状态
- **功能**: 获取游戏完整状态
- **需要认证**: 是
- **返回**: 游戏状态（包含当前回合、阶段、决策提交状态、活跃事件等）

#### `POST /api/game/:sessionId/round/:round/next` - 进入下一回合
- **功能**: 进入下一回合
- **需要认证**: 是
- **权限**: 主持人
- **特性**: 
  - 仅能在结果阶段执行
  - 如果达到总回合数，游戏结束
  - 创建新的决策阶段
  - 通过 WebSocket 广播回合变化

#### `GET /api/game/history` - 获取游戏历史
- **功能**: 获取用户参与的游戏历史记录
- **需要认证**: 是
- **查询参数**: 
  - `page`: 页码（默认 1）
  - `limit`: 每页数量（默认 10）
  - `status`: 状态筛选（可选）
- **返回**: 历史记录列表和分页信息

#### `GET /api/game/history/:sessionId` - 获取游戏历史详情
- **功能**: 获取指定游戏会话的详细信息
- **需要认证**: 是
- **返回**: 游戏详情（包含回合结果、行动、事件等）

#### `DELETE /api/game/history/:sessionId` - 删除游戏历史
- **功能**: 删除游戏历史记录
- **需要认证**: 是

#### `DELETE /api/game/history/batch` - 批量删除游戏历史
- **功能**: 批量删除游戏历史记录
- **需要认证**: 是
- **请求体**: `{ sessionIds: string[] }`

#### `GET /api/game/history/statistics` - 获取游戏统计
- **功能**: 获取用户游戏统计数据
- **需要认证**: 是
- **返回**: 统计数据（总游戏数、已完成数、进行中数、平均回合数、按状态统计、按月统计）

#### `POST /api/game/:sessionId/save` - 保存游戏
- **功能**: 创建游戏存档
- **需要认证**: 是
- **请求体**: 
  - `saveName`: 存档名称（可选）
  - `description`: 描述（可选）
- **返回**: 存档信息

#### `GET /api/game/:sessionId/saves` - 获取存档列表
- **功能**: 获取游戏的所有存档
- **需要认证**: 是
- **返回**: 存档列表（包含手动和自动存档）

#### `POST /api/game/:sessionId/restore/:saveId` - 恢复存档
- **功能**: 恢复指定存档
- **需要认证**: 是
- **特性**: 恢复游戏状态到存档时的状态

#### `DELETE /api/game/:sessionId/saves/:saveId` - 删除存档
- **功能**: 删除指定存档
- **需要认证**: 是

#### `GET /api/game/:sessionId/events/active` - 获取活跃事件
- **功能**: 获取所有活跃的多回合事件
- **需要认证**: 是
- **返回**: 活跃事件列表（包含进度信息）

#### `PUT /api/game/:sessionId/events/:eventId/progress` - 更新事件进度
- **功能**: 更新多回合事件的进度
- **需要认证**: 是
- **权限**: 主持人
- **请求体**: 
  - `progress`: 进度对象
  - `currentRound`: 当前回合（可选）

#### `GET /api/game/:sessionId/tasks` - 获取任务列表
- **功能**: 获取游戏的任务列表
- **需要认证**: 是
- **查询参数**: 
  - `status`: 状态筛选（可选）
  - `taskType`: 任务类型筛选（可选）
- **返回**: 任务列表

#### `GET /api/game/:sessionId/tasks/:taskId` - 获取任务详情
- **功能**: 获取任务详细信息
- **需要认证**: 是
- **返回**: 任务详情（包含用户进度）

#### `POST /api/game/:sessionId/tasks` - 创建任务
- **功能**: 创建新任务
- **需要认证**: 是
- **权限**: 主持人
- **请求体**: 
  - `title`: 任务标题（必填）
  - `description`: 描述（可选）
  - `taskType`: 任务类型
  - `difficulty`: 难度（可选）
  - `requirements`: 需求对象（可选）
  - `rewards`: 奖励对象（可选）
  - `expiresAt`: 过期时间（可选）

#### `PUT /api/game/:sessionId/tasks/:taskId/progress` - 更新任务进度
- **功能**: 更新任务进度
- **需要认证**: 是
- **请求体**: 
  - `progress`: 进度对象（可选）
  - `status`: 状态（可选）

---

### `routes/trade.ts` - 交易路由

**基础路径**: `/api/trade`

**主要接口**:

#### `GET /api/trade` - 获取交易列表
- **功能**: 获取当前用户的交易列表
- **需要认证**: 是
- **返回**: 交易列表

#### `POST /api/trade` - 发起交易请求
- **功能**: 发起交易请求
- **需要认证**: 是
- **请求体**: 
  - `targetUserId`: 目标用户 ID
  - `offeredResources`: 提供的资源（JSON）
  - `requestedResources`: 请求的资源（JSON）
  - `expiresInMinutes`: 过期时间（分钟，默认 5）

#### `POST /api/trade/:tradeId/respond` - 响应交易
- **功能**: 接受或拒绝交易
- **需要认证**: 是
- **请求体**: `{ action: 'accept' | 'reject' }`
- **特性**: 
  - 只有接收者可以响应
  - 接受交易后更新双方资源

#### `POST /api/trade/:tradeId/cancel` - 取消交易
- **功能**: 取消交易
- **需要认证**: 是
- **权限**: 只有发起者可以取消

---

### `routes/tasks.ts` - 任务路由

**基础路径**: `/api/tasks`

**主要接口**:

#### `GET /api/tasks` - 获取任务列表
- **功能**: 获取所有任务（全局任务，非游戏内任务）
- **需要认证**: 是
- **查询参数**: 
  - `status`: 状态筛选
  - `taskType`: 任务类型筛选
- **返回**: 任务列表

**注意**: 游戏内任务使用 `/api/game/:sessionId/tasks` 接口

---

### `routes/strategies.ts` - 策略路由

**基础路径**: `/api/user/strategies`

**主要接口**:

#### `GET /api/user/strategies` - 获取策略列表
- **功能**: 获取用户的策略列表
- **需要认证**: 是
- **查询参数**: 
  - `page`: 页码（默认 1）
  - `limit`: 每页数量（默认 10）
  - `sortBy`: 排序字段（默认 `winRate`）
  - `order`: 排序方向（默认 `desc`）
- **返回**: 策略列表和分页信息

#### `GET /api/user/strategies/:strategyId/analysis` - 获取策略分析
- **功能**: 获取策略的详细分析数据
- **需要认证**: 是
- **返回**: 策略分析（胜率、平均得分、总游戏数、总胜利数等）

#### `POST /api/user/strategies` - 创建策略
- **功能**: 创建新策略
- **需要认证**: 是
- **请求体**: 
  - `strategyName`: 策略名称
  - `description`: 描述（可选）
  - `strategyData`: 策略数据（JSON）
  - `sessionId`: 关联的游戏会话 ID（可选）
  - `effectiveness`: 有效性数据（可选）
  - `winRate`: 胜率（可选）
  - `averageScore`: 平均得分（可选）
  - `totalGames`: 总游戏数（可选）
  - `totalWins`: 总胜利数（可选）

#### `PUT /api/user/strategies/:strategyId` - 更新策略
- **功能**: 更新策略信息
- **需要认证**: 是
- **请求体**: 同创建策略（所有字段可选）

---

### `routes/admin.ts` - 管理员路由

**基础路径**: `/api/admin`

**权限要求**: 管理员权限（通过 `ADMIN_USERNAME` 环境变量配置，默认 `developer`）

**主要接口**:

#### `POST /api/admin/users/:userId/freeze` - 冻结用户
- **功能**: 冻结用户账户
- **需要认证**: 是
- **权限**: 管理员
- **特性**: 更新用户状态为 `frozen`

#### `POST /api/admin/users/:userId/unfreeze` - 解冻用户
- **功能**: 解冻用户账户
- **需要认证**: 是
- **权限**: 管理员
- **特性**: 更新用户状态为 `active`

#### `DELETE /api/admin/users/:userId` - 删除用户
- **功能**: 删除用户账户
- **需要认证**: 是
- **权限**: 管理员
- **特性**: 软删除或硬删除（根据实现）

#### `POST /api/admin/rooms/:roomId/close` - 关闭房间
- **功能**: 管理员强制关闭房间
- **需要认证**: 是
- **权限**: 管理员

#### `GET /api/admin/rooms` - 获取房间列表（管理员）
- **功能**: 获取所有房间列表（包括已关闭的）
- **需要认证**: 是
- **权限**: 管理员
- **查询参数**: 
  - `page`: 页码
  - `limit`: 每页数量
  - `status`: 状态筛选

---

### `routes/test.ts` - 测试路由

**基础路径**: `/api/test`

**主要接口**:

#### `GET /api/test/db` - 测试数据库连接
- **功能**: 测试数据库连接是否正常
- **返回**: 连接状态和数据库信息

#### `GET /api/test/ai` - 测试 AI API
- **功能**: 测试 AI API 配置是否正常
- **需要认证**: 是
- **查询参数**: 
  - `roomId`: 房间 ID（用于获取配置）
- **返回**: AI API 测试结果

---

## 🔧 服务层

### `services/aiService.ts` - AI 推演服务

**功能**:
- 构建 AI Prompt
- 调用 AI API
- 解析 AI 响应
- 生成决策选项

**核心类**: `AIService` (单例模式)

**主要方法**:

#### `buildPrompt(request, gameRules)` - 构建推演 Prompt
- **功能**: 根据游戏状态、决策、事件等构建完整的 Prompt
- **包含内容**:
  - 游戏规则
  - 当前游戏状态
  - 玩家决策列表
  - 活跃事件和规则
  - 推演要求

#### `buildRequestBody(config, prompt)` - 构建请求体
- **功能**: 根据配置构建 AI API 请求体
- **特性**: 
  - 支持自定义 Body 模板
  - 支持 `{{prompt}}` 占位符替换
  - 默认使用 OpenAI 风格格式
  - 自动添加 `stream: true`（如果配置了 DeepSeek）

#### `callAI(config, prompt, retries)` - 调用 AI API
- **功能**: 实际调用 AI API
- **特性**: 
  - 支持重试机制（默认 3 次）
  - 超时设置（默认 60 秒）
  - 错误处理和详细日志
  - 支持流式和非流式响应

#### `parseResponse(data, provider)` - 解析响应
- **功能**: 解析不同提供商的响应格式
- **支持提供商**: OpenAI、DeepSeek、默认格式
- **返回**: 标准化的推演结果格式

#### `performInference(config, request)` - 执行完整推演
- **功能**: 执行完整的推演流程
- **步骤**:
  1. 构建 Prompt
  2. 调用 AI API
  3. 解析响应
  4. 返回结果

#### `generateDecisionOptions(config, gameRules, gameState, playerInfo, otherPlayersInfo, activeEvents)` - 生成决策选项
- **功能**: 为玩家生成 AI 推荐的决策选项
- **特性**: 
  - 构建专门的选项生成 Prompt
  - 调用 AI API 生成 3-4 个选项
  - 解析 JSON 格式响应
  - 返回选项数组（包含文本、预期效果、类别）

**配置结构** (`AIConfig`):
- `provider`: 提供商名称（如 `deepseek`, `openai`）
- `endpoint`: API 端点 URL
- `headers`: 请求头（包含 Authorization）
- `bodyTemplate`: 请求体模板

**默认配置**:
- 重试次数：3
- 超时时间：60 秒
- 默认模型：`gpt-3.5-turbo`
- 默认温度：0.7
- 默认最大 Token：2000

---

### `services/roomStateService.ts` - 房间状态服务

**功能**:
- 管理房间的实时状态（使用 Redis）
- 玩家加入/离开房间
- 获取房间状态

**主要方法**:

#### `addPlayerToRoom(roomId, userId)` - 添加玩家到房间
- **功能**: 在 Redis 中记录玩家加入房间
- **存储**: Redis Set，键名：`room:${roomId}:players`

#### `removePlayerFromRoom(roomId, userId)` - 从房间移除玩家
- **功能**: 从 Redis 中移除玩家记录

#### `getRoomState(roomId)` - 获取房间状态
- **功能**: 获取房间的实时状态
- **返回**: 房间状态对象（包含玩家列表、房间信息等）

**技术实现**:
- 使用 Redis 存储房间状态
- 使用 Set 数据结构存储玩家列表
- 支持快速查询和更新

---

## 🛡️ 中间件

### `middleware/auth.ts` - 认证中间件

**功能**:
- 验证 JWT Token
- 提取用户信息
- 扩展 Request 对象

**核心函数**: `authenticateToken`

**工作流程**:
1. 从 `Authorization` Header 提取 Token
2. 验证 Token 是否存在
3. 使用 JWT Secret 验证 Token
4. 提取 `userId` 和 `username`
5. 添加到 `AuthRequest` 对象
6. 调用 `next()`

**扩展的 Request 接口**:
```typescript
interface AuthRequest extends Request {
  userId?: string;
  username?: string;
}
```

**错误处理**:
- 无 Token：401 错误
- Token 无效或过期：401 错误
- JWT Secret 未配置：500 错误

---

### `middleware/errorHandler.ts` - 错误处理中间件

**功能**:
- 统一处理应用错误
- 格式化错误响应
- 记录错误日志

**核心类**: `AppError`

**错误响应格式**:
```json
{
  "code": 400,
  "message": "错误消息",
  "error": "详细错误信息（开发环境）"
}
```

**特性**:
- 开发环境显示详细错误堆栈
- 生产环境隐藏敏感信息
- 自动记录错误日志

---

### `middleware/rateLimiter.ts` - 限流中间件

**功能**:
- 限制 API 请求频率
- 防止 API 滥用
- 保护服务器资源

**配置**:
- **开发环境**: 1000 请求/15 分钟
- **生产环境**: 100 请求/15 分钟
- **健康检查**: 不受限流

**技术实现**:
- 使用 `express-rate-limit` 中间件
- 基于 IP 地址限流
- 自定义错误消息

---

## 🔌 WebSocket 处理

### `socket/index.ts` - Socket.io 初始化

**功能**:
- 初始化 Socket.io 服务器
- 注册全局认证中间件
- 注册各种事件处理器
- 处理连接和断开

**核心函数**: `initSocketServer(io)`

**工作流程**:
1. 注册全局认证中间件（`socketAuthMiddleware`）
2. 监听 `connection` 事件
3. 注册房间处理器（`registerRoomHandlers`）
4. 注册游戏处理器（`registerGameHandler`）
5. 注册消息处理器（`registerMessageHandler`）
6. 处理重连逻辑（`rejoin_rooms`）
7. 处理断开连接（清理 Redis 状态）

**认证**:
- 使用 `socketAuthMiddleware` 验证连接
- 从 `auth.token` 提取 JWT Token
- 验证 Token 并设置 `socket.userId`

---

### `socket/authSocket.ts` - Socket 认证

**功能**:
- WebSocket 连接认证
- JWT Token 验证
- 扩展 Socket 对象

**核心接口**: `AuthedSocket`
```typescript
interface AuthedSocket extends Socket {
  userId?: string;
  username?: string;
}
```

**中间件**: `socketAuthMiddleware`
- 从 `auth.token` 提取 Token
- 验证 Token
- 设置 `socket.userId` 和 `socket.username`
- 认证失败时断开连接

---

### `socket/roomHandlers.ts` - 房间事件处理

**功能**:
- 处理房间相关 WebSocket 事件
- 管理玩家加入/离开
- 处理玩家准备状态
- 处理游戏开始

**主要事件**:

#### `join_room` - 加入房间
- **功能**: 玩家加入房间
- **参数**: `{ roomId: string }`
- **特性**: 
  - 加入 Socket.io 房间
  - 更新 Redis 房间状态
  - 广播 `player_joined` 事件

#### `leave_room` - 离开房间
- **功能**: 玩家离开房间
- **参数**: `{ roomId: string }`
- **特性**: 
  - 离开 Socket.io 房间
  - 更新 Redis 房间状态
  - 广播 `player_left` 事件

#### `player_ready` - 玩家准备
- **功能**: 标记玩家准备状态
- **参数**: `{ roomId: string, ready: boolean }`
- **特性**: 广播 `player_ready` 事件

#### `host_start_game` - 主持人开始游戏
- **功能**: 主持人开始游戏
- **参数**: `{ roomId: string }`
- **权限**: 必须是房主
- **特性**: 广播 `game_started` 事件

#### `sync_state` - 同步状态
- **功能**: 请求房间状态同步
- **参数**: `{ roomId: string }`
- **返回**: 当前房间状态

---

### `socket/gameHandler.ts` - 游戏事件处理

**功能**:
- 处理游戏相关 WebSocket 事件
- 管理游戏阶段变化
- 处理决策状态更新
- 处理推演进度

**主要事件**:

#### `round_stage_changed` - 回合阶段变化
- **功能**: 通知回合阶段变化
- **广播**: 房间内所有玩家

#### `decision_status_update` - 决策状态更新
- **功能**: 通知决策提交状态变化
- **广播**: 房间内所有玩家

#### `inference_started` - 推演开始
- **功能**: 通知 AI 推演开始
- **广播**: 房间内所有玩家

#### `inference_completed` - 推演完成
- **功能**: 通知 AI 推演完成
- **广播**: 房间内所有玩家

#### `sync_session_state` - 同步会话状态
- **功能**: 请求游戏会话状态同步
- **参数**: `{ sessionId: string }`
- **返回**: 当前会话状态

---

### `socket/messageHandler.ts` - 消息处理

**功能**:
- 处理聊天消息
- 广播系统消息

**主要事件**:

#### `chat_message` - 聊天消息
- **功能**: 发送聊天消息
- **参数**: `{ roomId: string, message: string }`
- **广播**: 房间内所有玩家（`chat_message` 事件）

#### `broadcast_message` - 广播消息
- **功能**: 广播系统消息
- **参数**: `{ roomId: string, message: string }`
- **广播**: 房间内所有玩家（`system_message` 事件）

---

## 🛠️ 工具模块

### `utils/udpBroadcast.ts` - UDP 广播服务

**功能**:
- 向局域网广播服务器信息
- 响应客户端的服务器发现请求
- 支持自动发现游戏服务器

**核心类**: `UdpBroadcastService`

**配置**:
- **广播端口**: 41234
- **广播间隔**: 5 秒

**主要方法**:
- `start()`: 启动 UDP 广播服务
- `stop()`: 停止 UDP 广播服务

**广播内容**:
```json
{
  "type": "GAME_SERVER",
  "name": "AI Game Server",
  "port": 3000,
  "timestamp": 1703424000000,
  "version": "1.0.0"
}
```

**工作流程**:
1. 绑定 UDP 端口 41234
2. 每 5 秒向 `255.255.255.255` 广播服务器信息
3. 监听客户端的 `DISCOVER_SERVER` 请求并回复

---

### `utils/db.ts` - 数据库工具

**功能**:
- 初始化 Prisma Client
- 配置数据库日志
- 优雅关闭连接

**核心导出**: `prisma` (PrismaClient 实例)

**配置**:
- **开发环境**: 记录所有查询日志
- **生产环境**: 仅记录错误和警告
- **查询日志**: 包含 SQL 语句、参数、执行时间

**优雅关闭**:
- 监听 `beforeExit` 事件
- 自动断开 Prisma 连接
- 记录断开日志

---

### `utils/logger.ts` - 日志工具

**功能**:
- 配置 Winston 日志记录器
- 文件日志和控制台日志
- 日志格式化和级别管理

**日志级别**:
- 从环境变量 `LOG_LEVEL` 读取，默认 `info`
- 支持：`error`, `warn`, `info`, `debug`

**日志输出**:
- **文件日志**:
  - `logs/error.log`: 仅错误级别
  - `logs/combined.log`: 所有级别
  - 文件大小限制：5MB
  - 保留文件数：5
- **控制台日志**:
  - 开发环境：始终输出
  - 生产环境：通过 `LOG_CONSOLE=true` 控制

**日志格式**:
- **文件格式**: JSON 格式（包含时间戳、级别、消息、堆栈）
- **控制台格式**: 彩色格式化（包含时间戳、级别、消息、元数据）

---

### `utils/redis.ts` - Redis 工具

**功能**:
- 初始化 Redis 客户端
- 配置 Redis 连接

**核心导出**: `redis` (Redis 客户端实例)

**配置**:
- **URL**: 从环境变量 `REDIS_URL` 读取，默认 `redis://localhost:6379`
- **用途**: 
  - 房间状态管理
  - 会话缓存
  - 实时数据存储

**连接管理**:
- 自动连接
- 错误处理和重连
- 支持 Redis Cluster 和单实例

---

## 📊 数据流和架构

### 请求处理流程

```
客户端请求
  ↓
Express 中间件（CORS、Helmet、压缩、JSON 解析）
  ↓
限流中间件（rateLimiter）
  ↓
认证中间件（authenticateToken）
  ↓
路由处理器（routes/*）
  ↓
服务层（services/*）
  ↓
数据库操作（Prisma）
  ↓
响应返回
```

### WebSocket 处理流程

```
客户端连接
  ↓
Socket 认证中间件（socketAuthMiddleware）
  ↓
连接成功，注册事件处理器
  ↓
监听各种事件（join_room, decision_status_update 等）
  ↓
更新数据库和 Redis
  ↓
广播事件到房间/会话
  ↓
客户端接收更新
```

### AI 推演流程

```
主持人提交推演
  ↓
构建 Prompt（包含游戏规则、决策、事件等）
  ↓
调用 AI Service
  ↓
构建请求体（根据配置）
  ↓
调用 AI API（支持重试）
  ↓
解析响应（根据提供商格式）
  ↓
保存推演结果到数据库
  ↓
更新游戏阶段
  ↓
通过 WebSocket 广播结果
```

---

## 🔐 安全特性

1. **JWT 认证**: 所有 API 和 WebSocket 连接都需要认证
2. **密码加密**: 使用 bcrypt（10 轮）加密密码
3. **CORS 保护**: 限制允许的来源
4. **Helmet 安全头**: 设置安全 HTTP 头
5. **限流保护**: 防止 API 滥用
6. **输入验证**: 使用 zod 验证所有输入
7. **权限控制**: 房间和游戏操作需要相应权限
8. **文件上传限制**: 限制文件类型和大小

---

## 📝 环境变量

**必需的环境变量**:
- `DATABASE_URL`: PostgreSQL 数据库连接 URL
- `REDIS_URL`: Redis 连接 URL（可选，默认 `redis://localhost:6379`）
- `JWT_SECRET`: JWT Token 密钥
- `PORT`: 服务器端口（可选，默认 3000）

**可选的环境变量**:
- `NODE_ENV`: 环境模式（`development` 或 `production`）
- `FRONTEND_URL`: 前端 URL（用于 CORS）
- `ADMIN_USERNAME`: 管理员用户名（默认 `developer`）
- `ADMIN_DEFAULT_PASSWORD`: 管理员默认密码（默认 `000000`）
- `LOG_LEVEL`: 日志级别（默认 `info`）
- `LOG_CONSOLE`: 是否输出控制台日志（生产环境，默认 `false`）

---

**文档生成时间**: 2024-12-23  
**项目版本**: 1.0.0

