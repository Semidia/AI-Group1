# .env 文件处理说明

## 问题

`.env` 文件包含敏感信息（数据库密码、JWT 密钥等），不应提交到 Git。但在 Git 推送拉取过程中，`.env` 文件可能会丢失。

## 解决方案

项目已实现自动处理机制，确保 `.env` 文件丢失后能自动恢复：

### 1. `.env.example` 模板文件

- **位置**: `rebuild/production/backend/.env.example`
- **作用**: 作为环境变量配置模板
- **状态**: ✅ 已提交到 Git，团队成员可以获取

### 2. 自动创建脚本

- **脚本**: `rebuild/production/backend/scripts/setup-env.ps1`
- **功能**:
  - 检查 `.env` 文件是否存在
  - 如果不存在，从 `.env.example` 复制并创建 `.env`
  - 自动生成随机的 JWT 密钥（替换模板中的占位符）
  - 如果 `.env` 已存在，跳过创建（不会覆盖）

### 3. 一键启动脚本自动处理

`run-dev.bat` 和 `run-dev.ps1` 已集成自动检查：

- 启动时会自动检查 `.env` 文件是否存在
- 如果不存在，自动运行 `setup-env.ps1` 创建 `.env`
- 无需手动操作

## 使用方法

### 场景 1: 首次克隆项目

```powershell
# 1. 克隆项目
git clone <repository-url>

# 2. 运行一键启动（会自动创建 .env）
.\run-dev.bat
```

### 场景 2: 拉取更新后 .env 丢失

```powershell
# 方法 1: 运行一键启动（推荐）
.\run-dev.bat

# 方法 2: 手动运行设置脚本
cd rebuild/production/backend
pwsh scripts/setup-env.ps1

# 方法 3: 手动复制模板
cd rebuild/production/backend
Copy-Item .env.example .env
# 然后根据需要修改敏感信息
```

### 场景 3: 需要重新生成 JWT 密钥

```powershell
cd rebuild/production/backend
Remove-Item .env
pwsh scripts/setup-env.ps1
```

## 文件说明

| 文件 | 状态 | 说明 |
|------|------|------|
| `.env.example` | ✅ 提交到 Git | 环境变量模板，包含所有配置项 |
| `.env` | ❌ 不提交到 Git | 实际环境变量文件，包含敏感信息 |
| `setup-env.ps1` | ✅ 提交到 Git | 自动创建 .env 的脚本 |

## 配置项说明

`.env.example` 包含以下配置：

- **数据库配置**: `DATABASE_URL`（根据 docker-compose.yml）
- **Redis 配置**: `REDIS_URL`
- **JWT 配置**: `JWT_SECRET`、`JWT_REFRESH_SECRET`（setup-env.ps1 会自动生成随机值）
- **服务器配置**: `PORT`、`NODE_ENV`
- **管理员配置**: `ADMIN_USERNAME`、`ADMIN_EMAIL`、`ADMIN_DEFAULT_PASSWORD`

## 注意事项

1. **不要提交 `.env` 文件**
   - `.env` 已在 `.gitignore` 中
   - 如果意外提交，立即修改所有密钥

2. **生产环境必须修改**
   - JWT 密钥必须使用强随机字符串
   - 数据库密码必须修改
   - 开发者账号密码必须修改

3. **团队协作**
   - 每个开发者维护自己的 `.env` 文件
   - 使用 `.env.example` 作为配置参考
   - 生产环境使用环境变量或密钥管理服务

## 相关文档

- `rebuild/production/backend/环境变量说明.md` - 详细的环境变量说明
- `rebuild/production/backend/环境配置指南.md` - 完整的环境配置指南

