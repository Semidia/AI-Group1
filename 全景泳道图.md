# AI文字交互式游戏 - 全景泳道图

## 完整游戏流程（六阶段）

```mermaid
sequenceDiagram
    participant H as 🎭 主持人
    participant P as 👤 玩家
    participant FE as 💻 前端
    participant BE as ⚙️ 后端
    participant AI as 🤖 AI智能体
    participant DB as 🗄️ 数据库
    participant WS as 📡 WebSocket

    %% ========== 阶段一：房间创建 ==========
    rect rgb(240, 248, 255)
    Note over H,DB: 阶段一：房间创建与配置
    H->>FE: 1.1 创建房间
    FE->>BE: POST /rooms
    BE->>DB: 存储Room
    BE-->>FE: roomId
    H->>FE: 1.2 配置AI(endpoint/key)
    H->>FE: 1.3 配置游戏规则
    FE->>BE: POST /host-config
    BE->>DB: 存储HostConfig
    end

    %% ========== 阶段二：玩家加入 ==========
    rect rgb(255, 250, 240)
    Note over H,DB: 阶段二：玩家加入
    P->>FE: 2.1 浏览房间列表
    FE->>BE: GET /rooms/list
    P->>FE: 2.2 加入房间
    FE->>BE: POST /rooms/{id}/join
    BE->>WS: 广播player_joined
    WS-->>H: 通知新玩家
    end

    %% ========== 阶段三：游戏开始 ==========
    rect rgb(240, 255, 240)
    Note over H,DB: 阶段三：游戏开始
    H->>FE: 3.1 开始游戏
    FE->>BE: POST /rooms/{id}/start
    BE->>DB: 创建GameSession
    BE->>WS: 广播game_started
    WS-->>P: 进入决策阶段
    end

    %% ========== 阶段四：决策提交 ==========
    rect rgb(255, 255, 240)
    Note over H,AI: 阶段四：决策提交（核心循环）
    P->>FE: 4.1 请求决策建议
    FE->>BE: GET /decision-options
    BE->>AI: 生成推荐选项
    AI-->>BE: 3-4个选项
    BE-->>FE: 选项列表
    FE-->>P: 显示AI推荐
    P->>FE: 4.2 提交决策
    FE->>BE: POST /decision
    BE->>DB: 存储PlayerAction
    BE->>WS: 广播decision_submitted
    WS-->>H: 通知决策进度
    end

    %% ========== 阶段五：审核与推演 ==========
    rect rgb(255, 240, 245)
    Note over H,AI: 阶段五：主持人审核与AI推演
    H->>FE: 5.1 查看所有决策
    FE->>BE: GET /decisions
    H->>FE: 5.2 修改/批准决策
    FE->>BE: PUT /decision/{id}
    H->>FE: 5.3 触发推演
    FE->>BE: POST /inference
    BE->>BE: 构建Prompt
    BE->>AI: 调用AI API
    AI-->>BE: TurnResultDTO
    BE->>DB: 缓存结果
    BE->>WS: 广播inference_completed
    WS-->>P: 推演完成
    end

    %% ========== 阶段六：结果展示 ==========
    rect rgb(240, 255, 255)
    Note over H,DB: 阶段六：结果展示与下一回合
    P->>FE: 6.1 查看推演结果
    FE->>BE: GET /inference/{round}
    BE-->>FE: 叙事/事件/排行榜/卦象
    FE-->>P: 播放叙事动画
    FE-->>P: 显示排行榜变化
    H->>FE: 6.2 进入下一回合
    FE->>BE: POST /next-round
    BE->>WS: 广播new_round
    WS-->>P: 返回阶段四
    end
```


---

## 角色职责说明

| 角色 | 职责 | 关键操作 |
|------|------|----------|
| 🎭 主持人 | 游戏组织者 | 创建房间、配置AI、审核决策、触发推演 |
| 👤 玩家 | 游戏参与者 | 加入房间、提交决策、查看结果 |
| 🤖 AI智能体 | 推演引擎 | 生成决策建议、执行推演、输出叙事 |
| ⚙️ 后端 | 业务协调 | 状态管理、Prompt构建、结果解析 |
| 🗄️ 数据库 | 持久存储 | PostgreSQL(业务数据) + Redis(缓存) |
| 📡 WebSocket | 实时通信 | 状态同步、事件广播 |

---

## 数据流向总结

```
主持人配置 ──→ 后端存储 ──→ 游戏开始
                              ↓
玩家决策 ──→ 后端收集 ──→ 主持人审核
                              ↓
              Prompt构建 ──→ AI推演
                              ↓
              结果解析 ←── AI输出(JSON)
                              ↓
              WebSocket广播 ──→ 前端展示
                              ↓
              下一回合 ←── 循环继续
```

---

*生成时间: 2025-12-25*
