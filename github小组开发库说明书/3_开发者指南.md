# 开发者指南 & 启动说明

本指南供开发团队及技术人员参考，包含项目的启动、调试及数值配置方法。

## 🕹️ 游戏模式与调试 (New in V1.1)

### 1. 演示模式 (Demo Mode)
- **原理**: 仅运行前端代码 (`gameLogic.js`), 不请求任何 API。
- **用途**: 用于快速测试前端 UI/UX，无需启动 Python 后端。
- **调试**: 修改 `前端/src/engine/gameLogic.js` 可即时生效。

### 2. 正式模式 (Official Mode)
- **原理**: 前端通过 HTTP 请求与后端交互。
- **连接通道**:
    - **本地 (Local)**: 默认连接 `http://localhost:8000`。
    - **远程 (Remote)**: 在游戏内配置菜单中输入远程 URL (如 `https://api.example.com`) 和 Key。
- **初始化设定**: 支持玩家输入自定义游戏规则和 AI 行为要求，通过 API 传递给后端。
- **决策交互**: 采用多选+自定义输入+手动确认的分步交互流程
- **用途**: 测试完整的全栈流程，以及未来的 LLM 接入。
- **调试**: 
    - 修改 `前端/src/App.jsx` 中的 `InitSettingsModal` 组件可调试初始化设定界面。
    - 修改 `前端/src/components/InputArea/InputArea.jsx` 可调试决策交互界面。
    - 后端可通过日志查看收到的初始化设定和多选决策信息。

## 🚀 启动项目 (V2.0 Client-Server)

### 方式一：一键启动 (推荐)
直接双击根目录下的 **`一键启动游戏.bat`**。它会自动启动 Python 后端和 React 前端。

### 方式二：手动启动
我们需要开启两个终端窗口：

1.  **启动后端**: (为正式模式提供 API)
    ```bash
    cd 后端
    # 首次运行: pip install -r requirements.txt
    python main.py
    ```
    *后端服务将运行在 http://localhost:8000*

2.  **启动前端**:
    ```bash
    cd 前端
    npm run dev
    ```
    *前端页面将运行在 http://localhost:5173* 
    *访问后点击“正式模式” -> “本地部署通道”即可连接。*

## 🛠️ 数值配置 (Game Config)
**⚠️ 注意**: 游戏核心逻辑现已移至后端。

*   **文件路径**: `后端/engine.py`
*   **修改位置**: 找到 `INITIAL_STATE` 变量。
    ```python
    INITIAL_STATE = GameState(
        companyName="Nexus Corp",
        turn=1,
        attributes=GameAttributes(
            cash=1000,       # 修改此处
            morale=50,
            reputation=50,
            innovation=10
        ),
        # ...
    )
    ```
*   **生效方法**: 修改 Python 代码后，**后端服务会自动重启**（热重载），刷新网页即可看到新数值。

## 📖 帮助内容自动同步 (V2.5 新增)

### 功能介绍
帮助内容自动同步功能允许开发者直接修改 markdown 文件，自动更新游戏中的帮助按钮内容，无需手动修改 JavaScript 文件。

### 文件关系
- **源文件**: `github小组开发库说明书/帮助按钮里的内容.md` (markdown 格式)
- **目标文件**: `前端/src/engine/helpContent.js` (JavaScript 格式)
- **同步工具**: `sync-help-content.js` (Node.js 脚本)

### 使用方法

#### 方式一：单次同步
```bash
# 从根目录运行
node sync-help-content.js

# 或使用 npm 脚本
npm run sync-help

# 从前端目录运行
cd 前端
node ../sync-help-content.js
# 或
npm run sync-help
```

#### 方式二：自动监听 (推荐)
```bash
# 从根目录运行
node sync-help-content.js --watch

# 或使用 npm 脚本
npm run sync-help:watch

# 从前端目录运行
cd 前端
node ../sync-help-content.js --watch
# 或
npm run sync-help:watch
```

### 最佳实践
1. **编辑源文件**: 始终直接修改 `github小组开发库说明书/帮助按钮里的内容.md`
2. **启动监听模式**: 在开发过程中保持 `--watch` 模式运行，修改后自动生效
3. **格式支持**: 支持完整的 markdown 语法，包括标题、列表、强调等
4. **实时预览**: 启动监听模式后，修改 markdown 文件，游戏中的帮助内容会自动更新

## 🐛 常见问题
*   **报错 `vite: command not found`**：请检查是否忘记执行 `cd 前端`。
*   **依赖缺失**：如果启动失败，尝试在 `前端` 目录下运行 `npm install`。
*   **同步失败**：检查 markdown 文件路径是否正确，确保文件存在且有读写权限。

## ☁️ 服务器部署指南 (V2.1)

### 1. 服务器准备
- **服务器配置**: 阿里云香港服务器 (2核2G)，公网IP: （已隐藏）
- **操作系统**: 推荐使用 Ubuntu 20.04 或以上版本
- **端口开放**: 确保 8000 端口对外开放（用于 FastAPI 服务）

### 2. 部署步骤

#### 2.1 安装依赖
```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Python3 和 pip
apt install python3-pip python3-venv -y

# 安装 Node.js 和 npm (可选，用于构建前端)
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs
```

#### 2.2 部署后端
```bash
# 创建项目目录
mkdir -p /opt/nexus-corp
cd /opt/nexus-corp

# 克隆代码或上传项目文件
# git clone <repository-url> .

# 进入后端目录
cd 后端

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 启动服务（生产环境推荐使用 uvicorn 或 gunicorn）
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
```

#### 2.3 部署前端构建产物
```bash
# 在本地构建前端
cd 前端
npm install
npm run build

# 将构建产物上传到服务器
scp -r dist/* root@your-server-ip:/var/www/html/

# 配置 Nginx（可选，用于静态文件服务和反向代理）
# apt install nginx -y
# 配置 /etc/nginx/sites-available/nexus-corp
# systemctl restart nginx
```

### 3. API 配置

#### 3.1 初始化设定 API
- **端点**: `POST /api/init`
- **请求体**: `{"settings": "玩家输入的初始化设定"}`
- **响应**: `{"state": GameState, "options": GameOption[]}`
- **作用**: 接收玩家的初始化设定，生成个性化背景故事，并返回初始游戏状态和选项

#### 3.2 多选决策 API
- **端点**: `POST /api/action`
- **请求体**: 
  ```json
  {
    "label": "选中的选项标签",
    "customText": "自定义输入内容",
    "selectedOptions": ["option_id_1", "option_id_2"],
    "effects": {"cash": 100, "morale": -10, "reputation": 20},
    "resultNarrative": "合并的结果叙事"
  }
  ```
- **响应**: `{"state": GameState, "options": GameOption[]}`
- **作用**: 接收玩家的多选决策和自定义输入，处理决策效果，并返回新的游戏状态和选项

#### 3.3 添加 LLM API 支持
1. 在 `后端/` 目录下创建 `.env` 文件
2. 添加以下配置:
   ```
   # DeepSeek API 配置
   DEEPSEEK_API_KEY=your_deepseek_api_key
   
   # OpenAI API 配置（可选）
   OPENAI_API_KEY=your_openai_api_key
   OPENAI_BASE_URL=https://api.openai.com/v1
   
   # 默认 API 提供商
   DEFAULT_LLM_PROVIDER=deepseek
   ```

#### 3.3 修改 API 调用逻辑
- 在 `后端/engine.py` 中实现真实的 LLM API 调用
- 替换当前的 `MockAI` 类中的方法，调用真实的 API
- 在 `MockAI.set_init_settings` 方法中添加 LLM API 调用逻辑

### 4. 监控与维护
- **查看日志**: `journalctl -u nexus-corp.service`（如果使用 systemd 管理）
- **重启服务**: `systemctl restart nexus-corp.service`
- **更新代码**: 重新克隆或上传代码，然后重启服务

### 5. 注意事项
- **安全**: 生产环境中建议添加 API 密钥验证
- **性能**: 2核2G 服务器适合轻量级 API 中转，不建议部署本地大模型
- **网络**: 香港服务器可直接访问国际 API，无需额外配置
- **备份**: 定期备份代码和配置文件
